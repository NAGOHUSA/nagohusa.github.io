<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SOHO Comet Hunter – Nagoh Creative</title>
  <meta name="description" content="Live NASA LASCO animations, AI-detected comets and Sungrazer-ready exports – built by Nagoh Creative for OurNightSky.Us">
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b30; --muted:#94a3b8; --text:#e6eefc; --accent:#60a5fa;
      --chip:#1e293b; --card:#0d1526; --shadow:0 8px 30px rgba(0,0,0,.35);
      --success:#34d399; --warning:#fbbf24; --danger:#f87171;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),#0b1220f0 80%,#0b122000);backdrop-filter:blur(6px);border-bottom:1px solid #1e293b}
    .wrap{max-width:1240px;margin:auto;padding:14px 16px}
    h1{font-size:1.35rem;font-weight:800;letter-spacing:.3px}
    .sub{font-size:.85rem;color:var(--muted)}
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-top:12px}
    button,.sel,input[type=checkbox]{cursor:pointer}
    button{border:1px solid #243244;background:#0e1a2b;color:var(--text);padding:8px 14px;border-radius:12px;font-weight:700;box-shadow:var(--shadow)}
    button:hover{border-color:#33508a}
    .sel{background:#0e1a2b;border:1px solid #243244;border-radius:12px;padding:6px 10px;color:var(--text);min-width:160px}
    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #1e293b;padding:4px 8px;border-radius:999px;font-size:.8rem;color:var(--muted)}
    .pill input{accent-color:var(--accent)}
    .right{margin-left:auto}
    main{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
    .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .thumb{aspect-ratio:1.6/1;width:100%;background:#0b1220;object-fit:contain;display:block}
    .meta{padding:12px;flex:1;display:flex;flex-direction:column;gap:8px}
    .kvs{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:.8rem;color:var(--muted)}
    .kv b{color:var(--text)}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .stats{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
    .stat{background:var(--panel);border:1px solid #1e293b;border-radius:12px;padding:8px 12px}
    .stat b{font-size:1.1rem}
    .empty{padding:40px;text-align:center;color:var(--muted);border:1px dashed #253044;border-radius:16px;background:#0b1220}
    .err{color:#ffb4b4}
    .thumbRow{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:12px}
    .thumbCard{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
    .status-bar{background:var(--panel);border:1px solid #1e293b;border-radius:12px;padding:10px 14px;margin-bottom:16px;display:flex;flex-wrap:wrap;gap:16px;align-items:center;font-size:.9rem}
    .status-item{display:flex;align-items:center;gap:6px}
    .status-dot{width:10px;height:10px;border-radius:50%;background:var(--success);animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .status-time{color:var(--muted);font-size:.8rem}
    .status-offline .status-dot{background:var(--danger)}
    .status-warning .status-dot{background:var(--warning)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <h1>SOHO Comet Hunter</h1>
        <div class="sub right">by Nagoh Creative • OurNightSky.Us</div>
      </div>

      <!-- LIVE STATUS BAR -->
      <div class="status-bar" id="statusBar">
        <div class="status-item">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Loading status...</span>
        </div>
        <div class="status-item">
          <strong>C2:</strong> <span id="c2Frames">—</span> frames, <span id="c2Tracks">—</span> tracks
        </div>
        <div class="status-item">
          <strong>C3:</strong> <span id="c3Frames">—</span> frames, <span id="c3Tracks">—</span> tracks
        </div>
        <div class="status-time right" id="statusTime"></div>
      </div>

      <div class="controls">
        <select class="sel" id="latestSelect"><option>Loading reports...</option></select>
        <select class="sel" id="hitsSelect"><option>Potential Hits</option></select>
        <button id="refreshBtn">Refresh</button>
        <span class="pill"><input type="checkbox" id="showOnlyComets"><label for="showOnlyComets">AI: Comet</label></span>
        <span class="pill"><input type="checkbox" id="showOnlyTracks"><label for="showOnlyTracks">Has Track</label></span>
        <span class="pill"><input type="checkbox" id="exportMarkedOnly"><label for="exportMarkedOnly">Export Marked Only</label></span>
        <button id="exportAllBtn">Export ALL</button>
        <a id="downloadAllTxt" hidden download>Download TXT</a>
        <a id="downloadAllCsv" hidden download>Download CSV</a>
        <div class="right">Next refresh: <span id="refreshEta">—</span></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="row">
      <h2 id="viewName">—</h2>
      <div id="reportTime" class="sub"></div>
    </div>

    <div id="grid" class="grid" hidden></div>
    <div id="empty" class="empty" hidden></div>

    <div class="thumbRow" id="thumbRow" hidden></div>
  </main>

  <script>
    const REPO = 'NAGOHUSA/ONS_SOHOHUNTER';
    const BRANCH = 'main';
    const BASE = `https://api.github.com/repos/${REPO}/contents`;
    const RAW = `https://raw.githubusercontent.com/${REPO}/${BRANCH}`;
    const REFRESH_SECS = 3600;
    let refreshTimer, countdown = REFRESH_SECS;
    let currentReport = null;

    const el = {
      latestSelect: $('latestSelect'),
      hitsSelect: $('hitsSelect'),
      refreshBtn: $('refreshBtn'),
      viewName: $('viewName'),
      reportTime: $('reportTime'),
      grid: $('grid'),
      empty: $('empty'),
      thumbRow: $('thumbRow'),
      exportAllBtn: $('exportAllBtn'),
      downloadAllTxt: $('downloadAllTxt'),
      downloadAllCsv: $('downloadAllCsv'),
      exportMarkedOnly: $('exportMarkedOnly'),
      showOnlyComets: $('showOnlyComets'),
      showOnlyTracks: $('showOnlyTracks'),
      refreshEta: $('refreshEta'),
      statusBar: $('statusBar'),
      statusDot: $('statusDot'),
      statusText: $('statusText'),
      statusTime: $('statusTime'),
      c2Frames: $('c2Frames'),
      c2Tracks: $('c2Tracks'),
      c3Frames: $('c3Frames'),
      c3Tracks: $('c3Tracks')
    };

    function $(id) { return document.getElementById(id); }
    function $$(sel) { return document.querySelectorAll(sel); }

    // Fetch JSON with error handling
    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    // GitHub API helpers
    function apiURL(path) { return `${BASE}/${path}?ref=${BRANCH}`; }
    function rawURL(path) { return `${RAW}/${path}`; }

    // Load and update status
    async function updateStatus() {
      try {
        const status = await fetchJSON(rawURL('detections/latest_status.json'));
        const ts = new Date(status.timestamp_utc);
        const now = new Date();
        const ageMin = Math.floor((now - ts) / 60000);

        el.statusTime.textContent = `${ts.toLocaleString()} UTC (${ageMin}m ago)`;
        el.c2Frames.textContent = status.detectors.C2.frames;
        el.c2Tracks.textContent = status.detectors.C2.tracks;
        el.c3Frames.textContent = status.detectors.C3.frames;
        el.c3Tracks.textContent = status.detectors.C3.tracks;

        // Status dot color
        if (ageMin > 120) {
          el.statusBar.classList.add('status-offline');
          el.statusText.textContent = 'Offline (no update in 2h)';
        } else if (ageMin > 60) {
          el.statusBar.classList.add('status-warning');
          el.statusText.textContent = 'Delayed';
        } else {
          el.statusBar.classList.remove('status-offline', 'status-warning');
          el.statusText.textContent = 'Live';
        }
      } catch (e) {
        el.statusText.textContent = 'Status unavailable';
        el.statusBar.classList.add('status-offline');
        console.warn('Status fetch failed:', e);
      }
    }

    // Load report list
    async function loadReportList() {
      try {
        const res = await fetch(apiURL('detections'));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const files = (await res.json()).filter(f => f.name.endsWith('.json') && f.name.includes('candidates_'));

        const latestFiles = files.filter(f => !f.name.includes('_hits'));
        const hitFiles = files.filter(f => f.name.includes('_hits'));

        // Sort by name (timestamp)
        latestFiles.sort((a,b) => b.name.localeCompare(a.name));
        hitFiles.sort((a,b) => b.name.localeCompare(a.name));

        // Populate selects
        el.latestSelect.innerHTML = '<option value="">Latest Reports</option>';
        latestFiles.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f.name;
          opt.textContent = f.name.replace('candidates_', '').replace('.json', '');
          el.latestSelect.appendChild(opt);
        });

        el.hitsSelect.innerHTML = '<option value="">Potential Hits</option>';
        hitFiles.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f.name;
          opt.textContent = f.name.replace('_hits.json', '');
          el.hitsSelect.appendChild(opt);
        });

        if (latestFiles.length > 0) {
          el.latestSelect.value = latestFiles[0].name;
          await loadReport(latestFiles[0].name, false);
        } else {
          el.viewName.textContent = '—';
          el.reportTime.textContent = '';
          el.grid.hidden = true; el.empty.hidden = false;
          el.empty.textContent = 'No candidate files yet.';
        }
        await loadThumbs();
      } catch (e) {
        showError(`GitHub load failed: ${e.message}`);
        el.empty.textContent = "Unable to fetch report list.";
      } finally {
        updateStatus();
        refreshLiveGifs();
      }
    }

    async function loadReport(name, isHitFile) {
      try {
        const data = await fetchJSON(rawURL(name));
        currentReport = {name, items: Array.isArray(data) ? data : [], isHitFile: !!isHitFile};

        el.viewName.textContent = isHitFile ? `Potential Hits – ${name}` : name;
        const t = parseReportTime(name);
        el.reportTime.textContent = t ? `• ${t.local} (local)` : '';

        renderGrid(currentReport.items);
      } catch (e) {
        showError(`Failed to load ${name}: ${e.message}`);
      }
    }

    function parseReportTime(name) {
      const m = name.match(/(\d{8}_\d{6})/);
      if (!m) return null;
      const dt = new Date(m[1].replace('_', 'T').replace(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})/, '$1-$2-$3T$4:$5:$6Z'));
      return { utc: dt.toISOString(), local: dt.toLocaleString() };
    }

    function renderGrid(items) {
      const filtered = applyFilters(items);
      el.grid.innerHTML = '';
      if (!filtered.length) {
        el.grid.hidden = true; el.empty.hidden = false;
        el.empty.textContent = 'No candidates match current filters.';
        return;
      }
      el.grid.hidden = false; el.empty.hidden = true;

      filtered.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${rawURL(item.crop_path)}" class="thumb" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22/%3E'">
          <div class="meta">
            <div class="kvs">
              <div class="kv"><b>Time</b> ${item.timestamp.split('T')[1].split('.')[0]} UTC</div>
              <div class="kv"><b>Inst</b> ${item.instrument}</div>
              <div class="kv"><b>AI</b> ${item.ai_label || '—'}</div>
              <div class="kv"><b>Score</b> ${(item.ai_score || 0).toFixed(2)}</div>
            </div>
            <div class="row">
              <button onclick="mark('${keyFor(item)}')">Mark</button>
            </div>
          </div>
        `;
        el.grid.appendChild(card);
      });
    }

    function keyFor(item) { return `${item.instrument}_${item.timestamp}_${item.bbox?.join('_')}`; }
    function marks() { return JSON.parse(localStorage.getItem('marks') || '{}'); }
    function mark(key) {
      const m = marks();
      m[key] = !m[key];
      localStorage.setItem('marks', JSON.stringify(m));
    }

    function applyFilters(items) {
      let res = items;
      if (el.showOnlyComets.checked) res = res.filter(i => i.ai_label === 'comet');
      if (el.showOnlyTracks.checked) res = res.filter(i => i.track_id);
      return res;
    }

    async function loadThumbs() {
      // [Your existing thumb loading logic]
    }

    function refreshLiveGifs() {
      // [Your existing GIF refresh]
    }

    function showError(msg) {
      const err = document.createElement('div');
      err.className = 'err';
      err.textContent = msg;
      el.grid.prepend(err);
      setTimeout(() => err.remove(), 5000);
    }

    function fmtSec(s) { return `${s}s`; }

    function exportAll() {
      if (!currentReport) return alert('No report loaded.');
      let items = applyFilters(currentReport.items);
      if (el.exportMarkedOnly.checked) items = items.filter(h => marks()[keyFor(h)]);
      if (!items.length) return alert('No candidates to export.');

      const txt = items.map(i => `${i.instrument} ${i.timestamp} ${i.bbox}`).join('\n');
      navigator.clipboard.writeText(txt).catch(() => {});
      const blob = new Blob([txt], {type: 'text/plain'});
      el.downloadAllTxt.href = URL.createObjectURL(blob);
      el.downloadAllTxt.download = `${currentReport.name.replace('.json','')}_export.txt`;
      el.downloadAllTxt.style.display = 'inline-flex';
      el.exportAllBtn.textContent = 'Copied!';
      setTimeout(() => el.exportAllBtn.textContent = 'Export ALL', 1200);
    }

    el.latestSelect.onchange = e => { if (e.target.value) loadReport(e.target.value, false); };
    el.hitsSelect.onchange = e => { if (e.target.value) loadReport(e.target.value, true); };
    el.exportAllBtn.onclick = exportAll;
    el.refreshBtn.onclick = () => { countdown = REFRESH_SECS; loadReportList(); };
    $$('input[type=checkbox]').forEach(cb => cb.onchange = () => { if (currentReport) renderGrid(currentReport.items); });

    function startAutoRefresh() {
      if (refreshTimer) clearInterval(refreshTimer);
      countdown = REFRESH_SECS; el.refreshEta.textContent = fmtSec(countdown);
      refreshTimer = setInterval(() => {
        countdown--; el.refreshEta.textContent = fmtSec(countdown);
        if (countdown <= 0) { loadReportList(); countdown = REFRESH_SECS; }
      }, 1000);
    }

    // Update status every 30s
    setInterval(updateStatus, 30000);

    // Boot
    loadReportList().then(() => {
      updateStatus();
      startAutoRefresh();
    });
  </script>
</body>
</html>
