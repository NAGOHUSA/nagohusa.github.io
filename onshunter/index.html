<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SOHO Comet Hunter – Comet Detection Dashboard</title>
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <style>
    :root{
      --bg-primary:#0a0e27;--bg-secondary:#111633;--bg-card:#1a1f3a;--border:#2a3354;
      --text-primary:#e8edf4;--text-secondary:#8b95b0;--accent:#3b82f6;--accent-hover:#2563eb;
      --success:#10b981;--warning:#f59e0b;--danger:#ef4444;
      --shadow:0 4px 6px -1px rgb(0 0 0 / .3),0 2px 4px -2px rgb(0 0 0 / .3);
      --shadow-lg:0 20px 25px -5px rgb(0 0 0 / .4),0 8px 10px -6px rgb(0 0 0 / .4);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:var(--bg-primary);color:var(--text-primary);line-height:1.6;min-height:100vh}
    .header{background:linear-gradient(135deg,#1e3a8a 0%,#3730a3 100%);padding:2rem 0;box-shadow:var(--shadow-lg);border-bottom:2px solid var(--border)}
    .container{max-width:1400px;margin:0 auto;padding:0 1.5rem}
    .header-content{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
    .header-title h1{font-size:2rem;font-weight:800;margin-bottom:.25rem;background:linear-gradient(135deg,#fff 0%,#bfdbfe 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header-subtitle{color:#bfdbfe;font-size:.9rem}
    .header-actions{display:flex;gap:.75rem;align-items:center}
    .controls-bar{background:var(--bg-secondary);padding:1.5rem 0;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;backdrop-filter:blur(10px)}
    .controls-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem}
    .control-group{display:flex;flex-direction:column;gap:.5rem}
    .control-label{font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary)}
    .select-wrapper{position:relative}
    select{width:100%;padding:.75rem 2.5rem .75rem 1rem;background:var(--bg-card);border:1px solid var(--border);border-radius:.5rem;color:var(--text-primary);font-size:.9rem;cursor:pointer;appearance:none;transition:all .2s}
    select:hover{border-color:var(--accent)}select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .select-wrapper::after{content:'down arrow';position:absolute;right:1rem;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--text-secondary);font-size:.7rem}
    .filters{display:flex;gap:1rem;flex-wrap:wrap;align-items:center;padding-top:1rem;border-top:1px solid var(--border)}
    .filter-chip{display:flex;align-items:center;gap:.5rem;padding:.5rem 1rem;background:var(--bg-card);border:1px solid var(--border);border-radius:2rem;cursor:pointer;transition:all .2s;font-size:.85rem}
    .filter-chip:hover{border-color:var(--accent);background:rgba(59,130,246,.1)}
    .filter-chip input[type="checkbox"]{cursor:pointer;width:1rem;height:1rem;accent-color:var(--accent)}
    .btn{padding:.75rem 1.5rem;border:none;border-radius:.5rem;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:.5rem;font-size:.9rem;text-decoration:none}
    .btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:var(--accent-hover);transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn-secondary{background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border)}.btn-secondary:hover{border-color:var(--accent);background:rgba(59,130,246,.1)}
    .btn-sm{padding:.5rem 1rem;font-size:.8rem}
    .stats-dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin:1.5rem 0}
    .stat-card{background:var(--bg-card);padding:1.5rem;border-radius:.75rem;border:1px solid var(--border);box-shadow:var(--shadow)}
    .stat-label{font-size:.8rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.5rem}
    .stat-value{font-size:2rem;font-weight:800;color:var(--text-primary)}
    .stat-card.highlight{background:linear-gradient(135deg,rgba(59,130,246,.1) 0%,rgba(37,99,235,.05) 100%);border-color:var(--accent)}
    .live-feed{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:1.5rem;margin:1.5rem 0}
    .feed-card{background:var(--bg-card);border:1px solid var(--border);border-radius:.75rem;overflow:hidden;box-shadow:var(--shadow)}
    .feed-header{padding:1rem 1.5rem;background:rgba(59,130,246,.1);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .feed-title{font-weight:700;font-size:1rem;display:flex;align-items:center;gap:.5rem}
    .badge{padding:.25rem .75rem;border-radius:1rem;font-size:.75rem;font-weight:600;background:var(--accent);color:#fff}
    .feed-content{aspect-ratio:1;background:#000;display:flex;align-items:center;justify-content:center}
    .feed-content img,.feed-content video{width:100%;height:100%;object-fit:contain}
    .feed-footer{padding:.75rem 1.5rem;background:rgba(0,0,0,.2);font-size:.8rem;color:var(--text-secondary);display:flex;justify-content:space-between;align-items:center}
    .candidates-section{margin:2rem 0}.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
    .section-title{font-size:1.5rem;font-weight:700}
    .candidates-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.5rem}
    .candidate-card{background:var(--bg-card);border:1px solid var(--border);border-radius:.75rem;overflow:hidden;box-shadow:var(--shadow);transition:all .3s;cursor:pointer}
    .candidate-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-lg);border-color:var(--accent)}
    .candidate-card.marked{border-color:var(--success);box-shadow:0 0 0 2px rgba(16,185,129,.2)}
    .candidate-image{width:100%;aspect-ratio:1.6;background:#222;display:flex;align-items:center;justify-content:center;color:#999;font-size:1rem}
    .candidate-image img{width:100%;height:100%;object-fit:contain}
    .candidate-body{padding:1.25rem}
    .candidate-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem}
    .candidate-id{font-weight:700;font-size:1.1rem}
    .candidate-score{display:flex;flex-direction:column;align-items:flex-end;gap:.25rem}
    .score-badge{padding:.25rem .75rem;border-radius:1rem;font-size:.75rem;font-weight:700}
    .score-badge.comet{background:var(--success);color:#fff}
    .score-badge.not_comet{background:var(--danger);color:#fff}
    .score-badge.unknown{background:var(--text-secondary);color:#fff}
    .score-value{font-size:.85rem;color:var(--text-secondary)}
    .candidate-meta{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1rem;font-size:.85rem}
    .meta-item{display:flex;flex-direction:column;gap:.25rem}.meta-label{color:var(--text-secondary);font-size:.75rem;text-transform:uppercase;letter-spacing:.5px}
    .meta-value{color:var(--text-primary);font-weight:600}
    .candidate-actions{display:flex;gap:.5rem;padding-top:1rem;border-top:1px solid var(--border)}
    .action-btn{flex:1;padding:.5rem;border:1px solid var(--border);background:transparent;color:var(--text-primary);border-radius:.375rem;cursor:pointer;font-size:.8rem;font-weight:600;transition:all .2s}
    .action-btn:hover{background:rgba(59,130,246,.1);border-color:var(--accent)}
    .action-btn.marked-btn{background:var(--success);border-color:var(--success);color:#fff}
    .empty-state{text-align:center;padding:4rem 2rem;color:var(--text-secondary)}
    .empty-state-icon{font-size:4rem;margin-bottom:1rem;opacity:.3}
    .empty-state-title{font-size:1.5rem;font-weight:700;margin-bottom:.5rem;color:var(--text-primary)}
    .spinner{border:3px solid rgba(59,130,246,.1);border-top-color:var(--accent);border-radius:50%;width:40px;height:40px;animation:spin .8s linear infinite;margin:2rem auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:1000;padding:2rem;overflow-y:auto}
    .modal.active{display:flex;align-items:center;justify-content:center}
    .modal-content{background:var(--bg-card);border-radius:1rem;max-width:950px;width:100%;max-height:92vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
    .modal-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:1.5rem;font-weight:700}
    .modal-close{background:none;border:none;color:var(--text-secondary);font-size:1.5rem;cursor:pointer;padding:.5rem;line-height:1}
    .modal-body{padding:1.5rem}
    .seg{display:inline-flex;border:1px solid var(--border);border-radius:.5rem;overflow:hidden}
    .seg button{background:transparent;color:var(--text-secondary);border:0;border-right:1px solid var(--border);padding:.4rem .8rem;cursor:pointer}
    .seg button:last-child{border-right:0}
    .seg button.active{color:var(--text-primary);background:rgba(59,130,246,.12)}
    .seg button[disabled]{opacity:.45;pointer-events:none}
    .three-wrap{background:#000;border:1px solid var(--border);border-radius:.5rem;height:360px}
    .three-hint{font-size:.85rem;color:var(--text-secondary);margin-top:.5rem}
    .tl-controls{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;margin-bottom:.5rem}
    .tl-controls input[type="range"]{width:160px}
    .tl-img{width:100%;background:#000;border-radius:.5rem;border:1px solid var(--border);object-fit:contain}
    @media (max-width:768px){
      .header-content{flex-direction:column;align-items:flex-start}
      .controls-grid{grid-template-columns:1fr}
      .candidates-grid{grid-template-columns:1fr}
      .live-feed{grid-template-columns:1fr}
    }
    .status-indicator{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem 1rem;border-radius:2rem;font-size:.85rem;font-weight:600}
    .status-dot{width:8px;height:8px;border-radius:50%;animation:pulse 2s infinite;background:var(--success)}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .status-indicator.online{background:rgba(16,185,129,.1);color:var(--success)}
    .refresh-timer{display:flex;align-items:center;gap:.5rem;color:var(--text-secondary);font-size:.85rem}
    .countdown{font-weight:700;color:var(--accent)}
  </style>
</head>
<body>

<header class="header">
  <div class="container">
    <div class="header-content">
      <div class="header-title">
        <h1>SOHO Comet Hunter 1.1</h1>
        <div class="header-subtitle">Live NASA LASCO • AI Comets • Sungrazer Exports</div>
      </div>
      <div class="header-actions">
        <div class="status-indicator online"><span class="status-dot"></span><span>Live</span></div>
        <button class="btn btn-primary" id="refreshBtn">Refresh</button>
        <a href="https://github.com/NAGOHUSA/ONS_SOHOHUNTER" target="_blank" class="btn btn-secondary">GitHub</a>
      </div>
    </div>
  </div>
</header>

<div class="controls-bar">
  <div class="container">
    <div class="controls-grid">
      <div class="control-group">
        <label class="control-label">Detection Report</label>
        <div class="select-wrapper">
          <select id="reportSelect"><option>Loading reports...</option></select>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label">Candidate</label>
        <div class="select-wrapper">
          <select id="candidateSelect"><option>All candidates</option></select>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label">Actions</label>
        <div style="display:flex;gap:.5rem;">
          <button class="btn btn-secondary btn-sm" id="exportTxtBtn">Export TXT</button>
          <button class="btn btn-secondary btn-sm" id="exportCsvBtn">Export CSV</button>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label">Auto-Refresh</label>
        <div class="refresh-timer">Next update in <span class="countdown" id="countdown">5:00</span></div>
      </div>
    </div>

    <div class="filters">
      <label class="filter-chip"><input type="checkbox" id="filterC2"><span>C2</span></label>
      <label class="filter-chip"><input type="checkbox" id="filterC3"><span>C3</span></label>
      <label class="filter-chip"><input type="checkbox" id="filterComet"><span>AI Comet Only</span></label>
      <label class="filter-chip"><input type="checkbox" id="filterMarked"><span>Marked Only</span></label>
      <label class="filter-chip"><input type="checkbox" id="exportMarkedOnly"><span>Export Marked Only</span></label>
    </div>
  </div>
</div>

<main class="container">
  <div class="stats-dashboard" id="statsDashboard">
    <div class="stat-card"><div class="stat-label">Total</div><div class="stat-value" id="statTotal">0</div></div>
    <div class="stat-card highlight"><div class="stat-label">AI Comets</div><div class="stat-value" id="statComets">0</div></div>
    <div class="stat-card"><div class="stat-label">C2</div><div class="stat-value" id="statC2">0</div></div>
    <div class="stat-card"><div class="stat-label">C3</div><div class="stat-value" id="statC3">0</div></div>
    <div class="stat-card"><div class="stat-label">Marked</div><div class="stat-value" id="statMarked">0</div></div>
  </div>

  <div class="live-feed">
    <div class="feed-card">
      <div class="feed-header">
        <div class="feed-title">C2 – Live GIF <a href="https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif" target="_blank" class="btn btn-sm btn-secondary">open</a></div>
      </div>
      <div class="feed-content"><img id="c2LiveGif" src="https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif" alt="LASCO C2"></div>
      <div class="feed-footer"><span>Last Updated:</span><span id="c2Timestamp">--:--</span></div>
    </div>
    <div class="feed-card">
      <div class="feed-header">
        <div class="feed-title">C3 – Live GIF <a href="https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif" target="_blank" class="btn btn-sm btn-secondary">open</a></div>
      </div>
      <div class="feed-content"><img id="c3LiveGif" src="https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif" alt="LASCO C3"></div>
      <div class="feed-footer"><span>Last Updated:</span><span id="c3Timestamp">--:--</span></div>
    </div>
  </div>

  <div class="candidates-section">
    <div class="section-header">
      <h2 class="section-title">Detection Candidates</h2>
      <div id="filterCount" class="stat-label"></div>
    </div>
    <div id="candidatesGrid" class="candidates-grid"></div>
    <div id="emptyState" class="empty-state" style="display:none;">
      <div class="empty-state-icon">magnifying glass</div>
      <div class="empty-state-title">No Candidates Found</div>
      <p>Try adjusting filters or select a report</p>
    </div>
    <div id="loadingState" style="display:none;"><div class="spinner"></div></div>
  </div>
</main>

<div class="modal" id="candidateModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Candidate</h3>
      <button class="modal-close" onclick="closeModal()">×</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
  // CONFIG
  const CONFIG = { repo:'NAGOHUSA/ONS_SOHOHUNTER', branch:'main', folder:'detections' };
  const API_URL = `https://api.github.com/repos/${CONFIG.repo}/contents/${CONFIG.folder}?ref=${CONFIG.branch}`;
  const RAW_URL = (p) => {
    if (!p) return '';
    let path = String(p).trim().replace(/^\.?\/*/, '');
    if (!path.startsWith('detections/') && !['crops/','originals/','annotated/'].some(prefix=>path.startsWith(prefix))) {
      path = 'detections/' + path;
    }
    return `https://raw.githubusercontent.com/${CONFIG.repo}/${CONFIG.branch}/${path}`;
  };

  // STATE
  let allCandidates = [], filteredCandidates = [], markedIds = new Set(), currentReport = null;
  const els = {
    reportSelect: document.getElementById('reportSelect'),
    candidateSelect: document.getElementById('candidateSelect'),
    refreshBtn: document.getElementById('refreshBtn'),
    exportTxtBtn: document.getElementById('exportTxtBtn'),
    exportCsvBtn: document.getElementById('exportCsvBtn'),
    filterC2: document.getElementById('filterC2'),
    filterC3: document.getElementById('filterC3'),
    filterComet: document.getElementById('filterComet'),
    filterMarked: document.getElementById('filterMarked'),
    exportMarkedOnly: document.getElementById('exportMarkedOnly'),
    candidatesGrid: document.getElementById('candidatesGrid'),
    emptyState: document.getElementById('emptyState'),
    loadingState: document.getElementById('loadingState'),
    countdown: document.getElementById('countdown'),
    statTotal: document.getElementById('statTotal'),
    statComets: document.getElementById('statComets'),
    statC2: document.getElementById('statC2'),
    statC3: document.getElementById('statC3'),
    statMarked: document.getElementById('statMarked'),
    filterCount: document.getElementById('filterCount'),
    c2LiveGif: document.getElementById('c2LiveGif'),
    c3LiveGif: document.getElementById('c3LiveGif'),
    c2Timestamp: document.getElementById('c2Timestamp'),
    c3Timestamp: document.getElementById('c3Timestamp')
  };

  // HELPERS
  const formatDate = (s) => s ? new Date(s).toLocaleString() : 'N/A';
  const getTelescope = (c) => (c.instrument || '').includes('C2') ? 'C2' : (c.instrument || '').includes('C3') ? 'C3' : 'LASCO';

  function normalizeCandidate(c, idx) {
    const tel = getTelescope(c);
    const id = `${tel}#${c.track_id ?? idx}`;
    const src = { ...c, ...c.paths };
    return {
      id, telescope: tel,
      label: String(c.ai_label || 'unknown').toLowerCase(),
      score: Number(c.ai_score || 0),
      timestamp: c.timestamp || '',
      bbox: c.bbox || [],
      cropPath: src.crop_path || '',
      originalPath: src.original_path || '',
      annotatedPath: src.annotated_path || '',
      thumbnail: src.thumbnail_path || src.crop_path || '',
      trackIndex: c.track_id ?? idx,
      raw: c
    };
  }

  function getTrackGroup(c) {
    return allCandidates
      .filter(x => x.trackIndex === c.trackIndex && x.telescope === c.telescope)
      .sort((a,b) => (a.timestamp||'').localeCompare(b.timestamp||''));
  }

  // LOAD
  async function loadReports() {
    try {
      const r = await fetch(API_URL);
      const files = await r.json();
      const reports = files.filter(f => f.name.startsWith('candidates_') && f.name.endsWith('.json'))
                           .sort((a,b) => b.name.localeCompare(a.name));
      els.reportSelect.innerHTML = '<option value="">Select report...</option>';
      reports.forEach(r => {
        const o = document.createElement('option');
        o.value = r.name; o.textContent = r.name.replace('candidates_','').replace('.json','');
        els.reportSelect.appendChild(o);
      });
      if (reports.length) {
        els.reportSelect.value = reports[0].name;
        await loadReport(reports[0].name);
      }
    } catch (e) { console.error(e); }
  }

  async function loadReport(name) {
    if (!name) return;
    els.loadingState.style.display = 'block';
    els.candidatesGrid.innerHTML = ''; els.emptyState.style.display = 'none';
    try {
      const r = await fetch(RAW_URL(`${CONFIG.folder}/${name}`));
      const data = await r.json();
      currentReport = name;
      allCandidates = data.map(normalizeCandidate);
      updateCandidateDropdown();
      applyFilters();
      updateStats();
      updateLiveFeeds();
    } catch (e) {
      console.error(e);
      els.emptyState.style.display = 'block';
    } finally { els.loadingState.style.display = 'none'; }
  }

  function updateCandidateDropdown() {
    els.candidateSelect.innerHTML = '<option value="">All candidates</option>';
    allCandidates.forEach(c => {
      const o = document.createElement('option');
      o.value = c.id; o.textContent = `${c.id} — ${c.label.toUpperCase()} (${(c.score*100).toFixed(1)}%)`;
      els.candidateSelect.appendChild(o);
    });
  }

  // FILTER & RENDER
  function applyFilters() {
    const sel = els.candidateSelect.value;
    filteredCandidates = allCandidates.filter(c => {
      if (sel && c.id !== sel) return false;
      if (els.filterC2.checked && c.telescope !== 'C2') return false;
      if (els.filterC3.checked && c.telescope !== 'C3') return false;
      if (els.filterComet.checked && c.label !== 'comet') return false;
      if (els.filterMarked.checked && !markedIds.has(c.id)) return false;
      return true;
    });
    renderCandidates();
    updateFilterCount();
  }

  function renderCandidates() {
    const visible = filteredCandidates;
    if (!visible.length) {
      els.candidatesGrid.innerHTML = ''; els.emptyState.style.display = 'block'; return;
    }
    els.emptyState.style.display = 'none';
    els.candidatesGrid.innerHTML = visible.map(renderCard).join('');
    document.querySelectorAll('.candidate-card').forEach(card => {
      const id = card.dataset.id;
      card.querySelector('.mark-btn')?.addEventListener('click', e => { e.stopPropagation(); toggleMark(id); });
      card.addEventListener('click', () => showCandidateDetail(id));
    });
  }

  function updateFilterCount() {
    els.filterCount.textContent = `Showing ${filteredCandidates.length} of ${allCandidates.length} candidates`;
  }

  function renderCard(c) {
    const isMarked = markedIds.has(c.id);
    const thumbSrc = c.thumbnail ? RAW_URL(c.thumbnail) : c.cropPath ? RAW_URL(c.cropPath) : '';
    return `
      <div class="candidate-card ${isMarked?'marked':''}" data-id="${c.id}">
        <div class="candidate-image">
          ${thumbSrc ? `<img src="${thumbSrc}" alt="${c.id}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAyNCIgaGVpZ2h0PSI1NzYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMjQiIGhlaWdodD0iNTc2IiBmaWxsPSIjMjIyIj48L3JlY3Q+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iNDgiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4='">` : 'No Image'}
        </div>
        <div class="candidate-body">
          <div class="candidate-header">
            <div class="candidate-id">${c.id}</div>
            <div class="candidate-score">
              <span class="score-badge ${c.label}">${c.label.toUpperCase()}</span>
              <span class="score-value">${(c.score*100).toFixed(1)}%</span>
            </div>
          </div>
          <div class="candidate-meta">
            <div class="meta-item"><span class="meta-label">Telescope</span><span class="meta-value">${c.telescope}</span></div>
            <div class="meta-item"><span class="meta-label">Track ID</span><span class="meta-value">${c.trackIndex}</span></div>
            <div class="meta-item"><span class="meta-label">Time</span><span class="meta-value">${formatDate(c.timestamp).split(',')[1]?.trim() || 'N/A'}</span></div>
            <div class="meta-item"><span class="meta-label">Pos</span><span class="meta-value">${c.bbox[0]}, ${c.bbox[1]}</span></div>
          </div>
          <div class="candidate-actions">
            <button class="action-btn mark-btn ${isMarked?'marked-btn':''}">${isMarked?'Marked':'Mark'}</button>
            <button class="action-btn" onclick="event.stopPropagation(); showCandidateDetail('${c.id}')">Details</button>
          </div>
        </div>
      </div>`;
  }

  function toggleMark(id) {
    if (markedIds.has(id)) markedIds.delete(id); else markedIds.add(id);
    applyFilters(); updateStats();
  }

  // MODAL
  function showCandidateDetail(id) {
    const c = allCandidates.find(x => x.id === id); if (!c) return;
    const seq = getTrackGroup(c);
    const sungrazer = seq.length > 1 ? seq.map(s => {
      const t = new Date(s.timestamp);
      const hhmm = `${String(t.getUTCHours()).padStart(2,'0')}${String(t.getUTCMinutes()).padStart(2,'0')}`;
      const cx = Math.round(s.bbox[0] + s.bbox[2]/2);
      const cy = Math.round(s.bbox[1] + s.bbox[3]/2);
      return `${hhmm}   ${cx}   ${cy}`;
    }).join('\n') : 'Need 2+ frames';

    document.getElementById('modalTitle').textContent = `Candidate: ${c.id}`;
    document.getElementById('modalBody').innerHTML = `
      <div style="display:grid;gap:1.25rem;">
        <div>
          <div class="seg" id="imgSeg">
            <button data-mode="ann" data-src="${RAW_URL(c.annotatedPath)}">Annotated</button>
            <button data-mode="orig" data-src="${RAW_URL(c.originalPath)}">Original</button>
            <button data-mode="crop" data-src="${RAW_URL(c.cropPath)}">Crop</button>
          </div>
          <img id="segImg" src="${RAW_URL(c.annotatedPath || c.originalPath || c.cropPath)}" class="tl-img" alt="">
        </div>
        <div>
          <h4>Sungrazer Report</h4>
          <pre style="background:#111;padding:1rem;border-radius:.5rem;font-size:.9rem;">Date: ${new Date(c.timestamp).toISOString().split('T')[0]}
Camera: ${c.telescope}
Image Size: 1024x1024
(0,0): Bottom Left
Positions:
${sungrazer}</pre>
        </div>
        <div style="display:flex;gap:.5rem;">
          <button class="btn btn-primary" onclick="toggleMark('${c.id}'); closeModal(); applyFilters();">${markedIds.has(c.id)?'Unmark':'Mark'}</button>
          <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
      </div>
    `;

    const seg = document.getElementById('imgSeg');
    seg.querySelectorAll('button').forEach(b => {
      const src = b.dataset.src;
      b.disabled = !src;
      b.classList.toggle('active', src && b.dataset.src === (c.annotatedPath || c.originalPath || c.cropPath));
    });
    seg.addEventListener('click', e => {
      const btn = e.target.closest('button'); if (!btn || btn.disabled) return;
      seg.querySelectorAll('button').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('segImg').src = btn.dataset.src + '#' + Date.now();
    });

    document.getElementById('candidateModal').classList.add('active');
  }

  function closeModal() { document.getElementById('candidateModal').classList.remove('active'); }

  // EXPORTS
  function exportTXT() {
    const list = els.exportMarkedOnly.checked ? allCandidates.filter(c => markedIds.has(c.id)) : allCandidates;
    const tracks = {};
    list.forEach(c => { const tid = c.trackIndex; if (!tracks[tid]) tracks[tid] = []; tracks[tid].push(c); });
    const lines = [];
    Object.keys(tracks).sort((a,b)=>+a-+b).forEach(tid => {
      const t = tracks[tid].sort((a,b)=>a.timestamp.localeCompare(b.timestamp));
      if (!t.length) return;
      const first = t[0];
      lines.push(`Track: ${tid} (${first.label.toUpperCase()} ${(first.score*100).toFixed(1)}%)`);
      lines.push(`Date: ${new Date(first.timestamp).toISOString().split('T')[0]}`);
      lines.push(`Camera: ${first.telescope}`);
      lines.push(`Image Size: 1024x1024`);
      lines.push(`(0,0): Bottom Left`);
      lines.push(`Positions:`);
      t.forEach(p => {
        const ts = new Date(p.timestamp);
        const hhmm = `${String(ts.getUTCHours()).padStart(2,'0')}${String(ts.getUTCMinutes()).padStart(2,'0')}`;
        const cx = Math.round(p.bbox[0] + p.bbox[2]/2);
        const cy = Math.round(p.bbox[1] + p.bbox[3]/2);
        lines.push(`${hhmm}   ${cx}   ${cy}`);
      });
      lines.push('');
    });
    const blob = new Blob([lines.join('\n')], {type: 'text/plain'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `sungrazer_${Date.now()}.txt`; a.click();
  }

  function exportCSV() {
    const list = els.exportMarkedOnly.checked ? allCandidates.filter(c => markedIds.has(c.id)) : allCandidates;
    const rows = list.map(c => [
      c.id, c.label.toUpperCase(), (c.score*100).toFixed(1), c.telescope, c.timestamp,
      c.trackIndex, c.bbox[0], c.bbox[1], RAW_URL(c.cropPath)
    ]);
    const csv = [['ID','Label','Score','Tel','Time','Track','X','Y','Crop_URL'], ...rows].map(r=>r.join(',')).join('\n');
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = `soho_${Date.now()}.csv`; a.click();
  }

  // STATS & LIVE
  function updateStats() {
    const total = allCandidates.length;
    const comets = allCandidates.filter(c=>c.label==='comet').length;
    const c2 = allCandidates.filter(c=>c.telescope==='C2').length;
    const c3 = allCandidates.filter(c=>c.telescope==='C3').length;
    const marked = [...markedIds].filter(id=>allCandidates.some(c=>c.id===id)).length;
    els.statTotal.textContent=total; els.statComets.textContent=comets; els.statC2.textContent=c2; els.statC3.textContent=c3; els.statMarked.textContent=marked;
  }

  async function updateLiveFeeds() {
    const feeds = [
      {url:'https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif', el:els.c2LiveGif, ts:els.c2Timestamp},
      {url:'https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif', el:els.c3LiveGif, ts:els.c3Timestamp}
    ];
    for (const f of feeds) {
      try {
        const r = await fetch(f.url, {method:'HEAD'});
        const lm = r.headers.get('last-modified');
        if (lm) f.ts.textContent = new Date(lm).toLocaleTimeString();
        f.el.src = f.url + '?t=' + Date.now();
      } catch (e) { console.error(e); }
    }
  }

  // COUNTDOWN
  let countdownInterval;
  function startCountdown() {
    let s = 300;
    clearInterval(countdownInterval);
    countdownInterval = setInterval(() => {
      s--;
      const m = Math.floor(s/60), sec = String(s%60).padStart(2,'0');
      els.countdown.textContent = `${m}:${sec}`;
      if (s <= 0) { loadReports(); s = 300; }
    }, 1000);
  }

  // EVENTS
  els.reportSelect.addEventListener('change', e => loadReport(e.target.value));
  els.candidateSelect.addEventListener('change', applyFilters);
  els.refreshBtn.addEventListener('click', () => { loadReports(); startCountdown(); });
  els.exportTxtBtn.addEventListener('click', exportTXT);
  els.exportCsvBtn.addEventListener('click', exportCSV);
  [els.filterC2, els.filterC3, els.filterComet, els.filterMarked].forEach(cb => cb.addEventListener('change', applyFilters));
  document.getElementById('candidateModal').addEventListener('click', e => { if (e.target.id === 'candidateModal') closeModal(); });

  // INIT
  loadReports();
  startCountdown();
  setInterval(updateLiveFeeds, 120000);
</script>
</body>
</html>
