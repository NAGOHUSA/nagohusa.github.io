<!-- DOCUMENT filename="index.html" -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SOHO Comet Hunter – Nagoh Creative</title>
<meta name="description" content="Live NASA LASCO animations, AI-detected comets and Sungrazer-ready exports – built by Nagoh Creative for OurNightSky.Us">
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0b1220; --panel:#0f1b30; --muted:#94a3b8; --text:#e6eefc; --accent:#60a5fa;
    --chip:#1e293b; --card:#0d1526; --shadow:0 8px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),#0b1220f0 80%,#0b122000);backdrop-filter:blur(6px);border-bottom:1px solid #1e293b}
  .wrap{max-width:1240px;margin:auto;padding:14px 16px}
  h1{font-size:1.35rem;font-weight:800;letter-spacing:.3px}
  .sub{font-size:.85rem;color:var(--muted)}
  .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-top:12px}
  button,.sel,input[type=checkbox]{cursor:pointer}
  button{border:1px solid #243244;background:#0e1a2b;color:var(--text);padding:8px 14px;border-radius:12px;font-weight:700;box-shadow:var(--shadow)}
  button:hover{border-color:#33508a}
  .sel{background:#0e1a2b;border:1px solid #243244;border-radius:12px;padding:6px 10px;color:var(--text);min-width:160px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #1e293b;padding:4px 8px;border-radius:999px;font-size:.8rem;color:var(--muted)}
  .pill input{accent-color:var(--accent)}
  .right{margin-left:auto}
  main{padding:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
  .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
  .thumb{aspect-ratio:1.6/1;width:100%;background:#0b1220;object-fit:contain;display:block}
  .meta{padding:12px;flex:1;display:flex;flex-direction:column;gap:8px}
  .kvs{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:.8rem;color:var(--muted)}
  .kv b{color:var(--text)}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .stats{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
  .stat{background:var(--panel);border:1px solid #1e293b;border-radius:12px;padding:8px 12px}
  .stat b{font-size:1.1rem}
  .empty{padding:40px;text-align:center;color:var(--muted);border:1px dashed #253044;border-radius:16px;background:#0b1220}
  .err{color:#ffb4b4}
  .thumbRow{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:12px}
  .thumbCard{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden}
  .thumbHead{padding:10px 12px;border-bottom:1px solid #1e293b;display:flex;align-items:center;gap:10px}
  .gifRow{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:16px;margin-top:12px}
  .gifCard{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden}
  .gifHead{padding:10px 12px;border-bottom:1px solid #1e293b;display:flex;gap:10px;align-items:center}
  .gif{display:block;width:100%;background:#0b1220;aspect-ratio:1/1;object-fit:contain}
  .exportAll{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:.75rem}
  .mark{display:flex;gap:6px;align-items:center}
  .flag{padding:4px 8px;border-radius:10px;border:1px solid #1e293b;background:#13223a}
  .flag.on{background:#11351d;border-color:#1d4d2a;color:#b5f7c0}
  .group{background:#0e1a2b;border:1px solid #243244;border-radius:10px;padding:4px 6px;color:var(--text);font-size:.75rem}
  .seg{display:inline-flex;border:1px solid #27324a;border-radius:10px;overflow:hidden;background:#0e1a2b}
  .seg button{border:0;border-right:1px solid #27324a;background:transparent;color:#cbd5e1;padding:6px 10px;font-size:.75rem}
  .seg button:last-child{border-right:0}
  .seg button.active{background:#1b2a46;color:#e6eefc}
  .video-container{margin-top:12px;border:1px solid #1e293b;border-radius:12px;overflow:hidden;background:#0b1220}
  .video-container video{width:100%;display:block;background:#000}
  footer{font-size:.75rem;color:var(--muted);padding:20px 0;text-align:center}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>SOHO Comet Hunter1.1</h1>
    <div class="sub">Live NASA LASCO animations • AI-detected comets • Sungrazer-ready exports</div>
    <div class="controls">
      <button id="refreshBtn">Refresh</button>

      <select id="latestSelect" class="sel"><option value="">— Latest Report —</option></select>
      <select id="hitsSelect"   class="sel"><option value="">— Potential Hits —</option></select>

      <label class="pill"><input type="checkbox" id="c2Filter"> C2</label>
      <label class="pill"><input type="checkbox" id="c3Filter"> C3</label>
      <label class="pill"><input type="checkbox" id="aiOnly"> AI='comet' only</label>
      <label class="pill"><input type="checkbox" id="markedOnly"> Marked only</label>

      <div class="right pill">Auto-refresh: <span id="refreshEta">—</span></div>

      <div class="exportAll">
        <button id="exportAllBtn">Export ALL</button>
        <label class="pill"><input type="checkbox" id="exportMarkedOnly"> Marked only</label>
        <a id="downloadAllTxt" class="pill" href="#" download style="display:none;">TXT</a>
        <a id="downloadAllCsv" class="pill" href="#" download style="display:none;">CSV</a>
        <span id="exportAllHint" class="muted"></span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">

  <section id="status">
    <div class="row">
      <div>Current view: <b id="viewName">—</b> <span class="sub" id="reportTime"></span></div>
    </div>
    <div class="stats" id="stats"></div>
  </section>

  <section aria-label="Live LASCO animations" style="margin-top:20px;">
    <div class="gifRow">
      <div class="gifCard">
        <div class="gifHead">
          <span class="pill">C2 – Live GIF</span>
          <a class="sub" href="https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif" target="_blank" rel="noopener">open</a>
          <span class="right sub" id="c2GifTime"></span>
        </div>
        <img id="c2Gif" class="gif" alt="SOHO LASCO C2 live animation">
      </div>
      <div class="gifCard">
        <div class="gifHead">
          <span class="pill">C3 – Live GIF</span>
          <a class="sub" href="https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif" target="_blank" rel="noopener">open</a>
          <span class="right sub" id="c3GifTime"></span>
        </div>
        <img id="c3Gif" class="gif" alt="SOHO LASCO C3 live animation">
      </div>
    </div>
  </section>

  <section style="margin-top:20px;">
    <div class="thumbRow" id="lastFramesRow"></div>
    <div class="empty" id="errors" style="margin-top:12px;display:none;"></div>
  </section>

  <section id="content" style="margin-top:24px;">
    <div class="empty" id="empty">Loading latest detections from GitHub…</div>
    <div class="grid" id="grid" hidden></div>
  </section>

  <footer>
    <div>Built by <a href="https://nagohcreative.com" target="_blank" rel="noopener">Nagoh Creative</a> for <a href="https://ournightsky.us" target="_blank" rel="noopener">OurNightSky.Us</a></div>
  </footer>
</main>

<script>
/* ==================== CONFIG ==================== */
const OWNER  = "NAGOHUSA";
const REPO   = "ONS_SOHOHUNTER";
const BRANCH = "main";
const FOLDER = "detections";
const REFRESH_SECS = 15 * 60;
/* =============================================== */

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

const el = {
  grid:$('#grid'), empty:$('#empty'), errors:$('#errors'),
  viewName:$('#viewName'), reportTime:$('#reportTime'), stats:$('#stats'),
  latestSelect:$('#latestSelect'), hitsSelect:$('#hitsSelect'),
  c2Filter:$('#c2Filter'), c3Filter:$('#c3Filter'), aiOnly:$('#aiOnly'), markedOnly:$('#markedOnly'),
  lastFramesRow:$('#lastFramesRow'), c2Gif:$('#c2Gif'), c3Gif:$('#c3Gif'),
  c2GifTime:$('#c2GifTime'), c3GifTime:$('#c3GifTime'),
  exportAllBtn:$('#exportAllBtn'), exportMarkedOnly:$('#exportMarkedOnly'),
  downloadAllTxt:$('#downloadAllTxt'), downloadAllCsv:$('#downloadAllCsv'), exportAllHint:$('#exportAllHint'),
  refreshBtn:$('#refreshBtn'), refreshEta:$('#refreshEta')
};

let currentReport = null;
let refreshTimer = null, countdown = REFRESH_SECS;

const LS_MARKS = 'soho_marks', LS_GROUPS = 'soho_groups';
const marks = () => JSON.parse(localStorage.getItem(LS_MARKS) || '{}');
const groups = () => JSON.parse(localStorage.getItem(LS_GROUPS) || '{}');
const saveMarks = m => localStorage.setItem(LS_MARKS, JSON.stringify(m));
const saveGroups = g => localStorage.setItem(LS_GROUPS, JSON.stringify(g));
const keyFor = h => `${(h.detector||'').toUpperCase()}#${h.track_index}#${h.series_mid_frame||''}`;

/* ---------- GITHUB HELPERS ---------- */
const apiListURL = () => `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(FOLDER)}?ref=${encodeURIComponent(BRANCH)}`;

function rawURL(path) {
  const p = String(path || '').replace(/^\/+/, '');
  if (!p) return '';
  if (/^https?:\/\//i.test(p)) return p;
  const rel = p.startsWith('detections/') ? p : `detections/${p}`;
  return `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${rel}`;
}

/* Helper to add fresh timestamp */
const freshURL = url => `${url}${url.includes('?') ? '&' : '?'}t=${Date.now()}`;

async function fetchJSON(url, retry = 0){
  try{
    const r = await fetch(url,{headers:{'Accept':'application/vnd.github+json'}});
    if(r.status===429){
      const wait = Math.pow(2,retry)*1000 + 500;
      showError(`Rate-limited – retry in ${Math.round(wait/1000)}s`);
      await new Promise(res=>setTimeout(res,wait));
      return fetchJSON(url,retry+1);
    }
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }catch(e){
    if(retry<3) return fetchJSON(url,retry+1);
    throw e;
  }
}
function showError(msg){ el.errors.style.display='block'; el.errors.innerHTML=`<div class="err">${msg}</div>`; }
function hideError(){ el.errors.style.display='none'; }

/* ---------- UI HELPERS ---------- */
function fmtSec(s){
  const m = Math.floor(s/60), sec = s%60;
  return `${m}:${sec<10?'0':''}${sec}`;
}
function parseReportTime(name){
  const m = name.match(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/);
  if(m){
    const utc = new Date(Date.UTC(m[1],m[2]-1,m[3],m[4],m[5],m[6]));
    return {utc:utc.toISOString(), local:utc.toLocaleString()};
  }
  return null;
}
function seg(opts){
  const seg = document.createElement('div'); seg.className='seg';
  opts.forEach(({label, active, disabled, click})=>{
    const b = document.createElement('button');
    b.textContent = label;
    if(active) b.classList.add('active');
    if(disabled) b.disabled = true;
    else b.onclick = ()=>{ seg.querySelectorAll('button').forEach(b=>b.classList.remove('active')); b.classList.add('active'); click(); };
    seg.appendChild(b);
  });
  return seg;
}
function sungrazerText(h){
  return h.positions.map(p=>`${p.time_utc.replace(/Z$/,'').replace('T',' ')} ${p.x|0} ${p.y|0}`).join('\n');
}
function allSungrazerText(items, name){
  return items.map((h,i)=>`# Candidate ${i+1} (${h.detector.toUpperCase()} Track #${h.track_index})\n${sungrazerText(h)}\n\n`).join('');
}
function allCSV(items){
  return 'detector,track_index,time_utc,x,y\n' +
    items.flatMap(h=>h.positions.map(p=>`${h.detector},${h.track_index},${p.time_utc},${p.x},${p.y}`)).join('\n');
}
function animationWidget(h) {
  const wrap = document.createElement('div');
  wrap.className = 'video-container';

  const annGif  = h.animation_gif_path ? rawURL(h.animation_gif_path) : null;
  const cleanGif= h.animation_gif_clean_path ? rawURL(h.animation_gif_clean_path) : null;

  if (!annGif && !cleanGif) {
    wrap.innerHTML = `<div style="padding:12px;color:#94a3b8;">No animation yet…</div>`;
    return wrap;
  }

  // Show GIF as <img> (more reliable than stuffing a GIF into <video>)
  const img = document.createElement('img');
  img.className = 'gif';
  img.alt = 'Candidate animation';
  img.loading = 'lazy';

  const setSrc = (url) => { img.src = `${url}${url.includes('?') ? '&' : '?'}t=${Date.now()}`; };

  const bar = seg([
    { label: 'Annotated GIF', active: !!annGif, disabled: !annGif, click: () => setSrc(annGif) },
    { label: 'Clean GIF',     active: !annGif && !!cleanGif, disabled: !cleanGif, click: () => setSrc(cleanGif) },
  ]);
  bar.bar.style = 'margin:8px';

  // Default choice
  setSrc(annGif || cleanGif);

  // Direct “open” link so you can verify quickly
  const open = document.createElement('div');
  open.style = 'padding:6px 10px';
  open.innerHTML = [
    annGif ? `<a class="pill" target="_blank" rel="noopener" href="${annGif}">Open annotated</a>` : '',
    cleanGif ? `<a class="pill" target="_blank" rel="noopener" href="${cleanGif}">Open clean</a>` : ''
  ].filter(Boolean).join(' ');

  wrap.appendChild(bar);
  wrap.appendChild(img);
  wrap.appendChild(open);
  return wrap;
}
function applyFilters(items){
  let f = items;
  if(el.c2Filter.checked) f = f.filter(h=>h.detector==='C2');
  if(el.c3Filter.checked) f = f.filter(h=>h.detector==='C3');
  if(el.aiOnly.checked) f = f.filter(h=>(h.ai_label||'').toLowerCase()==='comet');
  if(el.markedOnly.checked) f = f.filter(h=>marks()[keyFor(h)]);
  return f;
}
function renderStats(items){
  const f = applyFilters(items);
  const stats = [
    {label:'Candidates', val:f.length},
    {label:'C2', val:f.filter(h=>h.detector==='C2').length},
    {label:'C3', val:f.filter(h=>h.detector==='C3').length},
    {label:'Comet AI', val:f.filter(h=>(h.ai_label||'').toLowerCase()==='comet').length},
    {label:'Marked', val:f.filter(h=>marks()[keyFor(h)]).length},
  ];
  el.stats.innerHTML = stats.map(s=>`<div class="stat"><div>${s.label}</div><b>${s.val}</b></div>`).join('');
}
function renderGrid(items){
  renderStats(items);
  items = applyFilters(items);
  el.grid.innerHTML = '';
  el.grid.hidden = !items.length; el.empty.hidden = !!items.length;
  el.empty.textContent = items.length ? '' : 'No candidates match filters.';
  items.forEach((h,i)=>{
    const k = keyFor(h);
    const marked = !!marks()[k];
    const groupVal = groups()[k]||"Unknown";

    const cropURL = h.crop_path ? rawURL(h.crop_path) : null;
    const origURL = h.original_mid_path ? rawURL(h.original_mid_path) : null;
    const annURL  = h.annotated_mid_path ? rawURL(h.annotated_mid_path) : null;

    const txtURL = rawURL(`reports/${(h.detector||'').toUpperCase()}_track${h.track_index}_sungrazer.txt`);
    const csvURL = rawURL(`reports/${(h.detector||'').toUpperCase()}_track${h.track_index}_sungrazer.csv`);

    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.className='thumb'; img.loading='lazy';
    img.src = freshURL(cropURL); img.alt = `candidate ${i+1}`;
    const link = document.createElement('a'); link.href=freshURL(cropURL); link.target='_blank'; link.rel='noopener';
    link.appendChild(img); card.appendChild(link);

    img.onerror = () => { img.alt = '(loading failed)'; img.title = 'Image failed to load'; };

    const segWrap = document.createElement('div'); segWrap.style.padding='0 12px 8px';
    const segToggle = seg([
      {label:'Crop', active:true, click:()=>{ const url=freshURL(cropURL); img.src=url; link.href=url; }},
      {label:'Original', disabled:!origURL, click:()=>{ const url=freshURL(origURL); img.src=url; link.href=url; }},
      {label:'Annotated', disabled:!annURL, click:()=>{ const url=freshURL(annURL); img.src=url; link.href=url; }}
    ]);
    segWrap.appendChild(segToggle); card.appendChild(segWrap);

    card.appendChild(animationWidget(h));

    const meta = document.createElement('div'); meta.className='meta';
    const speed = (()=>{ const p=h.positions||[]; if(p.length<2) return '—';
      const d = Math.hypot(p[p.length-1].x-p[0].x, p[p.length-1].y-p[0].y);
      return `${(d/Math.max(1,p.length-1)).toFixed(1)} px/frame`; })();
    const pa = h.dual_channel_match ? `${h.dual_channel_match.with} (Δ=${h.dual_channel_match.pa_diff_deg}°)` : '—';

    meta.innerHTML = `
      <div class="row">
        <span class="pill">${(h.detector||'').toUpperCase()}</span>
        <span class="pill">Track #${h.track_index??'?'}</span>
        <span class="pill">PA: ${pa}</span>
        <span class="pill">Speed: ${speed}</span>
        <span class="right sub">${h.series_mid_frame||''}</span>
      </div>
      <div class="kvs">
        <div class="kv">Size: <b>${h.image_size?.[0]??1024}×${h.image_size?.[1]??1024}</b></div>
        <div class="kv">Origin: <b>Upper Left</b></div>
        <div class="kv">Frames: <b>${(h.positions||[]).length}</b></div>
        <div class="kv">First: <b>${(h.positions?.[0]?.time_utc||"").split('T')[0]||'—'}</b></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="sgBtn">Copy for Sungrazer</button>
        <a class="pill" href="${txtURL}" target="_blank" rel="noopener">TXT</a>
        <a class="pill" href="${csvURL}" target="_blank" rel="noopener">CSV</a>
        ${origURL?`<a class="pill" href="${origURL}" target="_blank" rel="noopener">Original</a>`:''}
        ${annURL?`<a class="pill" href="${annURL}" target="_blank" rel="noopener">Annotated</a>`:''}
        <span class="right mark">
