<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SOHO Comet Hunter — Live Results</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f1b30; --muted:#94a3b8; --text:#e6eefc; --accent:#60a5fa; --chip:#1e293b; --card:#0d1526; --shadow:0 8px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),#0b1220f0 80%,#0b122000);backdrop-filter:blur(6px);border-bottom:1px solid #1e293b}
  .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
  h1{margin:6px 0 0;font-size:20px;font-weight:800;letter-spacing:.3px}
  .sub{font-size:13px;color:var(--muted)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button,.sel,input[type="checkbox"]{cursor:pointer}
  button{border:1px solid #243244;background:#0e1a2b;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:700;box-shadow:var(--shadow)}
  button:hover{border-color:#33508a}
  .sel{background:#0e1a2b;border:1px solid #243244;border-radius:12px;padding:8px 10px;color:var(--text)}
  main{padding:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
  .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
  .thumb{aspect-ratio:1.6/1;display:block;width:100%;background:#0b1220;object-fit:contain}
  .meta{padding:12px}
  .kvs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
  .kv{font-size:12px;color:var(--muted)}
  .kv b{color:var(--text)}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #1e293b;padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .right{margin-left:auto}
  .stats{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .stat{background:var(--panel);border:1px solid #1e293b;border-radius:12px;padding:10px 12px}
  .stat b{font-size:18px}
  .empty{padding:40px;text-align:center;color:var(--muted);border:1px dashed #253044;border-radius:16px;background:#0b1220}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
  footer{color:var(--muted);font-size:12px;padding:20px 0}
  .err{color:#ffb4b4}
  .thumbRow{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:12px}
  .thumbCard{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden}
  .thumbHead{padding:10px 12px;border-bottom:1px solid #1e293b;display:flex;align-items:center;gap:10px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>SOHO Comet Hunter</h1>
    <div class="sub">Live last-frame thumbnails + candidate crops from your GitHub repo.</div>
    <div class="controls">
      <button id="refreshBtn" title="Reload now">⟳ Refresh</button>
      <select id="reportSelect" class="sel" title="Pick a past report"></select>
      <label class="pill"><input type="checkbox" id="c2Filter" /> C2</label>
      <label class="pill"><input type="checkbox" id="c3Filter" /> C3</label>
      <label class="pill"><input type="checkbox" id="aiOnly" /> AI=‘comet’ only</label>
      <div class="right pill">Auto-refresh: <span id="refreshEta">—</span></div>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="status">
    <div class="row">
      <div>Latest report: <b id="reportName">—</b> <span class="sub" id="reportTime"></span></div>
      <div class="right sub">Source: <a id="srcLink" href="#" target="_blank" rel="noopener">GitHub</a></div>
    </div>
    <div class="stats" id="stats"></div>
  </section>

  <!-- Annotated last-frame thumbnails -->
  <section style="padding-top:10px;">
    <div class="thumbRow" id="lastFramesRow"></div>
    <div class="empty" id="errors" style="margin-top:12px; display:none;"></div>
  </section>

  <section id="content" style="margin-top:16px;">
    <div class="empty" id="empty">No detections yet. The viewer will update automatically when new candidates are committed.</div>
    <div class="grid" id="grid" hidden></div>
  </section>

  <footer>
    <div>Tip: click any crop to open the full image on GitHub. Thumbnails include run stats overlay. Data via SOHO/LASCO providers.</div>
  </footer>
</main>

<script>
/*** CONFIG — EDIT THESE TO MATCH YOUR REPO ***/
const OWNER  = "NAGOHUSA";
const REPO   = "ONS_SOHOHUNTER";
const BRANCH = "main";
/*** END CONFIG ***/

const params = new URLSearchParams(location.search);
const FOLDER = params.get("folder") || "detections";

const apiListURL = () => `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(FOLDER)}?ref=${encodeURIComponent(BRANCH)}`;
const rawURL = (path) => `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${path.replace(/^\.?\/*/,'')}`;
const ghBlobURL = (path) => `https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/${path.replace(/^\.?\/*/,'')}`;

const el = (sel) => document.querySelector(sel);
const grid = el("#grid"), empty = el("#empty");
const reportSelect = el("#reportSelect");
const reportName = el("#reportName"), reportTime = el("#reportTime"), srcLink = el("#srcLink");
const stats = el("#stats");
const c2Filter = el("#c2Filter"), c3Filter = el("#c3Filter"), aiOnly = el("#aiOnly");
const lastFramesRow = document.querySelector("#lastFramesRow");

let allReports = [];
let currentReport = null;
let refreshTimer = null, refreshCountdown = 0, REFRESH_SECS = 60;

function showError(msg){
  const e = document.getElementById('errors');
  e.style.display = 'block';
  e.innerHTML = '<div class="err">'+msg+'</div>';
}
async function fetchJSON(url){
  const r = await fetch(url, {headers:{'Accept':'application/vnd.github+json'}});
  if(!r.ok){
    showError(`Fetch failed: ${url} — HTTP ${r.status}`);
    throw new Error(`HTTP ${r.status} when fetching ${url}`);
  }
  return r.json();
}
function parseReportTime(name){
  const m = name?.match?.(/(\d{8})_(\d{6})/);
  if(!m) return null;
  const [_, d, t] = m;
  const iso = `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}T${t.slice(0,2)}:${t.slice(2,4)}:${t.slice(4,6)}Z`;
  const dt = new Date(iso);
  const fmt = dt.toLocaleString(undefined, {dateStyle:'medium', timeStyle:'short'});
  return {iso, local: fmt};
}
function renderStats(items){
  const byDet = items.reduce((acc,h)=>{
    const k = (h.detector||'unknown').toUpperCase();
    acc[k]=(acc[k]||0)+1; return acc;
  },{});
  const ai = items.reduce((acc,h)=>{
    const l = (h.ai_label||'').toLowerCase();
    if(!l) return acc;
    acc[l]=(acc[l]||0)+1; return acc;
  },{});
  stats.innerHTML = "";
  const add = (label, value) => {
    const div = document.createElement("div");
    div.className = "stat";
    div.innerHTML = `<div class="sub">${label}</div><div><b>${value}</b></div>`;
    stats.appendChild(div);
  };
  add("Candidates", items.length);
  add("C2", byDet.C2||0);
  add("C3", byDet.C3||0);
  if(Object.keys(ai).length){
    add("AI ‘comet’", ai['comet']||0);
    add("AI ‘not_comet’", ai['not_comet']||0);
  }
}
function applyFilters(items){
  const useC2 = c2Filter.checked;
  const useC3 = c3Filter.checked;
  const needAI = aiOnly.checked;
  return items.filter(h=>{
    if(useC2 && (h.detector||'').toUpperCase()!=='C2') return false;
    if(useC3 && (h.detector||'').toUpperCase()!=='C3') return false;
    if(needAI && (h.ai_label||'').toLowerCase()!=='comet') return false;
    return true;
  });
}
function renderGrid(items){
  const filtered = applyFilters(items);
  renderStats(filtered);
  if(!filtered.length){
    grid.hidden = true; empty.hidden = false;
    empty.textContent = "No matching detections for the current filters.";
    return;
  }
  grid.hidden = false; empty.hidden = true;
  grid.innerHTML = "";
  filtered.forEach((h,i)=>{
    const cropPath = (h.crop_path || "").replace(/^\.?\/*/,'');
    const imgURL = rawURL(cropPath);
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <a href="${ghBlobURL(cropPath)}" target="_blank" rel="noopener">
        <img class="thumb" loading="lazy" alt="crop ${i+1}" src="${imgURL}" onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'thumb',textContent:'(image unavailable)'}))">
      </a>
      <div class="meta">
        <div class="row">
          <span class="pill">${(h.detector||'').toUpperCase()||'—'}</span>
          <span class="pill">Track #${h.track_index ?? '?'}</span>
          <span class="right sub">${h.series_mid_frame||''}</span>
        </div>
        <div class="kvs">
          <div class="kv">Timestamp (UTC): <b>${(h.timestamp_utc||'').replace('T',' ').replace('Z',' Z')}</b></div>
          <div class="kv">AI: <b>${h.ai_label||'—'}</b> <span class="sub">${h.ai_score!=null?`(${(+h.ai_score).toFixed(2)})`:''}</span></div>
        </div>
      </div>`;
    grid.appendChild(card);
  });
}
function renderLastFrames(overlays, status){
  if (!overlays || !overlays.length) { lastFramesRow.innerHTML = ""; return; }
  lastFramesRow.innerHTML = overlays.map(o => `
    <div class="thumbCard">
      <div class="thumbHead">
        <span class="pill">${o.det}</span>
        <span class="pill">frames: ${o.frames}</span>
        <span class="pill">tracks: ${o.tracks}</span>
        <span class="pill">${o.lastName || '—'}</span>
        <span class="right sub">${status?.s?.timestamp_utc ? new Date(status.s.timestamp_utc).toLocaleString() : ''}</span>
      </div>
      <a href="${ghBlobURL(`${FOLDER}/lastthumb_${o.det}.png`)}" target="_blank" rel="noopener">
        <img class="thumb" alt="last ${o.det}" src="${o.lastThumb}"
             onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'thumb',textContent:'(thumbnail not available)'}))">
      </a>
      <div class="meta">
        <div class="kv">Overlay: <a href="${o.overlay}" target="_blank">open</a> • Contact sheet: <a href="${o.contact}" target="_blank">open</a></div>
      </div>
    </div>
  `).join("");
}
async function tryLoadStatus() {
  const statusURL = rawURL(`${FOLDER}/latest_status.json`);
  const r = await fetch(statusURL);
  if (!r.ok) return null;
  const s = await r.json();
  const overlays = ["C2","C3"].map(det => ({
    det,
    overlay: rawURL(`${FOLDER}/overlay_${det}.png`),
    contact: rawURL(`${FOLDER}/contact_${det}.png`),
    frames: s?.detectors?.[det]?.frames ?? 0,
    tracks: s?.detectors?.[det]?.tracks ?? 0,
    lastThumb: rawURL(`${FOLDER}/lastthumb_${det}.png`),    // annotated
    lastName: s?.detectors?.[det]?.last_frame_name || ""
  }));
  return { s, overlays };
}
async function loadReportByName(name){
  const url = rawURL(`${FOLDER}/${name}`);
  const data = await fetchJSON(url);
  currentReport = { name, data, url };
  reportName.textContent = name;
  srcLink.href = ghBlobURL(`${FOLDER}/${name}`);
  const t = name ? parseReportTime(name) : null;
  reportTime.textContent = t ? `• ${t.local} (local)` : "";
  if(Array.isArray(data) && data.length){
    renderGrid(data);
  }else{
    grid.hidden = true; empty.hidden = false;
    empty.textContent = "Report is empty.";
  }
  try {
    const status = await tryLoadStatus();
    if (status) renderLastFrames(status.overlays, status);
  } catch (e) {}
}
async function loadLatestReport(){
  try{
    const list = await fetchJSON(apiListURL());
    const files = list
      .filter(f => f.type==="file" && /^candidates_\d{8}_\d{6}\.json$/i.test(f.name))
      .sort((a,b)=> b.name.localeCompare(a.name));
    allReports = files.map(f=>f.name);
    reportSelect.innerHTML = allReports.slice(0,20).map(n=>`<option value="${n}">${n}</option>`).join("");
    if(!files.length){
      reportName.textContent = "—";
      reportTime.textContent = "";
      srcLink.href = `https://github.com/${OWNER}/${REPO}/tree/${BRANCH}/${FOLDER}`;
      const status = await tryLoadStatus();
      if (status) {
        const { s, overlays } = status;
        renderLastFrames(overlays, status);
        grid.hidden = false; empty.hidden = true;
        grid.innerHTML = overlays.map(o => `
          <div class="card">
            <img class="thumb" alt="overlay ${o.det}" src="${o.overlay}">
            <div class="meta">
              <div class="row">
                <span class="pill">${o.det}</span>
                <span class="pill">frames: ${o.frames}</span>
                <span class="pill">tracks: ${o.tracks}</span>
              </div>
              <div class="kv" style="margin-top:8px;">
                Contact sheet: <a href="${o.contact}" target="_blank">open</a>
              </div>
            </div>
          </div>
        `).join("");
        const t = s?.timestamp_utc ? new Date(s.timestamp_utc).toLocaleString() : "";
        reportName.textContent = "latest_status.json";
        reportTime.textContent = t ? `• ${t} (local)` : "";
        return;
      }
      grid.hidden = true; empty.hidden = false;
      empty.innerHTML = `No reports found yet in <code>/${FOLDER}</code>.`;
      return;
    }
    const chosen = params.get("file") || files[0].name;
    reportSelect.value = chosen;
    await loadReportByName(chosen);
  }catch(err){
    grid.hidden = true; empty.hidden = false;
    empty.innerHTML = `<div class="err">Error loading from GitHub: ${err.message}</div>`;
  }
}
function startAutoRefresh(){
  if(refreshTimer) clearInterval(refreshTimer);
  refreshCountdown = REFRESH_SECS;
  el("#refreshEta").textContent = refreshCountdown + "s";
  refreshTimer = setInterval(async ()=>{
    refreshCountdown--;
    el("#refreshEta").textContent = refreshCountdown + "s";
    if(refreshCountdown<=0){
      await loadLatestReport();
      refreshCountdown = REFRESH_SECS;
    }
  }, 1000);
}
el("#refreshBtn").addEventListener("click", async ()=>{ refreshCountdown = REFRESH_SECS; await loadLatestReport(); });
reportSelect.addEventListener("change", (e)=>{ loadReportByName(e.target.value) });
[c2Filter,c3Filter,aiOnly].forEach(cb=> cb.addEventListener("change", ()=>{
  if(currentReport && Array.isArray(currentReport.data)) renderGrid(currentReport.data);
}));
loadLatestReport().then(startAutoRefresh);
</script>
</body>
</html>
