<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SOHO Comet Hunter ‚Äì Professional Dashboard</title>
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <style>
    :root{
      --bg-primary:#05080f;
      --bg-secondary:#0a0f1c;
      --bg-card:#0f1523;
      --bg-card-hover:#141b2d;
      --border:#1a2332;
      --border-bright:#2a3854;
      --text-primary:#e8eef6;
      --text-secondary:#8b9bba;
      --text-tertiary:#5a6b88;
      --accent-primary:#4a9eff;
      --accent-secondary:#3d8ae6;
      --accent-glow:rgba(74,158,255,0.2);
      --success:#22c55e;
      --success-glow:rgba(34,197,94,0.15);
      --danger:#ef4444;
      --warning:#f59e0b;
      --shadow:0 4px 12px rgba(0,0,0,0.4);
      --shadow-lg:0 20px 40px rgba(0,0,0,0.5);
      --gradient-primary:linear-gradient(135deg, #1e3a8a 0%, #1e1b4b 50%, #312e81 100%);
      --gradient-card:linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
    }
    
    @keyframes starfield {
      0% { background-position: 0 0, 40px 60px, 130px 270px; }
      100% { background-position: 600px 600px, 640px 660px, 730px 870px; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    *{box-sizing:border-box;margin:0;padding:0}
    
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:var(--bg-primary);
      color:var(--text-primary);
      line-height:1.6;
      min-height:100vh;
      background-image:
        radial-gradient(2px 2px at 20% 30%, white, transparent),
        radial-gradient(2px 2px at 60% 70%, white, transparent),
        radial-gradient(1px 1px at 50% 50%, white, transparent),
        radial-gradient(1px 1px at 80% 10%, white, transparent),
        radial-gradient(2px 2px at 90% 60%, white, transparent),
        radial-gradient(1px 1px at 33% 50%, white, transparent),
        radial-gradient(1px 1px at 66% 33%, white, transparent);
      background-size: 600px 600px, 600px 600px, 600px 600px;
      animation: starfield 200s linear infinite;
    }
    
    .header{
      background:var(--gradient-primary);
      padding:2.5rem 0;
      box-shadow:var(--shadow-lg);
      border-bottom:2px solid var(--border-bright);
      position:relative;
      overflow:hidden;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 200%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
      animation: shimmer 3s infinite;
    }
    
    .container{max-width:1400px;margin:0 auto;padding:0 1.5rem;position:relative;z-index:1}
    
    .header-content{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:1.5rem;
    }
    
    .header-title h1{
      font-size:2.25rem;
      font-weight:800;
      margin-bottom:.5rem;
      background:linear-gradient(135deg,#ffffff 0%,#93c5fd 50%,#60a5fa 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      letter-spacing:-0.5px;
      text-shadow:0 0 30px rgba(147,197,253,0.3);
    }
    
    .header-subtitle{
      color:#bfdbfe;
      font-size:1rem;
      font-weight:500;
      letter-spacing:0.5px;
      opacity:0.9;
    }
    
    .header-partners{
      font-size:0.8rem;
      color:#93c5fd;
      margin-top:0.5rem;
      opacity:0.8;
    }
    
    .header-partners a{
      color:#60a5fa;
      text-decoration:none;
      transition:color 0.2s;
    }
    
    .header-partners a:hover{
      color:#ffffff;
    }
    
    .header-actions{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    
    .controls-bar{
      background:rgba(10,15,28,0.95);
      padding:1.75rem 0;
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:100;
      backdrop-filter:blur(20px);
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
    }
    
    .controls-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:1.25rem;
      margin-bottom:1.25rem;
    }
    
    .control-group{display:flex;flex-direction:column;gap:.5rem}
    
    .control-label{
      font-size:.75rem;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:1px;
      color:var(--accent-primary);
      margin-bottom:.25rem;
    }
    
    .select-wrapper{position:relative}
    
    select{
      width:100%;
      padding:.875rem 2.75rem .875rem 1.25rem;
      background:var(--bg-card);
      border:1.5px solid var(--border);
      border-radius:.625rem;
      color:var(--text-primary);
      font-size:.9rem;
      cursor:pointer;
      appearance:none;
      transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight:500;
    }
    
    select:hover{
      border-color:var(--accent-primary);
      background:var(--bg-card-hover);
      box-shadow:0 0 0 3px var(--accent-glow);
    }
    
    select:focus{
      outline:none;
      border-color:var(--accent-primary);
      box-shadow:0 0 0 4px var(--accent-glow);
    }
    
    .select-wrapper::after{
      content:'‚ñº';
      position:absolute;
      right:1rem;
      top:50%;
      transform:translateY(-50%);
      pointer-events:none;
      color:var(--accent-primary);
      font-size:.7rem;
    }
    
    .filters{
      display:flex;
      gap:1rem;
      flex-wrap:wrap;
      align-items:center;
      padding-top:1.25rem;
      border-top:1px solid var(--border-bright);
    }
    
    .filter-chip{
      display:flex;
      align-items:center;
      gap:.625rem;
      padding:.625rem 1.25rem;
      background:var(--bg-card);
      border:1.5px solid var(--border);
      border-radius:2rem;
      cursor:pointer;
      transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size:.875rem;
      font-weight:600;
    }
    
    .filter-chip:hover{
      border-color:var(--accent-primary);
      background:var(--bg-card-hover);
      box-shadow:0 0 0 3px var(--accent-glow);
      transform:translateY(-1px);
    }
    
    .filter-chip input[type="checkbox"]{
      cursor:pointer;
      width:1.125rem;
      height:1.125rem;
      accent-color:var(--accent-primary);
    }
    
    .btn{
      padding:.875rem 1.75rem;
      border:none;
      border-radius:.625rem;
      font-weight:700;
      cursor:pointer;
      transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
      display:inline-flex;
      align-items:center;
      gap:.625rem;
      font-size:.9rem;
      text-decoration:none;
      position:relative;
      overflow:hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .btn-primary{
      background:linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      color:#fff;
      box-shadow:0 4px 12px rgba(74,158,255,0.3);
    }
    
    .btn-primary:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(74,158,255,0.4);
    }
    
    .btn-secondary{
      background:var(--bg-card);
      color:var(--text-primary);
      border:1.5px solid var(--border-bright);
    }
    
    .btn-secondary:hover{
      border-color:var(--accent-primary);
      background:var(--bg-card-hover);
      box-shadow:0 0 0 3px var(--accent-glow);
    }
    
    .btn-sm{padding:.625rem 1.25rem;font-size:.85rem}
    
    .stats-dashboard{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:1.25rem;
      margin:2rem 0;
    }
    
    .stat-card{
      background:var(--gradient-card);
      background-color:var(--bg-card);
      padding:1.75rem;
      border-radius:1rem;
      border:1.5px solid var(--border);
      box-shadow:var(--shadow);
      transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
      animation:fadeIn 0.5s ease;
    }
    
    .stat-card:hover{
      transform:translateY(-4px);
      border-color:var(--border-bright);
      box-shadow:var(--shadow-lg);
    }
    
    .stat-label{
      font-size:.8rem;
      color:var(--text-tertiary);
      text-transform:uppercase;
      letter-spacing:1px;
      margin-bottom:.75rem;
      font-weight:700;
    }
    
    .stat-value{
      font-size:2.5rem;
      font-weight:800;
      color:var(--text-primary);
      line-height:1;
      background:linear-gradient(135deg,#ffffff 0%,#93c5fd 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    
    .stat-card.highlight{
      background:linear-gradient(145deg, rgba(74,158,255,0.12) 0%, rgba(74,158,255,0.04) 100%);
      border-color:var(--accent-primary);
      box-shadow:0 0 0 1px var(--accent-glow), var(--shadow);
    }
    
    .live-feed{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(420px,1fr));
      gap:1.5rem;
      margin:2rem 0;
    }
    
    .feed-card{
      background:var(--bg-card);
      border:1.5px solid var(--border);
      border-radius:1rem;
      overflow:hidden;
      box-shadow:var(--shadow);
      transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
      animation:fadeIn 0.5s ease;
    }
    
    .feed-card:hover{
      transform:translateY(-4px);
      border-color:var(--border-bright);
      box-shadow:var(--shadow-lg);
    }
    
    .feed-header{
      padding:1.25rem 1.5rem;
      background:linear-gradient(135deg, rgba(74,158,255,0.15) 0%, rgba(74,158,255,0.05) 100%);
      border-bottom:1.5px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    .feed-title{
      font-weight:700;
      font-size:1.1rem;
      display:flex;
      align-items:center;
      gap:.75rem;
      letter-spacing:0.5px;
    }
    
    .badge{
      padding:.375rem 1rem;
      border-radius:1.5rem;
      font-size:.75rem;
      font-weight:700;
      background:linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      color:#fff;
      letter-spacing:0.5px;
      box-shadow:0 2px 8px rgba(74,158,255,0.3);
    }
    
    .feed-content{
      aspect-ratio:1;
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .feed-content img,.feed-content video{width:100%;height:100%;object-fit:contain}
    
    .feed-footer{
      padding:1rem 1.5rem;
      background:rgba(0,0,0,0.3);
      font-size:.85rem;
      color:var(--text-secondary);
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:500;
    }
    
    .candidates-section{margin:2.5rem 0}
    
    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:1.75rem;
    }
    
    .section-title{
      font-size:1.75rem;
      font-weight:800;
      background:linear-gradient(135deg,#ffffff 0%,#93c5fd 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      letter-spacing:-0.5px;
    }
    
    .candidates-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
      gap:1.5rem;
    }
    
    .candidate-card{
      background:var(--gradient-card);
      background-color:var(--bg-card);
      border:1.5px solid var(--border);
      border-radius:1rem;
      overflow:hidden;
      box-shadow:var(--shadow);
      transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor:pointer;
      animation:fadeIn 0.5s ease;
    }
    
    .candidate-card:hover{
      transform:translateY(-6px);
      box-shadow:var(--shadow-lg);
      border-color:var(--accent-primary);
    }
    
    .candidate-card.marked{
      border-color:var(--success);
      box-shadow:0 0 0 2px var(--success-glow), var(--shadow);
    }
    
    .candidate-image{
      width:100%;
      aspect-ratio:1.6;
      background:#000;
      object-fit:contain;
    }
    
    .candidate-body{padding:1.5rem}
    
    .candidate-header{
      display:flex;
      justify-content:space-between;
      align-items:start;
      margin-bottom:1.25rem;
    }
    
    .candidate-id{
      font-weight:700;
      font-size:1.2rem;
      letter-spacing:0.5px;
    }
    
    .candidate-score{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:.375rem;
    }
    
    .score-badge{
      padding:.375rem .875rem;
      border-radius:1.5rem;
      font-size:.75rem;
      font-weight:700;
      letter-spacing:0.5px;
    }
    
    .score-badge.comet{
      background:linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      color:#fff;
      box-shadow:0 2px 8px var(--success-glow);
    }
    
    .score-badge.not_comet{
      background:linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      color:#fff;
      box-shadow:0 2px 8px rgba(239,68,68,0.3);
    }
    
    .score-badge.unknown{
      background:linear-gradient(135deg, var(--text-secondary) 0%, #64748b 100%);
      color:#fff;
    }
    
    .score-value{
      font-size:.9rem;
      color:var(--text-secondary);
      font-weight:600;
    }
    
    .candidate-meta{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:1rem;
      margin-bottom:1.25rem;
      font-size:.875rem;
    }
    
    .meta-item{
      display:flex;
      flex-direction:column;
      gap:.375rem;
    }
    
    .meta-label{
      color:var(--text-tertiary);
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:1px;
      font-weight:700;
    }
    
    .meta-value{
      color:var(--text-primary);
      font-weight:600;
    }
    
    .candidate-actions{
      display:flex;
      gap:.625rem;
      padding-top:1.25rem;
      border-top:1.5px solid var(--border);
    }
    
    .action-btn{
      flex:1;
      padding:.625rem;
      border:1.5px solid var(--border);
      background:transparent;
      color:var(--text-primary);
      border-radius:.5rem;
      cursor:pointer;
      font-size:.85rem;
      font-weight:700;
      transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .action-btn:hover{
      background:var(--bg-card-hover);
      border-color:var(--accent-primary);
      box-shadow:0 0 0 3px var(--accent-glow);
      transform:translateY(-1px);
    }
    
    .action-btn.marked-btn{
      background:linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      border-color:var(--success);
      color:#fff;
      box-shadow:0 2px 8px var(--success-glow);
    }
    
    .empty-state{
      text-align:center;
      padding:5rem 2rem;
      color:var(--text-secondary);
    }
    
    .empty-state-icon{
      font-size:4rem;
      margin-bottom:1.5rem;
      opacity:.2;
    }
    
    .empty-state-title{
      font-size:1.75rem;
      font-weight:700;
      margin-bottom:.75rem;
      color:var(--text-primary);
    }
    
    .spinner{
      border:3px solid var(--accent-glow);
      border-top-color:var(--accent-primary);
      border-radius:50%;
      width:48px;
      height:48px;
      animation:spin .8s linear infinite;
      margin:3rem auto;
    }
    
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.85);
      backdrop-filter:blur(8px);
      z-index:1000;
      padding:2rem;
      overflow-y:auto;
    }
    
    .modal.active{
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .modal-content{
      background:var(--bg-card);
      border:1.5px solid var(--border-bright);
      border-radius:1.25rem;
      max-width:950px;
      width:100%;
      max-height:92vh;
      overflow-y:auto;
      box-shadow:var(--shadow-lg);
      animation:fadeIn 0.3s ease;
    }
    
    .modal-header{
      padding:1.75rem 2rem;
      border-bottom:1.5px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:linear-gradient(135deg, rgba(74,158,255,0.08) 0%, transparent 100%);
    }
    
    .modal-title{
      font-size:1.75rem;
      font-weight:800;
      background:linear-gradient(135deg,#ffffff 0%,#93c5fd 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    
    .modal-close{
      background:none;
      border:none;
      color:var(--text-secondary);
      font-size:2rem;
      cursor:pointer;
      padding:.5rem;
      line-height:1;
      transition:color .2s;
    }
    
    .modal-close:hover{
      color:var(--text-primary);
    }
    
    .modal-body{padding:2rem}
    
    .seg{
      display:inline-flex;
      border:1.5px solid var(--border);
      border-radius:.625rem;
      overflow:hidden;
      background:var(--bg-secondary);
    }
    
    .seg button{
      background:transparent;
      color:var(--text-secondary);
      border:0;
      border-right:1.5px solid var(--border);
      padding:.625rem 1rem;
      cursor:pointer;
      font-weight:600;
      transition:all .2s;
    }
    
    .seg button:last-child{border-right:0}
    
    .seg button.active{
      color:var(--text-primary);
      background:linear-gradient(135deg, rgba(74,158,255,0.2) 0%, rgba(74,158,255,0.1) 100%);
    }
    
    .seg button[disabled]{opacity:.45;pointer-events:none}
    
    .three-wrap{
      background:#000;
      border:1.5px solid var(--border);
      border-radius:.75rem;
      height:360px;
      position:relative;
    }
    
    .three-hint{
      font-size:.875rem;
      color:var(--text-tertiary);
      margin-top:.75rem;
      font-weight:500;
    }
    
    .tl-controls{
      display:flex;
      align-items:center;
      gap:.75rem;
      flex-wrap:wrap;
      margin-bottom:.75rem;
    }
    
    .tl-controls input[type="range"]{
      width:160px;
      accent-color:var(--accent-primary);
    }
    
    .tl-img{
      width:100%;
      background:#000;
      border-radius:.75rem;
      border:1.5px solid var(--border);
      object-fit:contain;
    }
    
    .no-data{
      display:flex;
      align-items:center;
      justify-content:center;
      height:100%;
      color:var(--text-secondary);
      font-size:1rem;
      background:#111;
      font-weight:500;
    }
    
    .gif-wrap{
      max-height:180px;
      overflow:hidden;
      background:#000;
    }
    
    .gif-wrap img{
      width:100%;
      height:auto;
      display:block;
    }
    
    .status-indicator{
      display:inline-flex;
      align-items:center;
      gap:.625rem;
      padding:.625rem 1.25rem;
      border-radius:2rem;
      font-size:.875rem;
      font-weight:700;
      letter-spacing:0.5px;
    }
    
    .status-dot{
      width:10px;
      height:10px;
      border-radius:50%;
      animation:pulse 2s infinite;
    }
    
    @keyframes pulse{
      0%,100%{opacity:1;transform:scale(1)}
      50%{opacity:.5;transform:scale(0.9)}
    }
    
    .status-indicator.online{
      background:rgba(34,197,94,.15);
      color:var(--success);
    }
    
    .status-indicator.online .status-dot{
      background:var(--success);
      box-shadow:0 0 8px var(--success);
    }
    
    .status-indicator.offline{
      background:rgba(239,68,68,.15);
      color:var(--danger);
    }
    
    .status-indicator.offline .status-dot{
      background:var(--danger);
    }
    
    .refresh-timer{
      display:flex;
      align-items:center;
      gap:.625rem;
      color:var(--text-secondary);
      font-size:.875rem;
      font-weight:500;
    }
    
    .countdown{
      font-weight:700;
      color:var(--accent-primary);
      font-size:1rem;
    }
    
    .notification{
      position:fixed;
      bottom:1.5rem;
      right:1.5rem;
      background:linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      color:#fff;
      padding:1rem 1.75rem;
      border-radius:.75rem;
      box-shadow:var(--shadow-lg);
      z-index:10000;
      font-weight:700;
      animation:slideIn .3s ease;
    }
    
    @keyframes slideIn{
      0%{transform:translateY(100%);opacity:0}
      100%{transform:translateY(0);opacity:1}
    }
    
    @media (max-width:768px){
      .header-content{flex-direction:column;align-items:flex-start}
      .controls-grid{grid-template-columns:1fr}
      .candidates-grid{grid-template-columns:1fr}
      .live-feed{grid-template-columns:1fr}
      .header-title h1{font-size:1.75rem}
      .section-title{font-size:1.4rem}
      .stat-value{font-size:2rem}
      .btn{padding:.75rem 1.25rem;font-size:.85rem}
      .container{padding:0 1rem}
      .controls-bar{padding:1.5rem 0}
      .modal{padding:1rem}
      .modal-content{max-width:90vw}
      .three-wrap{height:240px}
      .gif-wrap{max-height:120px}
    }
  </style>
</head>
<body>

<header class="header">
  <div class="container">
    <div class="header-content">
      <div class="header-title">
        <h1>SOHO Comet Hunter 3.6</h1>
        <div class="header-subtitle">Professional Comet Detection Dashboard</div>
        <div class="header-partners">
          A collaboration between <a href="https://ournightsky.us" target="_blank">OurNightSky.US</a> √ó <a href="https://nagohcreative.com" target="_blank">NagohCreative.com</a>
        </div>
      </div>
      <div class="header-actions">
        <div class="status-indicator online" id="wsStatus"><span class="status-dot"></span><span>Live</span></div>
        <button class="btn btn-primary" id="refreshBtn">Refresh</button>
        <a href="https://github.com/NAGOHUSA/ONS_SOHOHUNTER" target="_blank" class="btn btn-secondary">GitHub</a>
      </div>
    </div>
  </div>
</header>

<div class="controls-bar">
  <div class="container">
    <div class="controls-grid">
      <div class="control-group">
        <label class="control-label">Detection Report</label>
        <div class="select-wrapper">
          <select id="reportSelect"><option value="">Loading reports...</option></select>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label">Candidate</label>
        <div class="select-wrapper">
          <select id="candidateSelect"><option value="">All candidates</option></select>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label">Actions</label>
        <div style="display:flex;gap:.5rem;">
          <button class="btn btn-secondary btn-sm" id="exportTxtBtn">Export TXT</button>
          <button class="btn btn-secondary btn-sm" id="exportCsvBtn">Export CSV</button>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label">Auto-Refresh</label>
        <div class="refresh-timer">Next update in <span class="countdown" id="countdown">5:00</span></div>
      </div>
    </div>

    <div class="filters">
      <label class="filter-chip"><input type="checkbox" id="filterC2"><span>C2 Telescope</span></label>
      <label class="filter-chip"><input type="checkbox" id="filterC3"><span>C3 Telescope</span></label>
      <label class="filter-chip"><input type="checkbox" id="filterComet"><span>AI Comet Only</span></label>
      <label class="filter-chip"><input type="checkbox" id="filterMarked"><span>Marked Only</span></label>
      <label class="filter-chip"><input type="checkbox" id="exportMarkedOnly"><span>Export Marked Only</span></label>
    </div>
  </div>
</div>

<main class="container">
  <div class="stats-dashboard" id="statsDashboard">
    <div class="stat-card"><div class="stat-label">Total Detections</div><div class="stat-value" id="statTotal">0</div></div>
    <div class="stat-card highlight"><div class="stat-label">AI Comets</div><div class="stat-value" id="statComets">0</div></div>
    <div class="stat-card"><div class="stat-label">C2 Detections</div><div class="stat-value" id="statC2">0</div></div>
    <div class="stat-card"><div class="stat-label">C3 Detections</div><div class="stat-value" id="statC3">0</div></div>
    <div class="stat-card"><div class="stat-label">Marked Items</div><div class="stat-value" id="statMarked">0</div></div>
  </div>

  <div class="live-feed">
    <div class="feed-card">
      <div class="feed-header">
        <div class="feed-title"><span>LASCO C2</span><span class="badge">LIVE</span></div>
        <a href="https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif" target="_blank" class="btn btn-sm btn-secondary">Open</a>
      </div>
      <div class="feed-content"><img id="c2LiveGif" src="https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif" alt="LASCO C2 Live"></div>
      <div class="feed-footer"><span>Last Updated:</span><span id="c2Timestamp">--:--</span></div>
    </div>
    <div class="feed-card">
      <div class="feed-header">
        <div class="feed-title"><span>LASCO C3</span><span class="badge">LIVE</span></div>
        <a href="https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif" target="_blank" class="btn btn-sm btn-secondary">Open</a>
      </div>
      <div class="feed-content"><img id="c3LiveGif" src="https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif" alt="LASCO C3 Live"></div>
      <div class="feed-footer"><span>Last Updated:</span><span id="c3Timestamp">--:--</span></div>
    </div>
  </div>

  <div class="candidates-section">
    <div class="section-header">
      <h2 class="section-title">Detection Candidates</h2>
      <div id="filterCount" class="stat-label"></div>
    </div>
    <div id="candidatesGrid" class="candidates-grid"></div>
    <div id="emptyState" class="empty-state" style="display:none;">
      <div class="empty-state-icon">üîç</div>
      <div class="empty-state-title">No Candidates Found</div>
      <p>Try adjusting your filters or select a different report</p>
    </div>
    <div id="loadingState" style="display:none;"><div class="spinner"></div></div>
  </div>
</main>

<!-- Modal -->
<div class="modal" id="candidateModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Candidate Details</h3>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
// ---------- CONFIG ----------
const HIDE_NOT_COMET = true;
const CONFIG = { repo:'NAGOHUSA/ONS_SOHOHUNTER', branch:'main', folder:'detections' };
const API_URL = `https://api.github.com/repos/${CONFIG.repo}/contents/${CONFIG.folder}?ref=${CONFIG.branch}`;

// ---------- RAW URL ----------
const RAW_URL = (path) => {
  if (!path) return '';
  let p = String(path).trim().replace(/^\.?\/*/, '');
  if (p.startsWith('http')) return p;
  return `https://raw.githubusercontent.com/${CONFIG.repo}/${CONFIG.branch}/detections/${p}`;
};

// ---------- STATE ----------
let allCandidates = [];
let filteredCandidates = [];
let markedIds = new Set();

const els = {
  reportSelect: document.getElementById('reportSelect'),
  candidateSelect: document.getElementById('candidateSelect'),
  refreshBtn: document.getElementById('refreshBtn'),
  exportTxtBtn: document.getElementById('exportTxtBtn'),
  exportCsvBtn: document.getElementById('exportCsvBtn'),
  filterC2: document.getElementById('filterC2'),
  filterC3: document.getElementById('filterC3'),
  filterComet: document.getElementById('filterComet'),
  filterMarked: document.getElementById('filterMarked'),
  exportMarkedOnly: document.getElementById('exportMarkedOnly'),
  candidatesGrid: document.getElementById('candidatesGrid'),
  emptyState: document.getElementById('emptyState'),
  loadingState: document.getElementById('loadingState'),
  countdown: document.getElementById('countdown'),
  statTotal: document.getElementById('statTotal'),
  statComets: document.getElementById('statComets'),
  statC2: document.getElementById('statC2'),
  statC3: document.getElementById('statC3'),
  statMarked: document.getElementById('statMarked'),
  filterCount: document.getElementById('filterCount'),
  c2LiveGif: document.getElementById('c2LiveGif'),
  c3LiveGif: document.getElementById('c3LiveGif'),
  c2Timestamp: document.getElementById('c2Timestamp'),
  c3Timestamp: document.getElementById('c3Timestamp')
};

// ---------- HELPERS ----------
const formatDate = (s) => s ? new Date(s).toLocaleString(undefined,{dateStyle:'medium',timeStyle:'short'}) : 'N/A';
const getTelescope = (c) => (c.instrument || 'unknown').toUpperCase();

function normalizeCandidate(c, idx){
  const telescope = getTelescope(c);
  const id = `${telescope}#${c.track_id ?? idx}`;
  const ann = c.annotated_path || c.paths?.annotated;
  const orig = c.original_path || c.paths?.original;
  const crop = c.crop_path || c.paths?.crop;

  return {
    id, telescope,
    label: String(c.ai_label || 'unknown').toLowerCase(),
    score: c.ai_score ?? 0,
    timestamp: c.timestamp || '',
    bbox: c.bbox || [],
    cropPath: crop || '',
    gifCrop: c.animation_gif_crop || '',
    gifAnn: c.animation_gif_ann || '',
    originalPath: orig || '',
    annotatedPath: ann || '',
    thumbnail: c.thumbnail_path || crop || '',
    positions: c.positions || [],
    imageSize: c.image_size || null,
    trackIndex: c.track_id ?? idx,
    raw: c
  };
}

function getTrackGroup(candidate){
  return allCandidates
    .filter(x => (x.trackIndex === candidate.trackIndex) && (x.telescope === candidate.telescope))
    .sort((a,b) => (a.timestamp||'').localeCompare(b.timestamp||''));
}

// ---------- LOAD ----------
async function loadReports(){
  try{
    const r = await fetch(API_URL);
    const files = await r.json();
    const reports = files.filter(f=>f.name.startsWith('candidates_') && f.name.endsWith('.json'))
                         .sort((a,b)=> b.name.localeCompare(a.name));
    els.reportSelect.innerHTML = '<option value="">Select a report...</option>';
    for (const report of reports){
      const o=document.createElement('option');
      o.value=report.name; o.textContent=report.name.replace('candidates_','').replace('.json','');
      els.reportSelect.appendChild(o);
    }
    if (reports.length) {
      els.reportSelect.value = reports[0].name;
      await loadReport(reports[0].name);
    } else {
      els.reportSelect.innerHTML = '<option value="">No reports found</option>';
    }
  }catch(e){ console.error('Failed to load reports:', e);
    els.reportSelect.innerHTML = '<option value="">Error loading reports</option>';
  }
}

async function loadReport(reportName){
  if(!reportName) return;
  els.loadingState.style.display='block';
  els.candidatesGrid.innerHTML='';
  els.emptyState.style.display='none';
  try{
    const r = await fetch(RAW_URL(reportName));
    const data = await r.json();
    allCandidates = data.map(normalizeCandidate);
    updateCandidateDropdown();
    applyFilters();
    updateStats();
    updateLiveFeeds();
  }catch(e){
    console.error('Failed to load report:', e);
    els.emptyState.style.display='block';
  }finally{ els.loadingState.style.display='none'; }
}

function updateCandidateDropdown(){
  els.candidateSelect.innerHTML = '<option value="">All candidates</option>';
  for (const c of allCandidates){
    const o=document.createElement('option');
    o.value=c.id; o.textContent=`${c.id} ‚Äì ${c.label.toUpperCase()} (${(c.score*100).toFixed(1)}%)`;
    els.candidateSelect.appendChild(o);
  }
}

// ---------- FILTER / RENDER ----------
function applyFilters() {
  const c2 = els.filterC2.checked;
  const c3 = els.filterC3.checked;
  const comet = els.filterComet.checked;
  const marked = els.filterMarked.checked;
  const selectedId = els.candidateSelect.value;

  filteredCandidates = allCandidates.filter(candidate => {
    if (selectedId && candidate.id !== selectedId) return false;
    if (c2 && candidate.telescope !== 'LASCO C2') return false;
    if (c3 && candidate.telescope !== 'LASCO C3') return false;
    if (comet && candidate.label !== 'comet') return false;
    if (marked && !markedIds.has(candidate.id)) return false;
    return true;
  });

  renderCandidates();
  updateFilterCount();
}

function renderCandidates() {
  const visible = HIDE_NOT_COMET
    ? filteredCandidates.filter(c => c.label !== 'not_comet')
    : filteredCandidates;

  if (!visible.length) {
    els.candidatesGrid.innerHTML = '';
    els.emptyState.style.display = 'block';
    return;
  }

  els.emptyState.style.display = 'none';
  els.candidatesGrid.innerHTML = visible.map(renderCard).join('');

  document.querySelectorAll('.candidate-card').forEach(card => {
    const id = card.dataset.id;
    card.querySelector('.mark-btn')?.addEventListener('click', e => { e.stopPropagation(); toggleMark(id); });
    card.addEventListener('click', () => showCandidateDetail(id));
  });
}

function updateFilterCount() {
  const hidden = HIDE_NOT_COMET
    ? filteredCandidates.filter(c => c.label === 'not_comet').length
    : 0;
  const shown = filteredCandidates.length - hidden;
  els.filterCount.textContent = `Showing ${shown} of ${allCandidates.length} candidates${hidden ? ` (${hidden} hidden as not_comet)` : ''}`;
}

function renderCard(c){
  const isMarked = markedIds.has(c.id);
  const thumb = c.thumbnail ? RAW_URL(c.thumbnail) : '';
  const hasGif = c.gifCrop || c.gifAnn;
  return `
  <div class="candidate-card ${isMarked?'marked':''}" data-id="${c.id}">
    ${thumb ? `<img src="${thumb}" alt="${c.id}" class="candidate-image">` : ''}
    ${hasGif ? `
    <div class="gif-wrap" style="border-top:1px solid var(--border);">
      ${c.gifAnn ? `<img src="${RAW_URL(c.gifAnn)}" alt="Annotated GIF" loading="lazy">` :
           c.gifCrop ? `<img src="${RAW_URL(c.gifCrop)}" alt="Crop GIF" loading="lazy">` : ''}
    </div>` : ''}
    <div class="candidate-body">
      <div class="candidate-header">
        <div class="candidate-id">${c.id}</div>
        <div class="candidate-score">
          <span class="score-badge ${c.label}">${c.label.toUpperCase()}</span>
          <span class="score-value">${(c.score*100).toFixed(1)}%</span>
        </div>
      </div>
      <div class="candidate-meta">
        <div class="meta-item"><span class="meta-label">Telescope</span><span class="meta-value">${c.telescope}</span></div>
        <div class="meta-item"><span class="meta-label">Track ID</span><span class="meta-value">${c.trackIndex ?? 'N/A'}</span></div>
        <div class="meta-item"><span class="meta-label">Timestamp</span><span class="meta-value">${formatDate(c.timestamp)}</span></div>
        <div class="meta-item"><span class="meta-label">Position</span><span class="meta-value">${c.bbox.length>=2?`${c.bbox[0]}, ${c.bbox[1]}`:'N/A'}</span></div>
      </div>
      <div class="candidate-actions">
        <button class="action-btn mark-btn ${isMarked?'marked-btn':''}">${isMarked?'Marked':'Mark'}</button>
        <button class="action-btn" onclick="event.stopPropagation(); showCandidateDetail('${c.id}')">Details</button>
      </div>
    </div>
  </div>`;
}

function toggleMark(id){ 
  if(markedIds.has(id)) markedIds.delete(id); 
  else markedIds.add(id); 
  applyFilters(); 
  updateStats(); 
}

// ---------- MODAL ----------
function showCandidateDetail(id){
  const c = allCandidates.find(x=>x.id===id); if(!c) return;
  const modal = document.getElementById('candidateModal');
  const title = document.getElementById('modalTitle');
  const body = document.getElementById('modalBody');
  title.textContent = `Candidate: ${c.id}`;

  const srcMap = {
    ann: c.annotatedPath ? RAW_URL(c.annotatedPath) : '',
    orig: c.originalPath ? RAW_URL(c.originalPath) : '',
    crop: c.cropPath ? RAW_URL(c.cropPath) : ''
  };
  const firstMode = srcMap.ann ? 'ann' : (srcMap.orig ? 'orig' : 'crop');
  const sequence = getTrackGroup(c);

  body.innerHTML = `
    <div style="display:grid;gap:1.25rem;">
      <div>
        <div class="seg" id="imgSeg">
          <button data-mode="ann" data-src="${srcMap.ann}">Annotated</button>
          <button data-mode="orig" data-src="${srcMap.orig}">Original</button>
          <button data-mode="crop" data-src="${srcMap.crop}">Cropped</button>
        </div>
        <div style="margin-top:.75rem;">
          <img id="segImg" src="${srcMap[firstMode] || ''}" class="tl-img" alt="candidate">
        </div>
      </div>

      ${(c.gifCrop || c.gifAnn) ? `
      <div>
        <h4 style="margin-bottom:.5rem;">Animation GIF</h4>
        ${c.gifAnn ? `<img src="${RAW_URL(c.gifAnn)}" style="width:100%;border-radius:.5rem;background:#000;" loading="lazy">` :
           c.gifCrop ? `<img src="${RAW_URL(c.gifCrop)}" style="width:100%;border-radius:.5rem;background:#000;" loading="lazy">` : ''}
      </div>` : ''}

      <div>
        <h4 style="margin-bottom:.5rem;">Time-lapse</h4>
        <div class="tl-controls">
          <div class="seg" id="tlSeg">
            <button data-mode="ann">Annotated</button>
            <button data-mode="orig">Original</button>
            <button data-mode="crop">Cropped</button>
          </div>
          <button id="tlPlay" class="btn btn-secondary btn-sm">Play</button>
          <button id="tlPrev" class="btn btn-secondary btn-sm">Prev</button>
          <button id="tlNext" class="btn btn-secondary btn-sm">Next</button>
          <label class="control-label" style="margin-left:.5rem;">FPS</label>
          <input id="tlFps" type="range" min="1" max="12" value="4" />
          <span id="tlFpsVal" class="stat-label">4 fps</span>
          <span class="stat-label" id="tlCounter"></span>
        </div>
        <img id="tlImg" class="tl-img" alt="timelapse">
      </div>

      ${(c.positions && c.positions.length > 0) ? `
      <div>
        <h4 style="margin-bottom:.5rem;">3D Track Viewer</h4>
        <div class="three-wrap" id="threeWrap"></div>
        <div class="three-hint">Drag to orbit ‚Ä¢ Points extruded over time</div>
      </div>` : ''}

      <div>
        <h4 style="margin-bottom:.5rem;">Details</h4>
        <div style="background:var(--bg-secondary);padding:1rem;border-radius:.5rem;font-size:.9rem;">
          <div style="display:grid;grid-template-columns:150px 1fr;gap:.5rem;">
            <strong>ID:</strong><span>${c.id}</span>
            <strong>Telescope:</strong><span>${c.telescope}</span>
            <strong>AI Label:</strong><span>${c.label.toUpperCase()}</span>
            <strong>AI Score:</strong><span>${(c.score*100).toFixed(2)}%</span>
            <strong>Timestamp:</strong><span>${formatDate(c.timestamp)}</span>
            <strong>Track ID:</strong><span>${c.trackIndex ?? 'N/A'}</span>
            <strong>Image Size:</strong><span>${c.imageSize ? `${c.imageSize[0]}√ó${c.imageSize[1]}` : 'N/A'}</span>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:.5rem;">
        <button class="btn btn-primary" onclick="toggleMark('${c.id}'); closeModal(); applyFilters();">${markedIds.has(c.id)?'Unmark':'Mark'}</button>
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
      </div>
    </div>
  `;

  const seg = body.querySelector('#imgSeg');
  const segImg = body.querySelector('#segImg');
  seg.querySelectorAll('button').forEach(b=>{
    const src = (b.dataset.src||'').trim();
    if (!src) b.disabled = true;
    b.classList.toggle('active', b.dataset.mode === firstMode);
  });
  seg.addEventListener('click', e => {
    const btn = e.target.closest('button'); if (!btn || btn.disabled) return;
    seg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    const src = btn.dataset.src.trim();
    if (src) segImg.src = `${src}#${Date.now()}`;
  });

  initTimelapse(body, sequence, firstMode);
  if (c.positions && c.positions.length > 0) initThreeTrack(body.querySelector('#threeWrap'), c);
  modal.classList.add('active');
}

function closeModal(){ document.getElementById('candidateModal').classList.remove('active'); }

// ---------- TIME-LAPSE ----------
function initTimelapse(scopeEl, sequence, defaultMode){
  const img = scopeEl.querySelector('#tlImg');
  const seg = scopeEl.querySelector('#tlSeg');
  const playBtn = scopeEl.querySelector('#tlPlay');
  const prevBtn = scopeEl.querySelector('#tlPrev');
  const nextBtn = scopeEl.querySelector('#tlNext');
  const fpsRange = scopeEl.querySelector('#tlFps');
  const fpsVal = scopeEl.querySelector('#tlFpsVal');
  const counter = scopeEl.querySelector('#tlCounter');

  const framesFor = (mode)=> sequence
    .map(s => mode==='ann' ? s.annotatedPath : mode==='orig' ? s.originalPath : s.cropPath)
    .map(p => p ? RAW_URL(p) : '')
    .filter(Boolean);

  ['ann','orig','crop'].forEach(m=>{
    const btn = seg.querySelector(`button[data-mode="${m}"]`);
    const available = framesFor(m).length > 0;
    if (!available) btn.disabled = true;
  });

  let mode = defaultMode || 'crop';
  if (framesFor(mode).length === 0) mode = ['ann','orig','crop'].find(m=>framesFor(m).length>0) || 'crop';
  seg.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));

  let frames = framesFor(mode);
  let idx = 0;
  let timer = null;
  let fps = parseInt(fpsRange.value,10);

  function show(i){
    if (!frames.length){ img.style.display='none'; counter.textContent=''; return; }
    img.style.display='block';
    idx = (i+frames.length) % frames.length;
    img.src = `${frames[idx]}#${Date.now()}`;
    counter.textContent = `${idx+1}/${frames.length} ‚Äì ${formatDate(sequence[idx].timestamp || '')}`;
  }

  function play(){
    if (timer) return;
    playBtn.textContent = 'Pause';
    timer = setInterval(()=> show(idx+1), 1000/Math.max(1,fps));
  }
  function pause(){
    if (!timer) return;
    clearInterval(timer); timer=null;
    playBtn.textContent = 'Play';
  }

  seg.addEventListener('click', e=>{
    const btn = e.target.closest('button'); if (!btn || btn.disabled) return;
    seg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    mode = btn.dataset.mode;
    frames = framesFor(mode);
    idx = 0;
    pause();
    show(0);
  });

  playBtn.onclick = ()=> timer ? pause() : play();
  prevBtn.onclick = ()=> { pause(); show(idx-1); };
  nextBtn.onclick = ()=> { pause(); show(idx+1); };
  fpsRange.oninput = ()=> { fps = parseInt(fpsRange.value,10); fpsVal.textContent = `${fps} fps`; if (timer){ pause(); play(); } };

  show(0);
}

// ---------- 3D VIEWER ----------
function initThreeTrack(host, c){
  host.innerHTML = '';
  const width = host.clientWidth, height = host.clientHeight || 360;
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, width/height, 0.1, 1000);
  camera.position.set(0,0,2.5);

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(width,height);
  renderer.setClearColor(0x000000);
  host.appendChild(renderer.domElement);

  const pts = (c.positions || []).map(p=>({x:p.x,y:p.y})).filter(p=>typeof p.x==='number'&&typeof p.y==='number');

  if (pts.length < 1) {
    const msg = document.createElement('div');
    msg.textContent = 'No position data';
    msg.className = 'no-data';
    host.appendChild(msg);
    return;
  }

  if (pts.length===1){
    const geo = new THREE.SphereGeometry(0.05,16,16);
    const mat = new THREE.MeshBasicMaterial({color:0x00ff00});
    scene.add(new THREE.Mesh(geo,mat));
  }else{
    const [W,H] = c.imageSize||[1024,1024];
    const toN = (x,y)=>[(x/W)*2-1, -((y/H)*2-1)];
    const pos = [];
    pts.forEach((p,i)=>{
      const [nx,ny] = toN(p.x,p.y);
      const nz = (i/(pts.length-1))*0.8-0.4;
      pos.push(nx,ny,nz);
    });
    const lineGeom = new THREE.BufferGeometry();
    lineGeom.setAttribute('position', new THREE.Float32BufferAttribute(pos,3));
    scene.add(new THREE.Line(lineGeom, new THREE.LineBasicMaterial({color:0x00ffd0})));

    const pointVecs = [];
    for (let i=0;i<pos.length;i+=3) pointVecs.push(new THREE.Vector3(pos[i],pos[i+1],pos[i+2]));
    const ptsGeom = new THREE.BufferGeometry().setFromPoints(pointVecs);
    scene.add(new THREE.Points(ptsGeom, new THREE.PointsMaterial({size:0.03,color:0xffff00})));
  }

  scene.add(new THREE.AmbientLight(0xffffff,0.9));

  let isDown=false,lastX=0,lastY=0,rx=0.3,ry=0.6;
  const down=e=>{isDown=true;lastX=e.clientX;lastY=e.clientY;};
  const up=()=>{isDown=false;};
  const move=e=>{if(!isDown)return;const dx=(e.clientX-lastX)/200,dy=(e.clientY-lastY)/200;ry+=dx;rx+=dy;lastX=e.clientX;lastY=e.clientY;};
  host.addEventListener('mousedown',down);
  host.addEventListener('touchstart',e=>{const t=e.touches[0];lastX=t.clientX;lastY=t.clientY;isDown=true;});
  window.addEventListener('mouseup',up);
  window.addEventListener('touchend',up);
  window.addEventListener('mousemove',move);
  window.addEventListener('touchmove',e=>{if(!isDown)return;const t=e.touches[0];move({clientX:t.clientX,clientY:t.clientY});});

  function animate(){requestAnimationFrame(animate);scene.rotation.set(rx,ry,0);renderer.render(scene,camera);}
  animate();

  new ResizeObserver(()=>{const w=host.clientWidth,h=host.clientHeight||360;renderer.setSize(w,h,false);camera.aspect=w/h;camera.updateProjectionMatrix();}).observe(host);
}

// ---------- STATS / LIVE ----------
function updateStats(){
  const total=allCandidates.length;
  const comets=allCandidates.filter(c=>c.label==='comet').length;
  const c2=allCandidates.filter(c=>c.telescope==='LASCO C2').length;
  const c3=allCandidates.filter(c=>c.telescope==='LASCO C3').length;
  const marked=[...markedIds].filter(id=>allCandidates.some(c=>c.id===id)).length;
  els.statTotal.textContent=total; els.statComets.textContent=comets; els.statC2.textContent=c2; els.statC3.textContent=c3; els.statMarked.textContent=marked;
}

async function updateLiveFeeds(){
  const feeds = [
    {url:'https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif',el:els.c2LiveGif,ts:els.c2Timestamp},
    {url:'https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif',el:els.c3LiveGif,ts:els.c3Timestamp}
  ];
  for(const f of feeds){
    try{
      const r=await fetch(f.url,{method:'HEAD'});
      const lm=r.headers.get('last-modified');
      if(lm) f.ts.textContent=new Date(lm).toLocaleTimeString();
      f.el.src=`${f.url}?t=${Date.now()}`;
    }catch(e){console.error('feed error',e);}
  }
}

// ---------- EXPORTS ----------
function exportTXT(){
  const list = els.exportMarkedOnly.checked ? allCandidates.filter(c=>markedIds.has(c.id)) : allCandidates;
  const lines = list.map(c=>[c.id, c.label.toUpperCase(), `${(c.score*100).toFixed(1)}%`, c.telescope, formatDate(c.timestamp), c.bbox.slice(0,2).join(', ')||'N/A'].join('\t'));
  const blob = new Blob([lines.join('\n')],{type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`soho_export_${Date.now()}.txt`; a.click();
}
function exportCSV(){
  const list = els.exportMarkedOnly.checked ? allCandidates.filter(c=>markedIds.has(c.id)) : allCandidates;
  const header = ['ID','Label','Score','Telescope','Timestamp','Track_ID','X','Y','Crop_Path'];
  const rows = list.map(c=>[c.id,c.label.toUpperCase(),(c.score*100).toFixed(1),c.telescope,c.timestamp||'N/A',c.trackIndex??'N/A',c.bbox[0]??'',c.bbox[1]??'',c.cropPath||'']);
  const csv = [header,...rows].map(r=>r.join(',')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`soho_export_${Date.now()}.csv`; a.click();
}

// ---------- COUNTDOWN ----------
let countdownInterval;
function startCountdown(){
  let seconds = 300;
  clearInterval(countdownInterval);
  countdownInterval = setInterval(()=>{
    seconds--;
    const m=Math.floor(seconds/60), s=String(seconds%60).padStart(2,'0');
    els.countdown.textContent=`${m}:${s}`;
    if(seconds<=0){ loadReports(); seconds=300; }
  },1000);
}

// ---------- EVENTS ----------
els.reportSelect.addEventListener('change', e=>loadReport(e.target.value));
els.candidateSelect.addEventListener('change', applyFilters);
els.refreshBtn.addEventListener('click', ()=>{ loadReports(); startCountdown(); });
els.exportTxtBtn.addEventListener('click', exportTXT);
els.exportCsvBtn.addEventListener('click', exportCSV);
[els.filterC2, els.filterC3, els.filterComet, els.filterMarked].forEach(cb=>cb.addEventListener('change', applyFilters));
document.getElementById('candidateModal').addEventListener('click', e=>{ if(e.target.id==='candidateModal') closeModal(); });

// ---------- INIT ----------
loadReports();
startCountdown();
setInterval(updateLiveFeeds, 120000);
</script>
</body>
</html>
