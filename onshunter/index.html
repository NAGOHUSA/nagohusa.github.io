<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SOHO Comet Hunter – Nagoh Creative</title>
<meta name="description" content="Live NASA LASCO animations, AI-detected comets and Sungrazer-ready exports – built by Nagoh Creative for OurNightSky.Us">
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0b1220; --panel:#0f1b30; --muted:#94a3b8; --text:#e6eefc; --accent:#60a5fa;
    --chip:#1e293b; --card:#0d1526; --shadow:0 8px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),#0b1220f0 80%,#0b122000);backdrop-filter:blur(6px);border-bottom:1px solid #1e293b}
  .wrap{max-width:1240px;margin:auto;padding:14px 16px}
  h1{font-size:1.35rem;font-weight:800;letter-spacing:.3px}
  .sub{font-size:.85rem;color:var(--muted)}
  .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-top:12px}
  button,.sel,input[type=checkbox]{cursor:pointer}
  button{border:1px solid #243244;background:#0e1a2b;color:var(--text);padding:8px 14px;border-radius:12px;font-weight:700;box-shadow:var(--shadow)}
  button:hover{border-color:#33508a}
  .sel{background:#0e1a2b;border:1px solid #243244;border-radius:12px;padding:6px 10px;color:var(--text);min-width:160px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #1e293b;padding:4px 8px;border-radius:999px;font-size:.8rem;color:var(--muted)}
  .pill input{accent-color:var(--accent)}
  .right{margin-left:auto}
  main{padding:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
  .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
  .thumb{aspect-ratio:1.6/1;width:100%;background:#0b1220;object-fit:contain;display:block}
  .meta{padding:12px;flex:1;display:flex;flex-direction:column;gap:8px}
  .kvs{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:.8rem;color:var(--muted)}
  .kv b{color:var(--text)}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .stats{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
  .stat{background:var(--panel);border:1px solid #1e293b;border-radius:12px;padding:8px 12px}
  .stat b{font-size:1.1rem}
  .empty{padding:40px;text-align:center;color:var(--muted);border:1px dashed #253044;border-radius:16px;background:#0b1220}
  .err{color:#ffb4b4}
  .thumbRow{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:12px}
  .thumbCard{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden}
  .thumbHead{padding:10px 12px;border-bottom:1px solid #1e293b;display:flex;align-items:center;gap:10px}
  .gifRow{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:16px;margin-top:12px}
  .gifCard{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden}
  .gifHead{padding:10px 12px;border-bottom:1px solid #1e293b;display:flex;gap:10px;align-items:center}
  .gif{display:block;width:100%;background:#0b1220;aspect-ratio:1/1;object-fit:contain}
  .exportAll{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:.75rem}
  .mark{display:flex;gap:6px;align-items:center}
  .flag{padding:4px 8px;border-radius:10px;border:1px solid #1e293b;background:#13223a}
  .flag.on(background:#11351d;border-color:#1d4d2a;color:#b5f7c0)
  .group{background:#0e1a2b;border:1px solid #243244;border-radius:10px;padding:4px 6px;color:var(--text);font-size:.75rem}
  .seg{display:inline-flex;border:1px solid #27324a;border-radius:10px;overflow:hidden;background:#0e1a2b}
  .seg button{border:0;border-right:1px solid #27324a;background:transparent;color:#cbd5e1;padding:6px 10px;font-size:.75rem}
  .seg button:last-child{border-right:0}
  .seg button.active{background:#1b2a46;color:#e6eefc}
  .video-container{margin-top:12px;border:1px solid #1e293b;border-radius:12px;overflow:hidden;background:#0b1220}
  .video-container video{width:100%;display:block;background:#000}
  footer{font-size:.75rem;color:var(--muted);padding:20px 0;text-align:center}
  .gif, .thumb { transition: opacity .2s; }
  .gif:hover, .thumb:hover { opacity: .9; }
  .card { transition: transform .15s, box-shadow .15s; }
  .card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,.5); }
  .gif:not([src]), .thumb:not([src]) {
    background: linear-gradient(90deg, #0f1b30 25%, #1a2332 50%, #0f1b30 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }
  @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  button, .seg button { transition: all .15s; }
  button:focus-visible, .seg button:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
  .thumb { cursor: zoom-in; }
  .thumb:hover { transform: scale(1.05); }
  .orbit-btn { background: #1e293b; color: #60a5fa; padding: 6px 10px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; margin-top: 6px; display: inline-block; }
  .orbit-btn:hover { background: #334155; }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>SOHO Comet Hunter 1.6</h1>
    <div class="sub">Live NASA LASCO animations • AI-detected comets • Sungrazer-ready exports</div>
    <div class="controls">
      <button id="refreshBtn">Refresh</button>

      <select id="latestSelect" class="sel"><option value="">— Latest Report —</option></select>
      <select id="hitsSelect"   class="sel"><option value="">— Potential Hits —</option></select>

      <label class="pill"><input type="checkbox" id="c2Filter"> C2</label>
      <label class="pill"><input type="checkbox" id="c3Filter"> C3</label>
      <label class="pill"><input type="checkbox" id="aiOnly"> AI='comet' only</label>
      <label class="pill"><input type="checkbox" id="markedOnly"> Marked only</label>

      <label class="pill"><input type="checkbox" id="darkMode"> Dark Mode</label>

      <div class="right pill">Auto-refresh: <span id="refreshEta">—</span></div>

      <div class="exportAll">
        <button id="exportAllBtn">Export ALL</button>
        <label class="pill"><input type="checkbox" id="exportMarkedOnly"> Marked only</label>
        <a id="downloadAllTxt" class="pill" href="#" download style="display:none;">TXT</a>
        <a id="downloadAllCsv" class="pill" href="#" download style="display:none;">CSV</a>
        <button id="markAllComet">Mark All as Comet</button>
        <button id="clearMarks">Clear Marks</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">

  <div id="liveStats" style="position:fixed;top:16px;right:16px;background:var(--panel);padding:8px 12px;border-radius:12px;font-size:.8rem;color:var(--text);z-index:9;">
    <span id="frameCount">—</span> frames • <span id="candCount">—</span> tracks
  </div>

  <section id="status">
    <div class="row">
      <div>Current view: <b id="viewName">—</b> <span class="sub" id="reportTime"></span></div>
    </div>
    <div class="stats" id="stats"></div>
  </section>

  <section aria-label="Live LASCO animations" style="margin-top:20px;">
    <div class="gifRow">
      <div class="gifCard">
        <div class="gifHead">
          <span class="pill">C2 – Live GIF</span>
          <a class="sub" href="https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif" target="_blank" rel="noopener">open</a>
          <span class="right sub" id="c2GifTime"></span>
        </div>
        <img id="c2Gif" class="gif" alt="SOHO LASCO C2 live animation">
      </div>
      <div class="gifCard">
        <div class="gifHead">
          <span class="pill">C3 – Live GIF</span>
          <a class="sub" href="https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif" target="_blank" rel="noopener">open</a>
          <span class="right sub" id="c3GifTime"></span>
        </div>
        <img id="c3Gif" class="gif" alt="SOHO LASCO C3 live animation">
      </div>
    </div>
  </section>

  <section style="margin-top:20px;">
    <div class="thumbRow" id="lastFramesRow"></div>
    <div class="empty" id="errors" style="margin-top:12px;display:none;"></div>
  </section>

  <section id="content" style="margin-top:24px;">
    <div class="empty" id="empty">Loading latest detections from GitHub…</div>
    <div class="grid" id="grid" hidden></div>
  </section>

  <footer>
    <div>Built by <a href="https://nagohcreative.com" target="_blank" rel="noopener">Nagoh Creative</a> for <a href="https://ournightsky.us" target="_blank" rel="noopener">OurNightSky.Us</a></div>
    <div style="font-size:.7rem;margin-top:8px;">
      <b>Shortcuts:</b> R=Refresh • A=Export All • M=Marked Only • 1=C2 • 2=C3
    </div>
  </footer>
</main>

<script>
/* ==================== CONFIG ==================== */
const OWNER  = "NAGOHUSA";
const REPO   = "ONS_SOHOHUNTER";
const BRANCH = "main";
const FOLDER = "detections";
const REFRESH_SECS = 15 * 60;
/* =============================================== */

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

const el = {
  grid:$('#grid'), empty:$('#empty'), errors:$('#errors'),
  viewName:$('#viewName'), reportTime:$('#reportTime'), stats:$('#stats'),
  latestSelect:$('#latestSelect'), hitsSelect:$('#hitsSelect'),
  c2Filter:$('#c2Filter'), c3Filter:$('#c3Filter'), aiOnly:$('#aiOnly'), markedOnly:$('#markedOnly'),
  lastFramesRow:$('#lastFramesRow'), c2Gif:$('#c2Gif'), c3Gif:$('#c3Gif'),
  c2GifTime:$('#c2GifTime'), c3GifTime:$('#c3GifTime'),
  exportAllBtn:$('#exportAllBtn'), exportMarkedOnly:$('#exportMarkedOnly'),
  downloadAllTxt:$('#downloadAllTxt'), downloadAllCsv:$('#downloadAllCsv'),
  refreshBtn:$('#refreshBtn'), refreshEta:$('#refreshEta'),
  markAllComet:$('#markAllComet'), clearMarks:$('#clearMarks'),
  darkMode:$('#darkMode')
};

let currentReport = null;
let refreshTimer = null, countdown = REFRESH_SECS;

const LS_MARKS = 'soho_marks', LS_GROUPS = 'soho_groups';
const marks = () => JSON.parse(localStorage.getItem(LS_MARKS) || '{}');
const groups = () => JSON.parse(localStorage.getItem(LS_GROUPS) || '{}');
const saveMarks = m => localStorage.setItem(LS_MARKS, JSON.stringify(m));
const saveGroups = g => localStorage.setItem(LS_GROUPS, JSON.stringify(g));
const keyFor = h => `${(h.detector||'').toUpperCase()}#${h.track_index}`;

/* ---------- GITHUB HELPERS ---------- */
const apiListURL = () => `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(FOLDER)}?ref=${encodeURIComponent(BRANCH)}`;

function rawURL(path) {
  const p = String(path || '').replace(/^\/+/, '');
  if (!p) return '';
  if (/^https?:\/\//i.test(p)) return p;
  const rel = p.startsWith('detections/') ? p : `detections/${p}`;
  return `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${rel}`;
}

const freshURL = url => `${url}${url.includes('?') ? '&' : '?'}t=${Date.now()}`;

async function fetchJSON(url, retry = 0){
  try{
    const r = await fetch(url,{headers:{'Accept':'application/vnd.github+json'}});
    if(r.status===429){
      const wait = Math.pow(2,retry)*1000 + 500;
      showError(`Rate-limited – retry in ${Math.round(wait/1000)}s`);
      await new Promise(res=>setTimeout(res,wait));
      return fetchJSON(url,retry+1);
    }
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }catch(e){
    if(retry<3) return fetchJSON(url,retry+1);
    throw e;
  }
}
function showError(msg){ el.errors.style.display='block'; el.errors.innerHTML=`<div class="err">${msg}</div>`; }
function hideError(){ el.errors.style.display='none'; }

/* ---------- UI HELPERS ---------- */
function fmtSec(s){
  const m = Math.floor(s/60), sec = s%60;
  return `${m}:${sec<10?'0':''}${sec}`;
}
function parseReportTime(name){
  const m = name.match(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/);
  if(m){
    const utc = new Date(Date.UTC(m[1],m[2]-1,m[3],m[4],m[5],m[6]));
    return {utc:utc.toISOString(), local:utc.toLocaleString()};
  }
  return null;
}
function seg(opts){
  const seg = document.createElement('div'); seg.className='seg';
  opts.forEach(({label, active, disabled, click})=>{
    const b = document.createElement('button');
    b.textContent = label;
    if(active) b.classList.add('active');
    if(disabled) b.disabled = true;
    else b.onclick = ()=>{ seg.querySelectorAll('button').forEach(b=>b.classList.remove('active')); b.classList.add('active'); click(); };
    seg.appendChild(b);
  });
  return seg;
}
function sungrazerText(h){
  return h.positions.map(p=>`${p.time_utc.replace(/Z$/,'').replace('T',' ')} ${p.x|0} ${p.y|0}`).join('\n');
}
function allSungrazerText(items, name){
  return items.map((h,i)=>`# Candidate ${i+1} (${h.detector.toUpperCase()} Track #${h.track_index})\n${sungrazerText(h)}\n\n`).join('');
}
function allCSV(items){
  return 'detector,track_index,time_utc,x,y\n' +
    items.flatMap(h=>h.positions.map(p=>`${h.detector},${h.track_index},${p.time_utc},${p.x},${p.y}`)).join('\n');
}

/* ---------- ANIMATION WIDGET ---------- */
function animationWidget(h) {
  const annMp4 = h.animation_mp4_path ? rawURL(h.animation_mp4_path) : null;
  const annGif = h.animation_gif_path ? rawURL(h.animation_gif_path) : null;
  const cleanGif = h.animation_gif_clean_path ? rawURL(h.animation_gif_clean_path) : null;
  const wrap = document.createElement('div');
  wrap.className = 'video-container';
  if (!annMp4 && !annGif && !cleanGif) {
    wrap.innerHTML = `<div style="padding:12px;color:#94a3b8;">No animation yet…</div>`;
    return wrap;
  }
  const media = document.createElement(annMp4 ? 'video' : 'img');
  media.className = 'gif';
  media.loop = true;
  if (annMp4) {
    media.muted = true;
    media.playsInline = true;
    media.autoplay = true;
  }
  media.alt = 'Candidate animation';
  media.loading = 'lazy';

  const setSrc = (url, isVideo) => { media.src = `${url}${url.includes('?') ? '&' : '?'}t=${Date.now()}`; if (isVideo) media.load(); };

  const bar = seg([
    { label: 'Annotated', active: !!(annMp4 || annGif), disabled: !(annMp4 || annGif), click: () => setSrc(annMp4 || annGif, !!annMp4) },
    { label: 'Clean', active: !annMp4 && !!cleanGif, disabled: !cleanGif, click: () => setSrc(cleanGif, false) },
  ]);
  bar.style.margin = '8px';

  setSrc(annMp4 || annGif, !!annMp4);

  const open = document.createElement('div');
  open.style = 'padding:6px 10px';
  open.innerHTML = [
    annMp4 ? `<a class="pill" target="_blank" rel="noopener" href="${annMp4}">Open MP4</a>` : '',
    annGif ? `<a class="pill" target="_blank" rel="noopener" href="${annGif}">Open GIF</a>` : '',
    cleanGif ? `<a class="pill" target="_blank" rel="noopener" href="${cleanGif}">Open clean</a>` : ''
  ].filter(Boolean).join(' ');

  wrap.appendChild(bar);
  wrap.appendChild(media);
  wrap.appendChild(open);
  return wrap;
}

/* ---------- FILTERS & STATS ---------- */
function applyFilters(items){
  let f = items;
  if(el.c2Filter.checked) f = f.filter(h=>h.detector==='C2');
  if(el.c3Filter.checked) f = f.filter(h=>h.detector==='C3');
  if(el.aiOnly.checked) f = f.filter(h=>(h.ai_label||'').toLowerCase()==='comet');
  if(el.markedOnly.checked) f = f.filter(h=>marks()[keyFor(h)]);
  return f;
}
function renderStats(items){
  const f = applyFilters(items);
  const stats = [
    {label:'Candidates', val:f.length},
    {label:'C2', val:f.filter(h=>h.detector==='C2').length},
    {label:'C3', val:f.filter(h=>h.detector==='C3').length},
    {label:'Comet AI', val:f.filter(h=>(h.ai_label||'').toLowerCase()==='comet').length},
    {label:'Marked', val:f.filter(h=>marks()[keyFor(h)]).length},
  ];
  el.stats.innerHTML = stats.map(s=>`<div class="stat"><div>${s.label}</div><b>${s.val}</b></div>`).join('');
  $('#liveStats').style.display = f.length ? 'block' : 'none';
  $('#frameCount').textContent = f.length ? `${f.reduce((a,c)=>a+c.positions.length,0)}` : '0';
  $('#candCount').textContent = f.length;
}

/* ---------- RENDER GRID ---------- */
function renderGrid(items){
  renderStats(items);
  items = applyFilters(items);
  el.grid.innerHTML = '';
  el.grid.hidden = !items.length; el.empty.hidden = !!items.length;
  el.empty.textContent = items.length ? '' : 'No candidates match filters.';
  items.forEach((h,i)=>{
    const k = keyFor(h);
    const marked = !!marks()[k];
    const groupVal = groups()[k]||"Unknown";

    const cropURL = h.crop_path ? rawURL(h.crop_path) : null;
    const origURL = h.original_mid_path ? rawURL(h.original_mid_path) : null;
    const annURL  = h.annotated_mid_path ? rawURL(h.annotated_mid_path) : null;

    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.className='thumb'; img.loading='lazy';
    img.src = freshURL(cropURL); img.alt = `candidate ${i+1}`;
    const link = document.createElement('a'); link.href=freshURL(cropURL); link.target='_blank'; link.rel='noopener';
    link.appendChild(img); card.appendChild(link);

    img.onerror = () => { img.alt = '(loading failed)'; img.title = 'Image failed to load'; };

    const segWrap = document.createElement('div'); segWrap.style.padding='0 12px 8px';
    const segToggle = seg([
      {label:'Crop', active:true, click:()=>{ const url=freshURL(cropURL); img.src=url; link.href=url; }},
      {label:'Original', disabled:!origURL, click:()=>{ const url=freshURL(origURL); img.src=url; link.href=url; }},
      {label:'Annotated', disabled:!annURL, click:()=>{ const url=freshURL(annURL); img.src=url; link.href=url; }}
    ]);
    segWrap.appendChild(segToggle); card.appendChild(segWrap);

    card.appendChild(animationWidget(h));

    const meta = document.createElement('div'); meta.className='meta';
    const speed = (()=>{ const p=h.positions||[]; if(p.length<2) return '—';
      const d = Math.hypot(p[p.length-1].x-p[0].x, p[p.length-1].y-p[0].y);
      return `${d.toFixed(1)} px / ${p.length} frames`; })();
    const pa = h.dual_channel_match ? `${h.dual_channel_match.with} (Δ=${h.dual_channel_match.pa_diff_deg}°)` : '—';

    // Orbit HTML
    let orbitHTML = '';
    const orb = h.predicted_orbit;
    if (orb && orb.orbit_2d) {
      const o2 = orb.orbit_2d;
      orbitHTML += `
        <details style="margin-top:8px;">
          <summary class="pill" style="cursor:pointer;font-weight:700;">
            2D Orbit: ${o2.orbit_group_guess} (q=${o2.perihelion_distance_Rsun} R⊙)
          </summary>
          <pre style="font-size:0.7rem;margin:6px 0;background:#0b1220;padding:8px;border-radius:8px;overflow:auto;">
${orb.ascii_plot||''}
          </pre>
          ${orb.plot_path ? `<a href="${rawURL(orb.plot_path)}" target="_blank" rel="noopener"><img src="${rawURL(orb.plot_path)}" style="width:100%;border-radius:8px;margin-top:6px;" loading="lazy"></a>` : ''}
        </details>`;
    }
    if (orb && orb.orbit_3d) {
      const o3 = orb.orbit_3d;
      orbitHTML += `
        <div style="margin-top:8px;">
          <summary class="pill" style="cursor:pointer;font-weight:700;color:#ff0;">
            3D Orbit: ${o3.orbit_group_guess} (i=${o3.inclination_deg}°)
          </summary>
          <div style="font-size:0.8rem;padding:6px;">
            Perihelion: ${new Date(o3.perihelion_time_utc).toLocaleString()} <br>
            q = ${o3.perihelion_distance_Rsun} R⊙ | v = ${o3.speed_at_perihelion_kms} km/s <br>
            PA = ${o3.position_angle_deg}° | Inclination = ${o3.inclination_deg}°
          </div>
          <div class="orbit-btn" onclick="show3DOrbit(${JSON.stringify(o3)})">View Interactive 3D Orbit</div>
        </div>`;
    }

    meta.innerHTML = `
      <div class="row">
        <span class="pill">${(h.detector||'').toUpperCase()}</span>
        <span class="pill">Track #${h.track_index??'?'}</span>
        <span class="pill">PA: ${pa}</span>
        <span class="pill">Speed: ${speed}</span>
        <span class="right sub"></span>
      </div>
      <div class="kvs">
        <div class="kv">Size: <b>${h.image_size?.[0]??1024}×${h.image_size?.[1]??1024}</b></div>
        <div class="kv">Origin: <b>Upper Left</b></div>
        <div class="kv">Frames: <b>${(h.positions||[]).length}</b></div>
        <div class="kv">First: <b>${(h.positions?.[0]?.time_utc||"").split('T')[0]||'—'}</b></div>
      </div>
      ${orbitHTML}
      <div class="row" style="margin-top:8px;">
        <button class="sgBtn">Copy for Sungrazer</button>
        ${origURL?`<a class="pill" href="${origURL}" target="_blank" rel="noopener">Original</a>`:''}
        ${annURL?`<a class="pill" href="${annURL}" target="_blank" rel="noopener">Annotated</a>`:''}
        <span class="right mark">
          <select class="group">
            <option ${groupVal==='Unknown'?'selected':''}>Unknown</option>
            <option ${groupVal==='Kreutz'?'selected':''}>Kreutz</option>
            <option ${groupVal==='Meyer'?'selected':''}>Meyer</option>
            <option ${groupVal==='Marsden'?'selected':''}>Marsden</option>
            <option ${groupVal==='Kracht'?'selected':''}>Kracht</option>
            <option ${groupVal==='Kracht-II'?'selected':''}>Kracht-II</option>
          </select>
          <button class="flag ${marked?'on':''}" title="Mark for submission">${marked?'Marked':'Mark'}</button>
        </span>
      </div>`;
    card.appendChild(meta);
    el.grid.appendChild(card);

    meta.querySelector('.sgBtn').onclick = ()=>{ 
      navigator.clipboard.writeText(sungrazerText(h)).then(()=>{ 
        const b=meta.querySelector('.sgBtn'); b.textContent='Copied!'; 
        setTimeout(()=>b.textContent='Copy for Sungrazer',1200); 
      });
    };

    const flag = meta.querySelector('.flag');
    flag.onclick = ()=>{ 
      const mm=marks(); 
      if(mm[k]){delete mm[k];flag.classList.remove('on');flag.textContent='Mark';} 
      else{mm[k]=true;flag.classList.add('on');flag.textContent='Marked';} 
      saveMarks(mm); 
      if(el.markedOnly.checked) renderGrid(items); 
    };

    meta.querySelector('.group').onchange = e=>{ const gg=groups(); gg[k]=e.target.value; saveGroups(gg); };

    // Dynamic TXT/CSV download buttons
    const txtBlob = new Blob([sungrazerText(h)], {type: 'text/plain'});
    const txtA = document.createElement('a');
    txtA.href = URL.createObjectURL(txtBlob);
    txtA.download = `${h.detector}_track${h.track_index}_sungrazer.txt`;
    txtA.className = 'pill';
    txtA.textContent = 'TXT';
    txtA.style.display = 'inline-flex';

    const csvContent = `detector,track_index,time_utc,x,y\n` + h.positions.map(p => `${h.detector},${h.track_index},${p.time_utc},${p.x},${p.y}`).join('\n');
    const csvBlob = new Blob([csvContent], {type: 'text/csv'});
    const csvA = document.createElement('a');
    csvA.href = URL.createObjectURL(csvBlob);
    csvA.download = `${h.detector}_track${h.track_index}_sungrazer.csv`;
    csvA.className = 'pill';
    csvA.textContent = 'CSV';
    csvA.style.display = 'inline-flex';

    meta.querySelector('.row').appendChild(txtA);
    meta.querySelector('.row').appendChild(csvA);
  });
  if(items.length) el.grid.firstChild?.scrollIntoView({behavior:'smooth',block:'center'});
}

/* ---------- LAST-FRAME THUMBNAILS ---------- */
async function loadThumbs(){
  const dets = ['C2', 'C3'];
  const rows = [];
  for(const d of dets){
    const thumb = await imgExists(`lastthumb_${d}.png`);
    const overlay = await imgExists(`overlay_${d}.png`);
    const contact = await imgExists(`contact_${d}.png`);
    if(thumb.ok||overlay.ok||contact.ok) rows.push({det:d,thumb,overlay,contact});
  }
  if(!rows.length) return;
  el.lastFramesRow.innerHTML = rows.map(o=>`
    <div class="thumbCard">
      <div class="thumbHead">
        <span class="pill">${o.det}</span>
        ${o.thumb.ok?`<span class="pill">${o.thumb.w}×${o.thumb.h}</span>`:''}
      </div>
      ${o.thumb.ok?`<a href="${rawURL(`lastthumb_${o.det}.png`)}" target="_blank" rel="noopener"><img class="thumb" src="${freshURL(rawURL(`lastthumb_${o.det}.png`))}" alt="last ${o.det}" loading="lazy"></a>`:
        `<div class="thumb">(no lastthumb_${o.det}.png)</div>`}
      <div class="meta">
        <div class="kv">
          ${o.overlay.ok?`Overlay: <a href="${rawURL(`overlay_${o.det}.png`)}" target="_blank">open</a>`:'Overlay: —'} •
          ${o.contact.ok?`Contact: <a href="${rawURL(`contact_${o.det}.png`)}" target="_blank">open</a>`:'Contact: —'}
        </div>
      </div>
    </div>`).join('');
}
function imgExists(path){
  return new Promise(res=>{
    const i=new Image();
    i.onload=()=>res({ok:true,w:i.naturalWidth,h:i.naturalHeight});
    i.onerror=()=>res({ok:false});
    i.src=freshURL(rawURL(path));
  });
}

/* ---------- LIVE GIFs ---------- */
function refreshLiveGifs(){
  const t = Date.now();
  el.c2Gif.src = `https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif?cb=${t}`;
  el.c3Gif.src = `https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif?cb=${t}`;
  const now = new Date().toLocaleTimeString();
  el.c2GifTime.textContent = `refreshed ${now}`;
  el.c3GifTime.textContent = `refreshed ${now}`;
}

/* ---------- MAIN LOAD & DROPDOWNS ---------- */
let allReportFiles = [];
async function loadReportList(){
  hideError();
  try{
    const list = await fetchJSON(apiListURL());
    const files = Array.isArray(list) ? list.filter(f=>f.type==="file" && /^candidates_\d{8}_\d{6}\.json$/i.test(f.name))
                                      .sort((a,b)=>b.name.localeCompare(a.name)) : [];

    allReportFiles = [];
    el.latestSelect.innerHTML = '<option value="">— Latest Report —</option>';
    el.hitsSelect.innerHTML   = '<option value="">— Potential Hits —</option>';

    for(const f of files){
      const data = await fetchJSON(rawURL(f.name));
      const hasComet = Array.isArray(data) && data.some(h=> (h.ai_label||'').toLowerCase()==='comet');
      allReportFiles.push({name:f.name, hasComet});

      const opt = document.createElement('option');
      opt.value = f.name;
      opt.textContent = f.name;
      el.latestSelect.appendChild(opt.cloneNode(true));
      if(hasComet) el.hitsSelect.appendChild(opt);
    }

    if(files.length){
      el.latestSelect.value = files[0].name;
      await loadReport(files[0].name, false);
    }else{
      el.viewName.textContent = '—';
      el.reportTime.textContent = '';
      el.grid.hidden = true; el.empty.hidden = false;
      el.empty.textContent = 'No candidate files yet.';
    }
    await loadThumbs();
  }catch(e){
    showError(`GitHub load failed: ${e.message}`);
    el.empty.textContent = "Unable to fetch report list.";
  }finally{
    refreshLiveGifs();
  }
}

async function loadReport(name, isHitFile){
  try{
    const data = await fetchJSON(rawURL(name));
    currentReport = {name, items:Array.isArray(data)?data:[], isHitFile:!!isHitFile};

    el.viewName.textContent = isHitFile ? `Potential Hits – ${name}` : name;
    const t = parseReportTime(name);
    el.reportTime.textContent = t? `• ${t.local} (local)` : '';

    renderGrid(currentReport.items);
  }catch(e){
    showError(`Failed to load ${name}: ${e.message}`);
  }
}

el.latestSelect.onchange = e => { if(e.target.value) loadReport(e.target.value, false); };
el.hitsSelect.onchange   = e => { if(e.target.value) loadReport(e.target.value, true); };

/* ---------- EXPORT ALL ---------- */
function exportAll(){
  if(!currentReport) return alert('No report loaded.');
  let items = applyFilters(currentReport.items);
  if(el.exportMarkedOnly.checked) items = items.filter(h=>marks()[keyFor(h)]);
  if(!items.length) return alert('No candidates to export (check filters).');

  const txt = allSungrazerText(items, currentReport.name);
  navigator.clipboard.writeText(txt).catch(()=>{});

  const csv = allCSV(items);
  const txtBlob = new Blob([txt],{type:'text/plain'});
  const csvBlob = new Blob([csv],{type:'text/csv'});

  el.downloadAllTxt.href = URL.createObjectURL(txtBlob);
  el.downloadAllTxt.download = `${currentReport.name.replace('.json','')}_Sungrazer_EXPORT.txt`;
  el.downloadAllTxt.style.display='inline-flex';

  el.downloadAllCsv.href = URL.createObjectURL(csvBlob);
  el.downloadAllCsv.download = `${currentReport.name.replace('.json','')}_Sungrazer_EXPORT.csv`;
  el.downloadAllCsv.style.display='inline-flex';

  el.exportAllBtn.textContent='Exported & Copied!';
  setTimeout(()=>el.exportAllBtn.textContent='Export ALL',1200);
}
el.exportAllBtn.onclick = exportAll;

/* ---------- AUTO-REFRESH ---------- */
function startAutoRefresh(){
  if(refreshTimer) clearInterval(refreshTimer);
  countdown = REFRESH_SECS; el.refreshEta.textContent = fmtSec(countdown);
  refreshTimer = setInterval(()=>{
    countdown--; el.refreshEta.textContent = fmtSec(countdown);
    if(countdown<=0){ loadReportList(); countdown=REFRESH_SECS; }
  },1000);
}

/* ---------- UI BINDINGS ---------- */
el.refreshBtn.onclick = ()=>{ countdown=REFRESH_SECS; loadReportList(); };
$$('input[type=checkbox]').forEach(cb=>cb.onchange=()=>{ if(currentReport) renderGrid(currentReport.items); });

/* ---------- BOOT ---------- */
loadReportList().then(startAutoRefresh);
</script>
</body>
</html>
