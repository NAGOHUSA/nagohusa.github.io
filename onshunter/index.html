<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SOHO Comet Hunter – Nagoh Creative</title>
<meta name="description" content="Live NASA LASCO animations, AI‑detected comets and Sungrazer‑ready exports – built by Nagoh Creative for OurNightSky.Us">
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0b1220; --panel:#0f1b30; --muted:#94a3b8; --text:#e6eefc; --accent:#60a5fa;
    --chip:#1e293b; --card:#0d1526; --shadow:0 8px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),#0b1220f0 80%,#0b122000);backdrop-filter:blur(6px);border-bottom:1px solid #1e293b}
  .wrap{max-width:1240px;margin:auto;padding:14px 16px}
  h1{font-size:1.35rem;font-weight:800;letter-spacing:.3px}
  .sub{font-size:.85rem;color:var(--muted)}
  .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-top:12px}
  button,.sel,input[type=checkbox]{cursor:pointer}
  button{border:1px solid #243244;background:#0e1a2b;color:var(--text);padding:8px 14px;border-radius:12px;font-weight:700;box-shadow:var(--shadow)}
  button:hover{border-color:#33508a}
  .sel{background:#0e1a2b;border:1px solid #243244;border-radius:12px;padding:6px 10px;color:var(--text)}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #1e293b;padding:4px 8px;border-radius:999px;font-size:.8rem;color:var(--muted)}
  .pill input{accent-color:var(--accent)}
  .right{margin-left:auto}
  main{padding:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
  .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
  .thumb{aspect-ratio:1.6/1;width:100%;background:#0b1220;object-fit:contain;display:block}
  .meta{padding:12px;flex:1;display:flex;flex-direction:column;gap:8px}
  .kvs{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:.8rem;color:var(--muted)}
  .kv b{color:var(--text)}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .stats{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
  .stat{background:var(--panel);border:1px solid #1e293b;border-radius:12px;padding:8px 12px}
  .stat b{font-size:1.1rem}
  .empty{padding:40px;text-align:center;color:var(--muted);border:1px dashed #253044;border-radius:16px;background:#0b1220}
  .err{color:#ffb4b4}
  .thumbRow{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:12px}
  .thumbCard{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden}
  .thumbHead{padding:10px 12px;border-bottom:1px solid #1e293b;display:flex;align-items:center;gap:10px}
  .gifRow{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:16px;margin-top:12px}
  .gifCard{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden}
  .gifHead{padding:10px 12px;border-bottom:1px solid #1e293b;display:flex;gap:10px;align-items:center}
  .gif{display:block;width:100%;background:#0b1220;aspect-ratio:1/1;object-fit:contain}
  .exportAll{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:.75rem}
  .mark{display:flex;gap:6px;align-items:center}
  .flag{padding:4px 8px;border-radius:10px;border:1px solid #1e293b;background:#13223a}
  .flag.on{background:#11351d;border-color:#1d4d2a;color:#b5f7c0}
  .group{background:#0e1a2b;border:1px solid #243244;border-radius:10px;padding:4px 6px;color:var(--text);font-size:.75rem}
  .seg{display:inline-flex;border:1px solid #27324a;border-radius:10px;overflow:hidden;background:#0e1a2b}
  .seg button{border:0;border-right:1px solid #27324a;background:transparent;color:#cbd5e1;padding:6px 10px;font-size:.75rem}
  .seg button:last-child{border-right:0}
  .seg button.active{background:#1b2a46;color:#e6eefc}
  .video-container{margin-top:12px;border:1px solid #1e293b;border-radius:12px;overflow:hidden;background:#0b1220}
  .video-container video{width:100%;display:block;background:#000}
  footer{font-size:.75rem;color:var(--muted);padding:20px 0;text-align:center}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>SOHO Comet Hunter</h1>
    <div class="sub">Live NASA LASCO animations • AI‑detected comets • Sungrazer‑ready exports</div>
    <div class="controls">
      <button id="refreshBtn">Refresh</button>

      <label class="pill"><input type="checkbox" id="c2Filter"> C2</label>
      <label class="pill"><input type="checkbox" id="c3Filter"> C3</label>
      <label class="pill"><input type="checkbox" id="aiOnly"> AI=‘comet’ only</label>
      <label class="pill"><input type="checkbox" id="markedOnly"> Marked only</label>

      <div class="right pill">Auto‑refresh: <span id="refreshEta">—</span></div>

      <div class="exportAll">
        <button id="exportAllBtn">Export ALL</button>
        <label class="pill"><input type="checkbox" id="exportMarkedOnly"> Marked only</label>
        <a id="downloadAllTxt" class="pill" href="#" download style="display:none;">TXT</a>
        <a id="downloadAllCsv" class="pill" href="#" download style="display:none;">CSV</a>
        <span id="exportAllHint" class="muted"></span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- ==== STATUS BAR ==== -->
  <section id="status">
    <div class="row">
      <div>Latest report: <b id="reportName">—</b> <span class="sub" id="reportTime"></span></div>
    </div>
    <div class="stats" id="stats"></div>
  </section>

  <!-- ==== LIVE NASA GIFS ==== -->
  <section aria-label="Live LASCO animations" style="margin-top:20px;">
    <div class="gifRow">
      <div class="gifCard">
        <div class="gifHead">
          <span class="pill">C2 – Live GIF</span>
          <a class="sub" href="https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif" target="_blank" rel="noopener">open</a>
          <span class="right sub" id="c2GifTime"></span>
        </div>
        <img id="c2Gif" class="gif" alt="SOHO LASCO C2 live animation">
      </div>
      <div class="gifCard">
        <div class="gifHead">
          <span class="pill">C3 – Live GIF</span>
          <a class="sub" href="https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif" target="_blank" rel="noopener">open</a>
          <span class="right sub" id="c3GifTime"></span>
        </div>
        <img id="c3Gif" class="gif" alt="SOHO LASCO C3 live animation">
      </div>
    </div>
  </section>

  <!-- ==== LAST‑FRAME THUMBNAILS ==== -->
  <section style="margin-top:20px;">
    <div class="thumbRow" id="lastFramesRow"></div>
    <div class="empty" id="errors" style="margin-top:12px;display:none;"></div>
  </section>

  <!-- ==== CANDIDATE GRID ==== -->
  <section id="content" style="margin-top:24px;">
    <div class="empty" id="empty">Loading the latest detections…</div>
    <div class="grid" id="grid" hidden></div>
  </section>

  <footer>
    <div>Built by <a href="https://nagohcreative.com" target="_blank" rel="noopener">Nagoh Creative</a> for <a href="https://ournightsky.us" target="_blank" rel="noopener">OurNightSky.Us</a></div>
  </footer>
</main>

<script>
/* ────────────────────── CONFIG ────────────────────── */
const BASE = '/detections';               // <-- change only if you move the folder
const REPORT_JSON = `${BASE}/latest_report.json`;
const REFRESH_SECS = 15 * 60;             // 15 minutes
/* ─────────────────────────────────────────────────── */

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const el = { 
  grid: $('#grid'), empty: $('#empty'), errors: $('#errors'),
  reportName: $('#reportName'), reportTime: $('#reportTime'),
  stats: $('#stats'), c2Filter: $('#c2Filter'), c3Filter: $('#c3Filter'),
  aiOnly: $('#aiOnly'), markedOnly: $('#markedOnly'), lastFramesRow: $('#lastFramesRow'),
  c2Gif: $('#c2Gif'), c3Gif: $('#c3Gif'), c2GifTime: $('#c2GifTime'), c3GifTime: $('#c3GifTime'),
  exportAllBtn: $('#exportAllBtn'), exportMarkedOnly: $('#exportMarkedOnly'),
  downloadAllTxt: $('#downloadAllTxt'), downloadAllCsv: $('#downloadAllCsv'), exportAllHint: $('#exportAllHint'),
  refreshBtn: $('#refreshBtn'), refreshEta: $('#refreshEta')
};

let currentReport = null;
let refreshTimer = null, countdown = REFRESH_SECS;

/* ───── LOCAL STORAGE ───── */
const LS_MARKS = 'soho_marks', LS_GROUPS = 'soho_groups';
const marks = () => JSON.parse(localStorage.getItem(LS_MARKS) || '{}');
const groups = () => JSON.parse(localStorage.getItem(LS_GROUPS) || '{}');
const saveMarks = m => localStorage.setItem(LS_MARKS, JSON.stringify(m));
const saveGroups = g => localStorage.setItem(LS_GROUPS, JSON.stringify(g));
const keyFor = h => `${(h.detector||'').toUpperCase()}#${h.track_index}#${h.series_mid_frame||''}`;

/* ───── HELPERS ───── */
function showError(msg){ el.errors.style.display='block'; el.errors.innerHTML = `<div class="err">${msg}</div>`; }
function hideError(){ el.errors.style.display='none'; }
function fmtDate(iso){
  if(!iso) return '';
  const d = new Date(iso);
  return d.toLocaleString(undefined, {dateStyle:'medium', timeStyle:'short'});
}
function imgURL(path){ return path ? `${BASE}/${path.replace(/^\.?\/*/,'')}?t=${Date.now()}` : null; }
function ghBlobURL(path){ return `https://github.com/NAGOHUSA/ONS_SOHOHUNTER/blob/main/${path}`; } // kept only for fallback images

/* ───── FILTERING ───── */
function applyFilters(items){
  const m = marks();
  return items.filter(h=>{
    if(el.c2Filter.checked && (h.detector||'').toUpperCase()!=='C2') return false;
    if(el.c3Filter.checked && (h.detector||'').toUpperCase()!=='C3') return false;
    if(el.aiOnly.checked && (h.ai_label||'').toLowerCase()!=='comet') return false;
    if(el.markedOnly.checked && !m[keyFor(h)]) return false;
    return true;
  });
}

/* ───── STATS ───── */
function renderStats(filtered){
  const byDet = filtered.reduce((a,h)=>{a[(h.detector||'').toUpperCase()]=(a[(h.detector||'').toUpperCase()]||0)+1;return a;},{});
  const ai = filtered.reduce((a,h)=>{const l=(h.ai_label||'').toLowerCase();if(l)a[l]=(a[l]||0)+1;return a;},{});
  el.stats.innerHTML='';
  const add = (label,val)=>{ const d=document.createElement('div'); d.className='stat';
    d.innerHTML=`<div class="sub">${label}</div><div><b>${val}</b></div>`; el.stats.appendChild(d); };
  add('Candidates',filtered.length);
  add('C2',byDet.C2||0); add('C3',byDet.C3||0);
  if(ai.comet||ai.not_comet){ add('AI “comet”',ai.comet||0); add('AI “not_comet”',ai.not_comet||0); }
}

/* ───── SUNGRAZER TEXT / CSV ───── */
function sungrazerText(h){
  const w = h.image_size?.[0]??1024, ht = h.image_size?.[1]??1024;
  const first = (h.positions?.[0]?.time_utc||"").split('T')[0]||"";
  const g = groups()[keyFor(h)]||"Unknown";
  const lines = [
    `=== Sungrazer Report Helper ===`,
    `Camera: ${(h.detector||'').toUpperCase()}`,
    `Image Size: ${w}x${ht}`,
    `Your (0,0) position: Upper Left`,
    `Probable Group: ${g}`,
    `Date of FIRST IMAGE: ${first}`,
    `Frames (time_utc, x, y):`
  ];
  (h.positions||[]).forEach(p=>{
    const t = (p.time_utc||"").replace('T',' ').replace('Z','');
    lines.push(`  ${t}, ${Math.round(p.x)}, ${Math.round(p.y)}`);
  });
  return lines.join('\n')+'\n';
}
function allSungrazerText(items, reportName){
  const lines = [`=== Sungrazer Report Helper — FULL EXPORT ===`];
  if(reportName) lines.push(`Report: ${reportName}`);
  lines.push('');
  items.forEach((h,i)=>{
    lines.push(`--- Candidate ${i+1} — ${(h.detector||'').toUpperCase()} Track #${h.track_index??'?' } ---`);
    lines.push(sungrazerText(h).trim());
    lines.push('');
  });
  return lines.join('\n')+'\n';
}
function allCSV(items){
  const g = groups();
  const rows = [["detector","track_index","series_mid_frame","frame_time_utc","x","y","image_width","image_height","origin","ai_label","ai_score","dual_match","group","orig_mid","ann_mid"]];
  items.forEach(h=>{
    const det = (h.detector||'').toUpperCase();
    const w = h.image_size?.[0]??'', ht = h.image_size?.[1]??'';
    const origin = (h.origin||"").toLowerCase();
    const ai = h.ai_label||"", score = h.ai_score!=null?String(h.ai_score):"";
    const dual = h.dual_channel_match? `${h.dual_channel_match.with};Δ=${h.dual_channel_match.pa_diff_deg}°`:"";
    const grp = g[keyFor(h)]||"Unknown";
    const orig = h.original_mid_path||"", ann = h.annotated_mid_path||"";
    (h.positions||[]).forEach(p=>{
      rows.push([det, h.track_index, h.series_mid_frame||"", p.time_utc||"", Math.round(p.x), Math.round(p.y), w, ht, origin, ai, score, dual, grp, orig, ann]);
    });
  });
  return rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n')+'\n';
}

/* ───── SEGMENTED TOGGLE (Clean / Annotated) ───── */
function seg(items){
  const div = document.createElement('div'); div.className='seg';
  items.forEach(({label,disabled,active,click})=>{
    const b = document.createElement('button');
    b.textContent=label; if(disabled) b.disabled=true;
    if(active) b.classList.add('active');
    b.onclick = ()=>{ $$('.seg button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); click?.(); };
    div.appendChild(b);
  });
  return div;
}

/* ───── VIDEO PLAYER ───── */
function videoPlayer(h){
  const container = document.createElement('div'); container.className='video-container';
  const cleanMp4 = h.animation_mp4_clean_path ? imgURL(h.animation_mp4_clean_path) : null;
  const cleanGif = h.animation_gif_clean_path ? imgURL(h.animation_gif_clean_path) : null;
  const annMp4   = h.animation_mp4_path ? imgURL(h.animation_mp4_path) : null;
  const annGif   = h.animation_gif_path ? imgURL(h.animation_gif_path) : null;

  if(!cleanMp4 && !cleanGif && !annMp4 && !annGif){
    container.innerHTML = `<div style="padding:16px;text-align:center;color:#94a3b8;">No animation</div>`;
    return container;
  }

  const video = document.createElement('video');
  video.controls = video.loop = true; video.style.width='100%';

  const setSrc = (mp4,gif)=>{ video.innerHTML=''; 
    if(mp4){ const s=document.createElement('source'); s.src=mp4; s.type='video/mp4'; video.appendChild(s); }
    if(gif){ const s=document.createElement('source'); s.src=gif; s.type='image/gif'; video.appendChild(s); }
    video.load();
  };
  setSrc(cleanMp4, cleanGif);

  if((cleanMp4||cleanGif) && (annMp4||annGif)){
    const s = seg([
      {label:'Clean', active:true, click:()=>setSrc(cleanMp4,cleanGif)},
      {label:'Annotated', click:()=>setSrc(annMp4,annGif)}
    ]);
    s.style.margin='8px';
    container.appendChild(s);
  }
  container.appendChild(video);
  return container;
}

/* ───── RENDER GRID ───── */
function renderGrid(items){
  const filtered = applyFilters(items);
  renderStats(filtered);
  el.exportAllHint.textContent = filtered.length ? `(${filtered.length} candidate${filtered.length>1?'s':''})` : '(none)';

  if(!filtered.length){
    el.grid.hidden = true; el.empty.hidden = false;
    el.empty.textContent = "No candidates match the current filters.";
    return;
  }
  el.grid.hidden = false; el.empty.hidden = true; el.grid.innerHTML='';

  const m = marks(), g = groups();
  filtered.forEach((h,i)=>{
    const k = keyFor(h);
    const marked = !!m[k];
    const groupVal = g[k]||"Unknown";

    const cropURL = imgURL(h.crop_path);
    const origURL = imgURL(h.original_mid_path);
    const annURL  = imgURL(h.annotated_mid_path);

    const txtURL = imgURL(`reports/${(h.detector||'').toUpperCase()}_track${h.track_index}_sungrazer.txt`);
    const csvURL = imgURL(`reports/${(h.detector||'').toUpperCase()}_track${h.track_index}_sungrazer.csv`);

    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.className='thumb'; img.loading='lazy';
    img.src = cropURL; img.alt=`candidate ${i+1}`;
    img.onerror = ()=>{ const ph=document.createElement('div'); ph.className='thumb'; ph.textContent='(image missing)'; img.replaceWith(ph); };
    const link = document.createElement('a'); link.href=cropURL; link.target='_blank'; link.rel='noopener';
    link.appendChild(img); card.appendChild(link);

    // Thumb toggle
    const segWrap = document.createElement('div'); segWrap.style.padding='0 12px 8px';
    const seg = seg([
      {label:'Crop', active:true, click:()=>{ img.src=cropURL; link.href=cropURL; }},
      {label:'Original', disabled:!origURL, click:()=>{ img.src=origURL; link.href=origURL; }},
      {label:'Annotated', disabled:!annURL, click:()=>{ img.src=annURL; link.href=annURL; }}
    ]);
    segWrap.appendChild(seg); card.appendChild(segWrap);

    card.appendChild(videoPlayer(h));

    const meta = document.createElement('div'); meta.className='meta';
    const speed = (()=>{ const p=h.positions||[]; if(p.length<2) return '—';
      const d = Math.hypot(p[p.length-1].x-p[0].x, p[p.length-1].y-p[0].y);
      return `${(d/Math.max(1,p.length-1)).toFixed(1)} px/frame`; })();
    const pa = h.dual_channel_match ? `${h.dual_channel_match.with} (Δ=${h.dual_channel_match.pa_diff_deg}°)` : '—';

    meta.innerHTML = `
      <div class="row">
        <span class="pill">${(h.detector||'').toUpperCase()}</span>
        <span class="pill">Track #${h.track_index??'?'}</span>
        <span class="pill">PA: ${pa}</span>
        <span class="pill">Speed: ${speed}</span>
        <span class="right sub">${h.series_mid_frame||''}</span>
      </div>
      <div class="kvs">
        <div class="kv">Size: <b>${h.image_size?.[0]??1024}×${h.image_size?.[1]??1024}</b></div>
        <div class="kv">Origin: <b>Upper Left</b></div>
        <div class="kv">Frames: <b>${(h.positions||[]).length}</b></div>
        <div class="kv">First: <b>${(h.positions?.[0]?.time_utc||"").split('T')[0]||'—'}</b></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="sgBtn">Copy for Sungrazer</button>
        ${txtURL?`<a class="pill" href="${txtURL}" target="_blank" rel="noopener">TXT</a>`:''}
        ${csvURL?`<a class="pill" href="${csvURL}" target="_blank" rel="noopener">CSV</a>`:''}
        ${origURL?`<a class="pill" href="${origURL}" target="_blank" rel="noopener">Original</a>`:''}
        ${annURL?`<a class="pill" href="${annURL}" target="_blank" rel="noopener">Annotated</a>`:''}
        <span class="right mark">
          <select class="group">
            <option ${groupVal==='Unknown'?'selected':''}>Unknown</option>
            <option ${groupVal==='Kreutz'?'selected':''}>Kreutz</option>
            <option ${groupVal==='Meyer'?'selected':''}>Meyer</option>
            <option ${groupVal==='Marsden'?'selected':''}>Marsden</option>
            <option ${groupVal==='Kracht'?'selected':''}>Kracht</option>
            <option ${groupVal==='Kracht-II'?'selected':''}>Kracht-II</option>
          </select>
          <button class="flag ${marked?'on':''}" title="Mark for submission">${marked?'Marked':'Mark'}</button>
        </span>
      </div>`;
    card.appendChild(meta);
    el.grid.appendChild(card);

    // copy button
    meta.querySelector('.sgBtn').onclick = ()=>{ navigator.clipboard.writeText(sungrazerText(h)).then(()=>{ const b=meta.querySelector('.sgBtn'); b.textContent='Copied!'; setTimeout(()=>b.textContent='Copy for Sungrazer',1200); }); };

    // mark toggle
    const flag = meta.querySelector('.flag');
    flag.onclick = ()=>{ const mm=marks(); if(mm[k]){delete mm[k];flag.classList.remove('on');flag.textContent='Mark';}else{mm[k]=true;flag.classList.add('on');flag.textContent='Marked';} saveMarks(mm); if(el.markedOnly.checked) renderGrid(items); };

    // group selector
    meta.querySelector('.group').onchange = e=>{ const gg=groups(); gg[k]=e.target.value; saveGroups(gg); };
  });
}

/* ───── LAST‑FRAME THUMBNAILS ───── */
async function loadThumbs(){
  const dets = ['C2','C3'];
  const rows = [];
  for(const d of dets){
    const thumb = await imgExists(`${BASE}/lastthumb_${d}.png`);
    const overlay = await imgExists(`${BASE}/overlay_${d}.png`);
    const contact = await imgExists(`${BASE}/contact_${d}.png`);
    if(thumb.ok||overlay.ok||contact.ok) rows.push({det:d,thumb,overlay,contact});
  }
  if(!rows.length) return;
  el.lastFramesRow.innerHTML = rows.map(o=>`
    <div class="thumbCard">
      <div class="thumbHead">
        <span class="pill">${o.det}</span>
        ${o.thumb.ok?`<span class="pill">${o.thumb.w}×${o.thumb.h}</span>`:''}
      </div>
      ${o.thumb.ok?`<a href="${imgURL(`lastthumb_${o.det}.png`)}" target="_blank" rel="noopener"><img class="thumb" src="${imgURL(`lastthumb_${o.det}.png`)}" alt="last ${o.det}"></a>`:
        `<div class="thumb">(no lastthumb_${o.det}.png)</div>`}
      <div class="meta">
        <div class="kv">
          ${o.overlay.ok?`Overlay: <a href="${imgURL(`overlay_${o.det}.png`)}" target="_blank">open</a>`:'Overlay: —'} •
          ${o.contact.ok?`Contact: <a href="${imgURL(`contact_${o.det}.png`)}" target="_blank">open</a>`:'Contact: —'}
        </div>
      </div>
    </div>`).join('');
}
function imgExists(path){
  return new Promise(res=>{
    const i=new Image();
    i.onload = ()=>res({ok:true,w:i.naturalWidth,h:i.naturalHeight});
    i.onerror = ()=>res({ok:false});
    i.src = imgURL(path);
  });
}

/* ───── LIVE GIFS ───── */
function refreshLiveGifs(){
  const t = Date.now();
  el.c2Gif.src = `https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif?cb=${t}`;
  el.c3Gif.src = `https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif?cb=${t}`;
  const now = new Date().toLocaleTimeString();
  el.c2GifTime.textContent = `refreshed ${now}`;
  el.c3GifTime.textContent = `refreshed ${now}`;
}

/* ───── MAIN DATA LOAD ───── */
async function loadLatest(){
  hideError();
  try{
    const r = await fetch(REPORT_JSON);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    if(!data || !Array.isArray(data.candidates)){
      el.empty.textContent = "Report is empty.";
      el.grid.hidden = true; el.empty.hidden = false;
      return;
    }
    currentReport = {name:data.report_name, time:data.report_time, items:data.candidates};
    el.reportName.textContent = data.report_name;
    el.reportTime.textContent = fmtDate(data.report_time) ? `• ${fmtDate(data.report_time)} (local)` : '';
    renderGrid(currentReport.items);
    await loadThumbs();
  }catch(e){
    showError(`Failed to load report: ${e.message}`);
    el.empty.textContent = "Unable to load the latest detections.";
  }finally{
    refreshLiveGifs();
  }
}

/* ───── EXPORT ALL ───── */
function exportAll(){
  if(!currentReport) return alert('No report loaded.');
  let items = applyFiltersFilters(currentReport.items);
  if(el.exportMarkedOnly.checked) items = items.filter(h=>marks()[keyFor(h)]);
  if(!items.length) return alert('No candidates to export (check filters).');

  const txt = allSungrazerText(items, currentReport.name);
  navigator.clipboard.writeText(txt).catch(()=>{});

  const csv = allCSV(items);
  const txtBlob = new Blob([txt],{type:'text/plain'});
  const csvBlob = new Blob([csv],{type:'text/csv'});

  el.downloadAllTxt.href = URL.createObjectURL(txtBlob);
  el.downloadAllTxt.download = `${currentReport.name.replace('.json','')}_Sungrazer_EXPORT.txt`;
  el.downloadAllTxt.style.display='inline-flex';

  el.downloadAllCsv.href = URL.createObjectURL(csvBlob);
  el.downloadAllCsv.download = `${currentReport.name.replace('.json','')}_Sungrazer_EXPORT.csv`;
  el.downloadAllCsv.style.display='inline-flex';

  el.exportAllBtn.textContent='Exported & Copied!';
  setTimeout(()=>el.exportAllBtn.textContent='Export ALL',1200);
}
el.exportAllBtn.onclick = exportAll;

/* ───── AUTO‑REFRESH ───── */
function startAutoRefresh(){
  if(refreshTimer) clearInterval(refreshTimer);
  countdown = REFRESH_SECS; el.refreshEta.textContent = formatSec(countdown);
  refreshTimer = setInterval(()=>{
    countdown--; el.refreshEta.textContent = formatSec(countdown);
    if(countdown<=0){ loadLatest(); countdown=REFRESH_SECS; }
  },1000);
}
function formatSec(s){ const m=Math.floor(s/60), ss=s%60; return `${m}m ${ss<10?'0':''}${ss}s`; }

/* ───── UI BINDINGS ───── */
el.refreshBtn.onclick = ()=>{ countdown=REFRESH_SECS; loadLatest(); };
$$('input[type=checkbox]').forEach(cb=>cb.onchange=()=>{ if(currentReport) renderGrid(currentReport.items); });

/* ───── BOOT ───── */
loadLatest().then(startAutoRefresh);
</script>
</body>
</html>
