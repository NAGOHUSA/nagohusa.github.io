<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SOHO Comet Hunter — Live Results</title>

<!-- GIF encoder (canvas fallback) -->
<script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.js"></script>

<style>
:root{
  --bg:#0b1220;--panel:#0f1b30;--muted:#94a3b8;--text:#e6eefc;--accent:#60a5fa;
  --chip:#1e293b;--card:#0d1526;--shadow:0 8px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);
  font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:10;
  background:linear-gradient(180deg,var(--bg),#0b1220f0 80%,#0b122000);
  backdrop-filter:blur(6px);border-bottom:1px solid #1e293b}
.wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
h1{margin:6px 0 0;font-size:20px;font-weight:800;letter-spacing:.3px}
.sub{font-size:13px;color:var(--muted)}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
button,.sel,input[type="checkbox"]{cursor:pointer}
button{border:1px solid #243244;background:#0e1a2b;color:var(--text);
  padding:10px 14px;border-radius:12px;font-weight:700;box-shadow:var(--shadow)}
button:hover{border-color:#33508a}
.sel{background:#0e1a2b;border:1px solid #243244;border-radius:12px;
  padding:8px 10px;color:var(--text)}
main{padding:16px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.card{background:var(--card);border:1px solid #1e293b;border-radius:16px;
  overflow:hidden;box-shadow:var(--shadow)}
.thumb{aspect-ratio:1.6/1;display:block;width:100%;background:#0b1220;object-fit:contain}
.meta{padding:12px}
.kvs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
.kv{font-size:12px;color:var(--muted)}
.kv b{color:var(--text)}
.pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);
  border:1px solid #1e293b;padding:4px 8px;border-radius:999px;
  font-size:12px;color:var(--muted)}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.right{margin-left:auto}
.stats{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.stat{background:var(--panel);border:1px solid #1e293b;border-radius:12px;padding:10px 12px}
.stat b{font-size:18px}
.empty{padding:40px;text-align:center;color:var(--muted);
  border:1px dashed #253044;border-radius:16px;background:#0b1220}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
footer{color:var(--muted);font-size:12px;padding:20px 0}
.err{color:#ffb4b4}
.thumbRow{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:16px;margin-top:12px}
.thumbCard{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden}
.thumbHead{padding:10px 12px;border-bottom:1px solid #1e293b;
  display:flex;align-items:center;gap:10px}
.gifRow{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:16px;margin-top:12px}
.gifCard{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden}
.gifHead{padding:10px 12px;border-bottom:1px solid #1e293b;display:flex;gap:10px;align-items:center}
.gif{display:block;width:100%;background:#0b1220;aspect-ratio:1/1;object-fit:contain}
.exportAll{display:flex;gap:10px;align-items:center;margin-left:auto}
.muted{color:var(--muted);font-size:12px}
.mark{display:flex;gap:8px;align-items:center}
.flag{padding:4px 8px;border-radius:10px;border:1px solid #1e293b;background:#13223a}
.flag.on{background:#11351d;border-color:#1d4d2a;color:#b5f7c0}
.group{background:#0e1a2b;border:1px solid #243244;border-radius:10px;
  padding:4px 6px;color:var(--text);font-size:12px}

/* segmented toggles */
.seg{display:inline-flex;border:1px solid #27324a;border-radius:10px;overflow:hidden;background:#0e1a2b}
.seg button{border:0;border-right:1px solid #27324a;background:transparent;
  color:#cbd5e1;padding:6px 10px;font-size:12px}
.seg button:last-child{border-right:0}
.seg button.active{background:#1b2a46;color:#e6eefc}
.seg button:disabled{opacity:.45;cursor:not-allowed}

/* player */
.player{padding:10px 12px;border-top:1px solid #1e293b;background:#0d1526}
.canvasWrap{position:relative;width:100%}
canvas, video.gif{display:block;width:100%;height:auto;background:#000}
.playerBar{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
.slider{flex:1}
.player button.small{padding:6px 10px;border-radius:8px;font-size:12px}
.player label{font-size:12px;color:var(--muted)}
</style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>SOHO Comet Hunter 2.0</h1>
    <div class="sub">Live NASA animations, detections, and Sungrazer‑ready exports from your GitHub repo.</div>
    <div class="controls">
      <button id="refreshBtn">Refresh</button>
      <select id="reportSelect" class="sel"></select>
      <label class="pill"><input type="checkbox" id="c2Filter" /> C2</label>
      <label class="pill"><input type="checkbox" id="c3Filter" /> C3</label>
      <label class="pill"><input type="checkbox" id="aiOnly" /> AI ‘comet’ only</label>
      <label class="pill"><input type="checkbox" id="markedOnly" /> Marked only</label>
      <div class="right pill">Auto‑refresh: <span id="refreshEta">—</span></div>
      <div class="exportAll">
        <button id="exportAllBtn">Export ALL</button>
        <label class="pill"><input type="checkbox" id="exportMarkedOnly" /> Marked only</label>
        <a id="downloadAllTxt" class="pill" href="#" download style="display:none;">TXT</a>
        <a id="downloadAllCsv" class="pill" href="#" download style="display:none;">CSV</a>
        <span id="exportAllHint" class="muted"></span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="status">
    <div class="row">
      <div>Latest report: <b id="reportName">—</b> <span class="sub" id="reportTime"></span></div>
      <div class="right sub">Source: <a id="srcLink" href="#" target="_blank">GitHub</a></div>
    </div>
    <div class="stats" id="stats"></div>
  </section>

  <!-- Live official NASA animations -->
  <section aria-label="Live LASCO animations">
    <div class="gifRow">
      <div class="gifCard">
        <div class="gifHead"><span class="pill">C2 — Live GIF</span>
          <a class="sub" href="https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif" target="_blank">open</a>
          <span class="right sub" id="c2GifTime"></span>
        </div>
        <img id="c2Gif" class="gif" alt="SOHO LASCO C2 live">
      </div>
      <div class="gifCard">
        <div class="gifHead"><span class="pill">C3 — Live GIF</span>
          <a class="sub" href="https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif" target="_blank">open</a>
          <span class="right sub" id="c3GifTime"></span>
        </div>
        <img id="c3Gif" class="gif" alt="SOHO LASCO C3 live">
      </div>
    </div>
  </section>

  <!-- Last frames (optional) -->
  <section style="padding-top:10px;">
    <div class="thumbRow" id="lastFramesRow"></div>
    <div class="empty" id="errors" style="margin-top:12px;display:none;"></div>
  </section>

  <section id="content" style="margin-top:16px;">
    <div class="empty" id="empty">No detections yet.</div>
    <div class="grid" id="grid" hidden></div>
  </section>

  <footer>
    <div>Tip: If an animation exists you’ll see a video player with an Annotated/Clean toggle. Otherwise the canvas player appears with Play/Pause, FPS, path overlay, and one‑loop export (WebM/GIF).</div>
  </footer>
</main>

<script>
/* ==================== CONFIG ==================== */
const REPO   = "NAGOHUSA/ONS_SOHOHUNTER";
const BRANCH = "main";
const FOLDER = "detections";
const RAW    = path => `https://raw.githubusercontent.com/${REPO}/${BRANCH}/${path}`;

/* ==================== ELEMENTS ==================== */
const $ = id => document.getElementById(id);
const el = {
  reportSelect   : $("reportSelect"),
  refreshBtn     : $("refreshBtn"),
  c2Filter       : $("c2Filter"),
  c3Filter       : $("c3Filter"),
  aiOnly         : $("aiOnly"),
  markedOnly     : $("markedOnly"),
  exportAllBtn   : $("exportAllBtn"),
  exportMarked   : $("exportMarkedOnly"),
  downloadTxt    : $("downloadAllTxt"),
  downloadCsv    : $("downloadAllCsv"),
  exportHint     : $("exportAllHint"),
  reportName     : $("reportName"),
  reportTime     : $("reportTime"),
  srcLink        : $("srcLink"),
  stats          : $("stats"),
  grid           : $("grid"),
  empty          : $("empty"),
  errors         : $("errors"),
  lastFramesRow  : $("lastFramesRow"),
  c2Gif          : $("c2Gif"),
  c3Gif          : $("c3Gif"),
  c2GifTime      : $("c2GifTime"),
  c3GifTime      : $("c3GifTime"),
  refreshEta     : $("refreshEta")
};

/* ==================== HELPERS ==================== */
function fmtDate(s) {
  const d = new Date(s);
  return d.toLocaleString(undefined, {dateStyle:'medium', timeStyle:'short'});
}
function pad(n){return n.toString().padStart(2,'0');}

/* ==================== DATA NORMALISATION ==================== */
function normalise(c, idx) {
  const id = `${c.detector || 'unknown'}#${c.track_index ?? idx}`;
  const label = (c.ai_label || 'unknown').toLowerCase();
  const score = c.ai_score ?? 0;
  const pos   = c.positions?.[0] ?? {};
  const dual  = c.dual_channel_match;

  return {
    id, label, score,
    marked      : !!c.marked,                     // NEW
    telescope   : c.telescope?.toUpperCase() ?? '',
    timestamp   : c.timestamp ?? '',
    crop        : c.crop_path,
    animMp4     : c.animation_mp4_path,
    animGif     : c.animation_gif_path,
    thumbnail   : c.thumbnail_path,               // NEW
    pathOverlay : c.path_overlay_path,            // NEW
    dual,
    pos,
    raw: c
  };
}

/* ==================== RENDER CARD ==================== */
function renderCard(item) {
  const anim = item.animMp4 ? `<video src="${RAW(item.animMp4)}" controls loop muted class="thumb"></video>`
            : item.animGif ? `<img src="${RAW(item.animGif)}" class="thumb" alt="anim">`
            : '';

  const kv = (k,v) => v ? `<div class="kv"><b>${k}</b> ${v}</div>` : '';

  const dualHtml = item.dual
    ? `<div class="pill">Dual ${item.dual.with} (±${item.dual.pa_diff_deg.toFixed(1)}°)</div>`
    : '';

  const markBtn = `<button class="small flag ${item.marked?'on':''}" data-id="${item.id}">
                    ${item.marked?'Marked':'Mark'}
                  </button>`;

  return `
    <div class="card" data-id="${item.id}" data-label="${item.label}" data-tel="${item.telescope}" data-marked="${item.marked}">
      <div class="meta">
        <div class="row">
          <div><strong>${item.id}</strong> — ${item.label.toUpperCase()} (${(item.score*100).toFixed(1)}%)</div>
          <div class="right">${markBtn}</div>
        </div>
        <div class="kvs">
          ${kv('Tel', item.telescope)}
          ${kv('Time', fmtDate(item.timestamp))}
          ${kv('X', pos.x?.toFixed(1))}
          ${kv('Y', pos.y?.toFixed(1))}
        </div>
        ${dualHtml}
        ${item.thumbnail ? `<img src="${RAW(item.thumbnail)}" class="thumb" alt="thumb">` : ''}
        ${anim}
      </div>
    </div>`;
}

/* ==================== RENDER GRID ==================== */
let ALL_ITEMS = [];          // all candidates of the current report
let MARKED_IDS = new Set();  // persisted across reports

function renderGrid() {
  const c2 = el.c2Filter.checked;
  const c3 = el.c3Filter.checked;
  const ai = el.aiOnly.checked;
  const marked = el.markedOnly.checked;

  const filtered = ALL_ITEMS.filter(it => {
    if (c2 && it.telescope !== 'C2') return false;
    if (c3 && it.telescope !== 'C3') return false;
    if (ai && it.label !== 'comet') return false;
    if (marked && !MARKED_IDS.has(it.id)) return false;
    return true;
  });

  el.grid.innerHTML = filtered.map(renderCard).join('') || '<div class="empty">No candidates match the filters.</div>';
  el.grid.hidden = filtered.length === 0;
  el.empty.hidden = filtered.length > 0;

  // wire mark buttons
  document.querySelectorAll('.flag').forEach(btn => {
    btn.onclick = () => {
      const id = btn.dataset.id;
      if (MARKED_IDS.has(id)) MARKED_IDS.delete(id);
      else MARKED_IDS.add(id);
      renderGrid();               // refresh UI
      updateExportHint();
    };
  });
}

/* ==================== STATS ==================== */
function renderStats(items) {
  const total = items.length;
  const comets = items.filter(i=>i.label==='comet').length;
  const c2 = items.filter(i=>i.telescope==='C2').length;
  const c3 = items.filter(i=>i.telescope==='C3').length;
  const marked = [...MARKED_IDS].filter(id=>items.some(i=>i.id===id)).length;

  el.stats.innerHTML = `
    <div class="stat"><b>${total}</b> detections</div>
    <div class="stat"><b>${comets}</b> AI comets</div>
    <div class="stat"><b>${c2}</b> C2</div>
    <div class="stat"><b>${c3}</b> C3</div>
    <div class="stat"><b>${marked}</b> marked</div>
  `;
}

/* ==================== LOAD REPORT ==================== */
async function loadReport(file) {
  try {
    el.errors.style.display = 'none';
    el.reportName.textContent = file.replace('.json','').replace('candidates_','');
    el.reportTime.textContent = '';
    el.srcLink.href = `https://github.com/${REPO}/blob/${BRANCH}/${FOLDER}/${file}`;
    el.srcLink.textContent = 'GitHub';

    const resp = await fetch(RAW(`${FOLDER}/${file}`));
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();

    // ---- normalise ----
    ALL_ITEMS = data.map(normalise);

    // ---- timestamps (if any) ----
    if (data[0]?.timestamp) {
      el.reportTime.textContent = fmtDate(data[0].timestamp);
    }

    renderStats(ALL_ITEMS);
    renderGrid();
    updateLiveGifs();
  } catch (e) {
    el.errors.textContent = `Failed to load ${file}: ${e.message}`;
    el.errors.style.display = 'block';
    console.error(e);
  }
}

/* ==================== REFRESH DROPDOWN ==================== */
async function refreshDropdown() {
  try {
    const resp = await fetch(`https://api.github.com/repos/${REPO}/contents/${FOLDER}?ref=${BRANCH}`);
    const files = await resp.json();

    const jsonFiles = files
      .filter(f => /^candidates_\d{8}_\d{6}\.json$/.test(f.name))
      .sort((a,b) => b.name.localeCompare(a.name));

    el.reportSelect.innerHTML = '<option value="">— Select report —</option>';
    jsonFiles.forEach(f => {
      const opt = document.createElement('option');
      opt.value = f.name;
      opt.textContent = f.name.replace('.json','').replace('candidates_','');
      el.reportSelect.appendChild(opt);
    });

    if (jsonFiles.length) {
      el.reportSelect.value = jsonFiles[0].name;
      loadReport(jsonFiles[0].name);
    }
  } catch (e) {
    console.error(e);
  }
}

/* ==================== LIVE GIFS ==================== */
async function updateLiveGifs() {
  const urls = {
    c2: "https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif",
    c3: "https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif"
  };
  for (const [tel, url] of Object.entries(urls)) {
    try {
      const r = await fetch(url, {method:'HEAD'});
      const last = r.headers.get('last-modified');
      const timeEl = $(`${tel}GifTime`);
      const imgEl  = $(`${tel}Gif`);
      if (last) timeEl.textContent = new Date(last).toLocaleTimeString();
      imgEl.src = url + '?t=' + Date.now();   // cache‑bust
    } catch {}
  }
}

/* ==================== EXPORT ALL ==================== */
function buildTxt(items) {
  return items.map(it => [
    it.id,
    it.label,
    (it.score*100).toFixed(1)+'%',
    it.telescope,
    fmtDate(it.timestamp),
    it.pos.x?.toFixed(1) ?? '',
    it.pos.y?.toFixed(1) ?? '',
    it.dual ? `${it.dual.with} (±${it.dual.pa_diff_deg.toFixed(1)}°)` : ''
  ].join('\t')).join('\n');
}
function buildCsv(items) {
  const header = ['ID','Label','Score','Telescope','Time','X','Y','Dual'];
  const rows = items.map(it => [
    it.id,
    it.label,
    (it.score*100).toFixed(1),
    it.telescope,
    fmtDate(it.timestamp),
    it.pos.x?.toFixed(1) ?? '',
    it.pos.y?.toFixed(1) ?? '',
    it.dual ? `${it.dual.with} (±${it.dual.pa_diff_deg.toFixed(1)}°)` : ''
  ]);
  return [header, ...rows].map(r=>r.join(',')).join('\n');
}
function updateExportHint() {
  const cnt = el.exportMarked.checked ? MARKED_IDS.size : ALL_ITEMS.length;
  el.exportHint.textContent = `${cnt} item${cnt===1?'':'s'} ready`;
}
el.exportAllBtn.onclick = () => {
  const useMarked = el.exportMarked.checked;
  const items = useMarked
    ? ALL_ITEMS.filter(i=>MARKED_IDS.has(i.id))
    : ALL_ITEMS;

  const txt = buildTxt(items);
  const csv = buildCsv(items);
  const blobTxt = new Blob([txt],{type:'text/plain'});
  const blobCsv = new Blob([csv],{type:'text/csv'});

  el.downloadTxt.href = URL.createObjectURL(blobTxt);
  el.downloadTxt.download = `soho_export_${useMarked?'marked':'all'}_${Date.now()}.txt`;
  el.downloadTxt.style.display = 'inline-flex';

  el.downloadCsv.href = URL.createObjectURL(blobCsv);
  el.downloadCsv.download = `soho_export_${useMarked?'marked':'all'}_${Date.now()}.csv`;
  el.downloadCsv.style.display = 'inline-flex';

  updateExportHint();
};

/* ==================== FILTERS ==================== */
[el.c2Filter, el.c3Filter, el.aiOnly, el.markedOnly, el.exportMarked].forEach(cb=>{
  cb.onchange = renderGrid;
});

/* ==================== AUTO‑REFRESH ==================== */
let refreshTimer;
function startAutoRefresh() {
  clearInterval(refreshTimer);
  const next = 5*60*1000;                // 5 min
  const end = Date.now() + next;
  refreshTimer = setInterval(()=>{
    const left = Math.max(0, Math.round((end - Date.now())/1000));
    const m = Math.floor(left/60), s = left%60;
    el.refreshEta.textContent = `${m}:${pad(s)}`;
    if (left===0) refreshDropdown();
  },1000);
}
el.refreshBtn.onclick = ()=>{ refreshDropdown(); startAutoRefresh(); };

/* ==================== INIT ==================== */
refreshDropdown();
updateLiveGifs();
startAutoRefresh();
setInterval(updateLiveGifs, 2*60*1000);   // keep GIF timestamps fresh
</script>
</body>
</html>
