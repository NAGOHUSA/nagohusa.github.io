<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SOHO Comet Hunter — Live Results</title>

<!-- GIF encoder for optional GIF exports (canvas mode fallback) -->
<script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.js"></script>

<style>
:root{
  --bg:#0b1220;--panel:#0f1b30;--muted:#94a3b8;--text:#e6eefc;--accent:#60a5fa;
  --chip:#1e293b;--card:#0d1526;--shadow:0 8px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);
  font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:10;
  background:linear-gradient(180deg,var(--bg),#0b1220f0 80%,#0b122000);
  backdrop-filter:blur(6px);border-bottom:1px solid #1e293b}
.wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
h1{margin:6px 0 0;font-size:20px;font-weight:800;letter-spacing:.3px}
.sub{font-size:13px;color:var(--muted)}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
button,.sel,input[type="checkbox"]{cursor:pointer}
button{border:1px solid #243244;background:#0e1a2b;color:var(--text);
  padding:10px 14px;border-radius:12px;font-weight:700;box-shadow:var(--shadow)}
button:hover{border-color:#33508a}
.sel{background:#0e1a2b;border:1px solid #243244;border-radius:12px;
  padding:8px 10px;color:var(--text)}
main{padding:16px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.card{background:var(--card);border:1px solid #1e293b;border-radius:16px;
  overflow:hidden;box-shadow:var(--shadow)}
.thumb{aspect-ratio:1.6/1;display:block;width:100%;background:#0b1220;object-fit:contain}
.meta{padding:12px}
.kvs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
.kv{font-size:12px;color:var(--muted)}
.kv b{color:var(--text)}
.pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);
  border:1px solid #1e293b;padding:4px 8px;border-radius:999px;
  font-size:12px;color:var(--muted)}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.right{margin-left:auto}
.stats{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.stat{background:var(--panel);border:1px solid #1e293b;border-radius:12px;padding:10px 12px}
.stat b{font-size:18px}
.empty{padding:40px;text-align:center;color:var(--muted);
  border:1px dashed #253044;border-radius:16px;background:#0b1220}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
footer{color:var(--muted);font-size:12px;padding:20px 0}
.err{color:#ffb4b4}
.thumbRow{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:16px;margin-top:12px}
.thumbCard{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden}
.thumbHead{padding:10px 12px;border-bottom:1px solid #1e293b;
  display:flex;align-items:center;gap:10px}
.gifRow{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:16px;margin-top:12px}
.gifCard{background:var(--card);border:1px solid #1e293b;border-radius:16px;overflow:hidden}
.gifHead{padding:10px 12px;border-bottom:1px solid #1e293b;display:flex;gap:10px;align-items:center}
.gif{display:block;width:100%;background:#0b1220;aspect-ratio:1/1;object-fit:contain}
.exportAll{display:flex;gap:10px;align-items:center;margin-left:auto}
.muted{color:var(--muted);font-size:12px}
.mark{display:flex;gap:8px;align-items:center}
.flag{padding:4px 8px;border-radius:10px;border:1px solid #1e293b;background:#13223a}
.flag.on{background:#11351d;border-color:#1d4d2a;color:#b5f7c0}
.group{background:#0e1a2b;border:1px solid #243244;border-radius:10px;
  padding:4px 6px;color:var(--text);font-size:12px}

/* segmented toggles */
.seg{display:inline-flex;border:1px solid #27324a;border-radius:10px;overflow:hidden;background:#0e1a2b}
.seg button{border:0;border-right:1px solid #27324a;background:transparent;
  color:#cbd5e1;padding:6px 10px;font-size:12px}
.seg button:last-child{border-right:0}
.seg button.active{background:#1b2a46;color:#e6eefc}
.seg button:disabled{opacity:.45;cursor:not-allowed}

/* player */
.player{padding:10px 12px;border-top:1px solid #1e293b;background:#0d1526}
.canvasWrap{position:relative;width:100%}
canvas, video.gif{display:block;width:100%;height:auto;background:#000}
.playerBar{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
.slider{flex:1}
.player button.small{padding:6px 10px;border-radius:8px;font-size:12px}
.player label{font-size:12px;color:var(--muted)}
</style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>SOHO Comet Hunter</h1>
    <div class="sub">Live NASA animations, detections, and Sungrazer-ready exports from your GitHub repo.</div>
    <div class="controls">
      <button id="refreshBtn">⟳ Refresh</button>
      <select id="reportSelect" class="sel"></select>
      <label class="pill"><input type="checkbox" id="c2Filter" /> C2</label>
      <label class="pill"><input type="checkbox" id="c3Filter" /> C3</label>
      <label class="pill"><input type="checkbox" id="aiOnly" /> AI ‘comet’ only</label>
      <label class="pill"><input type="checkbox" id="markedOnly" /> Marked only</label>
      <div class="right pill">Auto-refresh: <span id="refreshEta">—</span></div>
      <div class="exportAll">
        <button id="exportAllBtn">Export ALL</button>
        <label class="pill"><input type="checkbox" id="exportMarkedOnly" /> Marked only</label>
        <a id="downloadAllTxt" class="pill" href="#" download style="display:none;">TXT</a>
        <a id="downloadAllCsv" class="pill" href="#" download style="display:none;">CSV</a>
        <span id="exportAllHint" class="muted"></span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="status">
    <div class="row">
      <div>Latest report: <b id="reportName">—</b> <span class="sub" id="reportTime"></span></div>
      <div class="right sub">Source: <a id="srcLink" href="#" target="_blank">GitHub</a></div>
    </div>
    <div class="stats" id="stats"></div>
  </section>

  <!-- Live official NASA animations -->
  <section aria-label="Live LASCO animations">
    <div class="gifRow">
      <div class="gifCard">
        <div class="gifHead"><span class="pill">C2 — Live GIF</span>
          <a class="sub" href="https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif" target="_blank">open</a>
          <span class="right sub" id="c2GifTime"></span>
        </div>
        <img id="c2Gif" class="gif" alt="SOHO LASCO C2 live">
      </div>
      <div class="gifCard">
        <div class="gifHead"><span class="pill">C3 — Live GIF</span>
          <a class="sub" href="https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif" target="_blank">open</a>
          <span class="right sub" id="c3GifTime"></span>
        </div>
        <img id="c3Gif" class="gif" alt="SOHO LASCO C3 live">
      </div>
    </div>
  </section>

  <!-- Thumbnails -->
  <section style="padding-top:10px;">
    <div class="thumbRow" id="lastFramesRow"></div>
    <div class="empty" id="errors" style="margin-top:12px;display:none;"></div>
  </section>

  <section id="content" style="margin-top:16px;">
    <div class="empty" id="empty">No detections yet.</div>
    <div class="grid" id="grid" hidden></div>
  </section>

  <footer>
    <div>Tip: If animations exist you’ll see a video player with an Annotated/Clean toggle. Otherwise, the canvas player appears with Play/Pause, FPS, path overlay, and one-loop export (WebM/GIF).</div>
  </footer>
</main>

<script>
/*** CONFIG ***/
const OWNER="NAGOHUSA", REPO="ONS_SOHOHUNTER", BRANCH="main";
const FOLDER="detections";
/*** END CONFIG ***/

// helpers for GitHub raw and blob links
const rawURL = p=>`https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${p.replace(/^\.?\/*/,'')}`;
const ghBlobURL = p=>`https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/${p.replace(/^\.?\/*/,'')}`;

// Short refs 
const el = q => document.querySelector(q);
const grid = el("#grid"), empty = el("#empty");
const c2Gif = el("#c2Gif"), c3Gif = el("#c3Gif");
const c2GifTime = el("#c2GifTime"), c3GifTime = el("#c3GifTime");

/* SOHO frame URL (unused here, but handy to keep) */
function sohoUrlFromFrame(det, frameName){
 const m = /^(\d{8})_(\d{4})(?:\d{0,2})?_(c[23])_\d+\.jpe?g$/i.exec(frameName||"");
 if(!m) return null;
 const [_,d,,cam]=m; const year=d.slice(0,4);
 return `https://soho.nascom.nasa.gov/data/REPROCESSING/Completed/${year}/${cam.toLowerCase()}/${d}/${frameName}`;
}

/******** LOAD JSON + BUILD VIEW ********/
async function loadLatest() {
  try {
    const res = await fetch(rawURL(`${FOLDER}/latest_status.json?${Date.now()}`));
    if (!res.ok) throw new Error(`status ${res.status}`);
    const data = await res.json();
    renderAll(data);
  } catch(e){
    console.error(e);
    el("#errors").style.display="block";
    el("#errors").textContent=`Error loading latest_status.json – ${e}`;
  }
}

function renderAll(data){
  el("#reportName").textContent=data.name||"latest_status.json";
  el("#reportTime").textContent=data.generated_at||"";
  el("#srcLink").href=ghBlobURL(`${FOLDER}/latest_status.json`);
  renderStats(data);
  renderThumbs(data);
  renderGrid(data.candidates||[]);
}

function renderStats(data){
  const s=el("#stats"); s.innerHTML="";
  const mk=(t,v)=>`<div class="stat"><div>${t}</div><b>${v}</b></div>`;
  s.innerHTML += mk("Candidates",data.candidates?.length||0);
  s.innerHTML += mk("C2 frames",data.c2_frames||"—");
  s.innerHTML += mk("C3 frames",data.c3_frames||"—");
}

function renderThumbs(data){
  const r=el("#lastFramesRow"); r.innerHTML="";
  ["C2","C3"].forEach(det=>{
    const u=rawURL(`${FOLDER}/lastthumb_${det}.png?${Date.now()}`);
    r.innerHTML+=`
      <div class="thumbCard">
        <div class="thumbHead">
          <span class="pill">${det} last frame</span>
          <a class="sub" href="${ghBlobURL(`${FOLDER}/lastthumb_${det}.png`)}" target="_blank">view</a>
        </div>
        <img src="${u}" class="thumb" loading="lazy" alt="${det} last frame">
      </div>`;
  });
}

/************ GRID ************/
function renderGrid(items){
  const g=grid;
  if(!items.length){ g.hidden=true; empty.hidden=false; return; }
  g.hidden=false; empty.hidden=true;
  g.innerHTML=items.map((h,i)=>{
    const crop=rawURL(h.crop_path||"");
    const orig=h.original_mid_path?rawURL(h.original_mid_path):"";
    const ann =h.annotated_mid_path?rawURL(h.annotated_mid_path):"";
    const txt =rawURL(`detections/reports/${h.detector}_track${h.track_index}_sungrazer.txt`);
    const csv =rawURL(`detections/reports/${h.detector}_track${h.track_index}_sungrazer.csv`);
    const det =h.detector||"";
    const idx =h.track_index||i;
    const pa  =h.pa_deg?.toFixed?.(1)||"—";
    const spd =h.speed_px_min?.toFixed?.(1)||"—";

    // detect if backend provided animations (annotated + clean variants)
    const hasAnnVid = !!(h.animation_mp4_path || h.animation_gif_path);
    const hasCleanVid = !!(h.animation_mp4_clean_path || h.animation_gif_clean_path);
    const hasAnyVid = hasAnnVid || hasCleanVid;

    const initialVidSrc =
      h.animation_mp4_path ? rawURL(h.animation_mp4_path) :
      (h.animation_gif_path ? rawURL(h.animation_gif_path) :
      (h.animation_mp4_clean_path ? rawURL(h.animation_mp4_clean_path) :
      (h.animation_gif_clean_path ? rawURL(h.animation_gif_clean_path) : "")));

    return `
    <div class="card" data-det="${det}">
      <div class="meta">
        <div class="row"><span class="pill">${det} #${idx}</span><span class="right sub">${h.series_mid_frame||""}</span></div>
        <div class="kvs">
          <div class="kv">PA <b>${pa}°</b></div>
          <div class="kv">Speed <b>${spd}</b></div>
        </div>
        <div class="seg" style="margin-top:8px">
          <button class="active" data-view="crop">Crop</button>
          <button data-view="orig"${!orig?" disabled":""}>Original</button>
          <button data-view="ann"${!ann?" disabled":""}>Annotated</button>
        </div>
      </div>

      <div class="canvasWrap">
        ${
          hasAnyVid
          ? `
            <div class="gifHead" style="padding:10px 12px;border-bottom:1px solid #1e293b;display:flex;gap:10px;align-items:center">
              <div class="mark"><span class="muted">Animation</span></div>
              <div class="seg" style="margin-left:auto">
                <button class="active" data-anim="annotated" ${hasAnnVid? "" : "disabled"}>Annotated</button>
                <button data-anim="clean" ${hasCleanVid? "" : "disabled"}>Clean</button>
              </div>
            </div>
            <video class="gif" controls loop muted playsinline src="${initialVidSrc}"></video>
          `
          : `<canvas id="can${i}"></canvas>`
        }
      </div>

      <div class="player" ${hasAnyVid ? 'style="display:none"' : ""}>
        <div class="playerBar">
          <button class="small play">▶︎</button>
          <button class="small pause">❚❚</button>
          <label>FPS <input type="range" min="1" max="20" value="5" class="slider fps"></label>
          <label><input type="checkbox" class="showPath"> Show path</label>
          <button class="small webm">Save 1 loop (WebM)</button>
          <button class="small gif">Save 1 loop (GIF)</button>
        </div>
      </div>

      <div class="meta">
        <div class="row" style="margin-top:6px">
          <button class="sgBtn small">Copy for Sungrazer</button>
          <a class="pill" href="${txt}" target="_blank">TXT</a>
          <a class="pill" href="${csv}" target="_blank">CSV</a>
        </div>
      </div>
    </div>`}).join("");
  g.querySelectorAll(".card").forEach((card,i)=>setupCard(card,items[i]));
}

/******** PLAYER + ANIMATION ********/
function setupCard(card,h){
  // If we have a <video>, wire the Annotated/Clean toggle and skip canvas init.
  const vid = card.querySelector("video.gif");
  if (vid) {
    const toURL = p => p ? rawURL(p) : "";
    const annBtn = card.querySelector('button[data-anim="annotated"]');
    const cleanBtn = card.querySelector('button[data-anim="clean"]');

    if (annBtn) annBtn.onclick = () => {
      if (h.animation_mp4_path) vid.src = toURL(h.animation_mp4_path);
      else if (h.animation_gif_path) vid.src = toURL(h.animation_gif_path);
      annBtn.classList.add('active');
      if (cleanBtn) cleanBtn.classList.remove('active');
    };
    if (cleanBtn) cleanBtn.onclick = () => {
      if (h.animation_mp4_clean_path) vid.src = toURL(h.animation_mp4_clean_path);
      else if (h.animation_gif_clean_path) vid.src = toURL(h.animation_gif_clean_path);
      cleanBtn.classList.add('active');
      if (annBtn) annBtn.classList.remove('active');
    };

    // Sungrazer button still copies the TXT/csv links to clipboard for convenience
    const sgBtn = card.querySelector(".sgBtn");
    if (sgBtn) sgBtn.onclick = () => copySungrazerBlock(h);

    return; // Do not initialize the canvas player for this card.
  }

  // -------- Canvas player fallback (no prebuilt animations) --------
  const can=card.querySelector("canvas");
  const ctx=can.getContext("2d");
  const imgs=[]; let idx=0,playing=false,fps=5,showPath=false,timer=null;

  function loadAll(){
    const base=rawURL(h.crop_path||"");
    imgs.push(base);
    if(h.series_files){ h.series_files.forEach(f=>imgs.push(rawURL(f))); }
  }
  loadAll();

  const imgEls=imgs.map(u=>{
    const im=new Image(); im.crossOrigin="anonymous"; im.src=u; return im;
  });

  imgEls[0].onload=()=>{can.width=imgEls[0].width;can.height=imgEls[0].height;draw();};

  function draw(){
    if(!imgEls[idx])return;
    ctx.drawImage(imgEls[idx],0,0,can.width,can.height);
    if(showPath&&h.positions){
      ctx.strokeStyle="lime";ctx.beginPath();
      h.positions.forEach((p,j)=>{if(j)ctx.lineTo(p.x,p.y);else ctx.moveTo(p.x,p.y)});
      ctx.stroke();
    }
  }
  function next(){idx=(idx+1)%imgEls.length;draw();}
  function play(){if(playing)return;playing=true;timer=setInterval(next,1000/fps);}
  function stop(){playing=false;clearInterval(timer);}

  card.querySelector(".play").onclick=()=>play();
  card.querySelector(".pause").onclick=()=>stop();
  const fpsEl=card.querySelector(".fps");
  if (fpsEl) fpsEl.oninput=e=>{fps=e.target.value; if(playing){stop();play();}};
  const pathEl=card.querySelector(".showPath");
  if (pathEl) pathEl.onchange=e=>{showPath=e.target.checked;draw();};

  // save loop (WebM)
  const webmBtn = card.querySelector(".webm");
  if (webmBtn) webmBtn.onclick=()=>{
    try{
      const stream=can.captureStream();
      const rec=new MediaRecorder(stream,{mimeType:"video/webm"});
      const chunks=[]; rec.ondataavailable=e=>chunks.push(e.data);
      rec.onstop=()=>{const blob=new Blob(chunks,{type:"video/webm"});
        const a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download=`${h.detector}_track${h.track_index}.webm`;
        a.click();
      };
      rec.start(); let c=0;
      const recTimer=setInterval(()=>{next();if(++c>=imgs.length){clearInterval(recTimer);rec.stop();}},1000/fps);
    }catch(e){alert("WebM export not supported in this browser.");}
  };

  // save loop (GIF)
  const gifBtn = card.querySelector(".gif");
  if (gifBtn) gifBtn.onclick=()=>{
    try{
      const gif=new GIF({workers:2,quality:10,width:can.width,height:can.height});
      imgEls.forEach(im=>gif.addFrame(im,{delay:1000/fps}));
      gif.on('finished',b=>{
        const a=document.createElement("a");
        a.href=URL.createObjectURL(b);
        a.download=`${h.detector}_track${h.track_index}.gif`; a.click();
      });
      gif.render();
    }catch(e){alert("GIF export failed (CORS). Use WebM instead.");}
  };

  // segmented image toggle (crop/original/annotated)
  card.querySelectorAll(".seg button").forEach(btn=>{
    btn.onclick=()=>{
      card.querySelectorAll(".seg button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const mode=btn.dataset.view;
      let src=h.crop_path;
      if(mode==="orig"&&h.original_mid_path)src=h.original_mid_path;
      if(mode==="ann"&&h.annotated_mid_path)src=h.annotated_mid_path;
      const im=new Image();im.crossOrigin="anonymous";im.src=rawURL(src);
      im.onload=()=>{can.width=im.width;can.height=im.height;ctx.drawImage(im,0,0,im.width,im.height);}
    };
  });

  const sgBtn = card.querySelector(".sgBtn");
  if (sgBtn) sgBtn.onclick = () => copySungrazerBlock(h);
}

/******** Sungrazer helper ********/
async function copySungrazerBlock(h){
  const txtUrl = rawURL(`detections/reports/${h.detector}_track${h.track_index}_sungrazer.txt`);
  try{
    const t = await (await fetch(txtUrl)).text();
    await navigator.clipboard.writeText(t);
    alert("Sungrazer TXT copied to clipboard.");
  }catch(e){ alert("Could not copy. Open TXT link instead."); }
}

/*********** REFRESH + LIVE GIFS ***********/
async function loadLiveGifs(){
  c2Gif.src=`https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif?${Date.now()}`;
  c3Gif.src=`https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif?${Date.now()}`;
  const d=new Date().toISOString().split("T")[1].slice(0,5);
  c2GifTime.textContent=`${d} UTC`;
  c3GifTime.textContent=`${d} UTC`;
}
loadLiveGifs(); loadLatest();

let eta=60;
setInterval(()=>{eta--;el("#refreshEta").textContent=`${eta}s`;
  if(eta<=0){eta=60;loadLatest();loadLiveGifs();}
},1000);

el("#refreshBtn").onclick=()=>{eta=60;loadLatest();loadLiveGifs();};
</script>
</body>
</html>
